<wdkModel>
    <querySet name="GeneAttributes" queryType="attribute" isCacheable="false">

        <sqlQuery name="GeneAlias" doNotTest="true">
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="old_source_id"/>
            <column name="old_project_id"/>
            <sql>
              <![CDATA[
                SELECT a.gene AS source_id, 
                       ga.project_id,
                       a.ID as old_source_id, ga.project_id AS old_project_id
                FROM ApidbTuning.GeneId a, apidbtuning.geneattributes ga
                WHERE a.unique_mapping = 1   
                and a.gene = ga.source_id
              ]]>
            </sql>
        </sqlQuery>


        <sqlQuery name="Bfmv">
            <column name="project_id" ignoreCase="true"/>
            <column name="lc_project_id" ignoreCase="false"/>
            <column name="project"  ignoreCase="true"/>
            <column name="source_id" ignoreCase="true"/>

            <!-- GENE specific -->

            <column name="start_min"/>
            <column name="end_max"/>
            <column name="start_min_text" sortingColumn="start_min"/>
            <column name="end_max_text" sortingColumn="end_max"/>
            <column name="strand_plus_minus"/>
            <column name="strain" ignoreCase="true"/>
            <column name="product" ignoreCase="true"/>
            <column name="name" ignoreCase="true"/>
            <column name="gene_type" ignoreCase="true"/>
            <column name="exon_count"/>
<!-- TODO            <column name="representative_transcript" includeProjects="ToxoDB,EuPathDB"/> -->
            <column name="is_deprecated"/>
            <column name="context_start"/>
            <column name="context_end"/>
            <column name="zoom_context_start"/>
            <column name="zoom_context_end"/>
            <column name="tight_zoom_context_start"/>
            <column name="tight_zoom_context_end"/>
            <column name="orthomcl_name"/>
            <column name="ortholog_number"/>
            <column name="paralog_number"/>
            <column name="transcript_count"/>
            <column name="representative_transcript"/>
            <column name="orthomcl_link"/>
            <column name="cyc_gene_id" sortingColumn="source_id"/>
            <column name="cyc_db" sortingColumn="organism_full"
                    excludeProjects="AmoebaDB,MicrosporidiaDB,FungiDB,HostDB,UniDB,InitDB,PiroplasmaDB"/>
            <column name="total_hts_snps"/>
            <column name="hts_nonsynonymous_snps"/>
            <column name="hts_synonymous_snps"/>
            <column name="hts_stop_codon_snps"/>
            <column name="hts_noncoding_snps"/>
            <column name="hts_nonsyn_syn_ratio"/>
            <column name="uniprot_id"/>
            <column name="uniprot_id_internal"/>
            <column name="entrez_id"/>
            <column name="is_pseudo"/>
            <column name="pseudo_string"/>
            <column name="sequence_id" ignoreCase="true"/>
            <column name="organism_full"  sortingColumn="organism_full"/>
            <column name="organism_text"  sortingColumn="organism_full"/><!-- CHECK-->
            <column name="genus_species"  sortingColumn="organism_full"/>
            <column name="ncbi_tax_id"/>
            <column name="so_id"/>
            <column name="so_term_name"/>
            <column name="so_term_definition"/>
            <column name="so_version"/>
            <column name="anticodon"/>
            <column name="external_db_name"/>
            <column name="external_db_version"/>
            <column name="chromosome" sortingColumn="chromosome_order_num"/>
            <column name="chromosome_order_num"/>
            <column name="previous_ids" excludeProjects="EuPathDB"/>
            <column name="user_comment_link_url" ignoreCase="false"/>
            <column name="show_strains"/>

            <sqlParamValue name="cyc_db">
                <![CDATA[
                   'DONT-CARE'
                ]]>
            </sqlParamValue>

            <sql>
              <![CDATA[
            SELECT bfmv.project_id
                   , lower(bfmv.project_id) as lc_project_id
                   , bfmv.project_id as project
                   , bfmv.source_id
                   , start_min
                   , end_max
                   , trim(to_char(bfmv.start_min,'999,999,999')) as start_min_text
                   , trim(to_char(bfmv.end_max,'999,999,999')) as end_max_text
                   , bfmv.strand_plus_minus
                   , bfmv.product
                   , bfmv.name
                   , gene_type
                   , bfmv.exon_count
                   , bfmv.transcript_count
                   , bfmv.representative_transcript
                   --TODO  , representative_transcript
                   , DECODE(bfmv.is_deprecated, 0, 'No', 1, 'Yes') AS is_deprecated
                   , bfmv.context_start
                   , bfmv.context_end
                   , bfmv.zoom_context_start
                   , bfmv.zoom_context_end
                   , bfmv.start_min - greatest(200, round((end_max - start_min) / 2)) as tight_zoom_context_start
                   , bfmv.end_max + greatest(200, round((end_max - start_min) / 2)) as tight_zoom_context_end
                   , ortholog_number
                   , paralog_number
                   , bfmv.orthomcl_name as orthomcl_name
                   , CASE WHEN (bfmv.orthomcl_name LIKE 'OG5%' AND bfmv.orthomcl_name NOT LIKE '%|%')
                        THEN '<a href="http://orthomcl.org/cgi-bin/OrthoMclWeb.cgi?rm=sequenceList&groupac=' ||
                        orthomcl_name || '">' || orthomcl_name || '</a>'
                        ELSE orthomcl_name END AS orthomcl_link
                   , UPPER(bfmv.source_id) AS cyc_gene_id
                   , &&cyc_db&& AS cyc_db
                   , bfmv.total_hts_snps
                   , bfmv.hts_nonsynonymous_snps
                   , bfmv.hts_synonymous_snps
                   , bfmv.hts_noncoding_snps
                   , bfmv.hts_stop_codon_snps
                   , bfmv.hts_nonsyn_syn_ratio
                   , uniprot_id
                   , uniprot_id_internal
                   , entrez_id
                   , decode(is_pseudo,0,'No',1,'Yes') as is_pseudo
                   , decode(is_pseudo,0,'gene',1,'pseudogene') as pseudo_string
                   , CASE WHEN bfmv.previous_ids is not null THEN 'Previous IDs: '||bfmv.previous_ids||'<br>' ELSE '' END as previous_ids
                   , bfmv.sequence_id
                   , bfmv.organism as organism_full
                   , genus_species
                   , strain
                   , bfmv.ncbi_tax_id
                   , bfmv.so_id
                   , bfmv.so_term_name
                   , bfmv.so_term_definition
                   , bfmv.so_version
                   , bfmv.anticodon
                   , bfmv.external_db_name
                   , bfmv.external_db_version
                   , SUBSTR(bfmv.organism, 1, 1) || '. ' ||
                        SUBSTR(bfmv.organism, INSTR(bfmv.organism, ' ', 1, 1) +1) as organism_text
                   , CASE WHEN chromosome_order_num is not null THEN to_char(chromosome)
                        WHEN sequence_type in ('apicoplast_chromosome','mitochondrial_chromosome') THEN sequence_type
                        ELSE 'Not Assigned'
                   END as chromosome
                   , chromosome_order_num
                   , '@WEBAPP_BASE_URL@/user-comments/add?stableId='||bfmv.source_id
                   ||'&commentTargetId=gene'
                   ||'&externalDbName='||bfmv.external_db_name
                   ||'&externalDbVersion='||bfmv.external_db_version
                   ||'&organism='||genus_species
                   ||'&locations='||bfmv.start_min||'-'||bfmv.end_max
                   ||'&contig='||bfmv.sequence_id
                   ||'&strand='||bfmv.strand_plus_minus
                   as user_comment_link_url
                   , CASE WHEN (bfmv.strain_count > 1) THEN 'Yes' ELSE 'No' END AS show_strains
            from ApidbTuning.GeneAttributes bfmv
              ]]>
            </sql>
        </sqlQuery>


      </querySet>
    </wdkModel>
