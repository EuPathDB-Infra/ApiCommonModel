<wdkModel>

  <querySet name="MetricsId" queryType="id" isCacheable="true">


    <!-- ************************************************************ -->
    <!--  Organism-related page views  stats   -->
    <!--    project_id | organismName |  recordPageCount -->
    <!--      (only for organism related record types:  gene, genomic sequence, SNP, and dataset)   -->
    <!-- ************************************************************ -->

    <sqlQuery name="OrgPageViewMetrics" doNotTest="true" >

      <paramRef ref="MetricsParams.projectIdSelect"/>

      <column name="source_id"/>
      <column name="project_id"/>
      <column name="organism"/>
      <column name="count"/>
      <column name="start_date"/>
      <column name="end_date"/>

      <sql>
        <![CDATA[
          SELECT to_char(rownum) as source_id, 
                 CASE when project in ('EuPathDB') then 'VEuPathDB'
                   else project
                   end as project_id,
                 organism, count, substr(start_date,1,10) as start_date, substr(end_date,1,10) as end_date
          FROM (
            SELECT project_id as project, organism, count, start_date, end_date
            FROM sfischer.ORGANISMVIEWSTATS@USER_DBLINK@
            WHERE project_id in ( $$projectIdSelect$$ )
          )
          ORDER BY count desc,organism asc,project_id asc
        ]]>
      </sql>
    </sqlQuery>


    <!-- ************************************************************ -->
    <!--  Organism param stats   -->
    <!--    OrgParamCountMetrics:    projectId |  organismValueCount |  stepCount  -->
    <!--    OrgParamNameMetrics:    projectId |  organismName |  stepCount  -->
    <!-- ************************************************************ -->

    <sqlQuery name="OrgParamCountMetrics" doNotTest="true" >

      <paramRef ref="MetricsParams.projectIdSelect"/>

      <column name="source_id"/>
      <column name="project_id"/>
      <column name="number_of_organisms"/>
      <column name="steps_count"/>
      <column name="start_date"/>
      <column name="end_date"/>

      <sql>
        <![CDATA[
          SELECT to_char(rownum) as source_id, 
                 CASE when project in ('EuPathDB') then 'VEuPathDB'
                   else project
                   end as project_id,
                 number_of_organisms, steps_count, start_date, end_date
          FROM (
            SELECT project_id as project, number_of_organisms, steps_count, start_date, end_date
            FROM sfischer.ORGANISMSPERSTEP@USER_DBLINK@
            WHERE project_id in ( $$projectIdSelect$$ )
          )
          ORDER BY number_of_organisms desc,steps_count desc,project_id asc
        ]]>
      </sql>
    </sqlQuery>


    <sqlQuery name="OrgParamNameMetrics" doNotTest="true" >

      <paramRef ref="MetricsParams.projectIdSelect"/>

      <column name="source_id"/>
      <column name="project_id"/>
      <column name="organism"/>
      <column name="steps_count"/>
      <column name="start_date"/>
      <column name="end_date"/>

      <sql>
        <![CDATA[
          SELECT to_char(rownum) as source_id, 
                 CASE when project in ('EuPathDB') then 'VEuPathDB'
                   else project
                   end as project_id,
                 organism, steps_count, start_date, end_date
          FROM (
            SELECT project_id as project, organism, steps_count, start_date, end_date
            FROM sfischer.STEPSPERORGANISM@USER_DBLINK@
            WHERE project_id in ( $$projectIdSelect$$ )
          )
          ORDER BY steps_count desc,organism asc,project_id asc
        ]]>
      </sql>
    </sqlQuery>


    <!-- ************************************************************ -->
    <!--  Gene Page Tables   -->
    <!--   projectId   |  wdkTableName |  requestCount   -->
    <!-- ************************************************************ -->

    <sqlQuery name="GenePageTableMetrics" doNotTest="true" >

<!--
      <paramRef ref="MetricsParams.projectIdSelect"/>
-->
      <column name="source_id"/>
      <column name="project_id"/>
      <column name="record_class"/>
      <column name="table_name"/>
      <column name="count"/>
      <column name="start_date"/>
      <column name="end_date"/>

      <sql>
        <![CDATA[
          SELECT to_char(rownum) as source_id, 
                 CASE when project in ('EuPathDB') then 'VEuPathDB'
                   else project
                   end as project_id,
                 record_class, table_name, count, start_date, end_date
          FROM (
            SELECT '(unknown)' as project,RECORD_CLASS_URL_SEGMENT as record_class,table_name,count,start_date,end_date
            FROM sfischer.GENEPAGETABLESTATS@USER_DBLINK@
            --WHERE project_id in ( $$projectIdSelect$$ )
          )
          ORDER BY count desc,record_class asc,table_name asc,project_id asc
        ]]>
      </sql>
    </sqlQuery>


    <!-- ************************************************************ -->
    <!--  Tools   -->
    <!--    projectId | toolName | requestCount  -->
    <!-- ************************************************************ -->

    <sqlQuery name="ToolMetrics" doNotTest="true" >

      <paramRef ref="MetricsParams.projectIdSelect"/>

      <column name="source_id"/>
      <column name="project_id"/>
      <column name="tool"/>
      <column name="count"/>
      <column name="mozilla_count"/>
      <column name="start_date"/>
      <column name="end_date"/>

      <sql>
        <![CDATA[
          SELECT to_char(rownum) as source_id,
                 CASE when project in ('EuPathDB') then 'VEuPathDB'
                   else project
                   end as project_id,
                 tool,count,mozilla_count,start_date,end_date
          FROM (
            SELECT project_id as project,tool,count,mozilla_count,start_date,end_date
            FROM sfischer.TOOLSSTATS@USER_DBLINK@
            WHERE project_id in ( $$projectIdSelect$$ )
          )
          ORDER BY count desc,tool asc,project_id asc
        ]]>
      </sql>
    </sqlQuery>



    <!-- ************************************************************ -->
    <!--  Searches   -->
    <!--    projectId | searchName | stepCount  --> 
    <!-- ************************************************************ -->

    <sqlQuery name="SearchMetrics" doNotTest="true" >

      <paramRef ref="MetricsParams.projectIdSelect"/>
      <paramRef ref="MetricsParams.step_count_max"/>
      <paramRef ref="MetricsParams.step_count_min"/>

      <column name="source_id"/>
      <column name="project_id"/>
      <column name="search_name"/>
      <column name="steps_count"/>
      <column name="start_date"/>
      <column name="end_date"/>

      <sql>
        <![CDATA[
          SELECT to_char(rownum) as source_id, 
                 CASE when project in ('EuPathDB') then 'VEuPathDB'
                   else project
                   end as project_id,
                 search_name, steps_count, start_date, end_date
          FROM (
            SELECT project_id as project,search_name, steps_count, start_date, end_date
            FROM sfischer.SEARCHESSTATS@USER_DBLINK@
            WHERE project_id in ( $$projectIdSelect$$ )
              AND steps_count  >= $$step_count_min$$ 
              AND steps_count <= $$step_count_max$$
          )
          ORDER BY steps_count desc,search_name asc,project_id asc
        ]]>
      </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
