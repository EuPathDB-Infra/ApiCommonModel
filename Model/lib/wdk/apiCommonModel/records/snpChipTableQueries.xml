<wdkModel>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Legacy SNP / SNP Chip (PlasmoDB) table query -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <querySet name="SnpChipTables" queryType="table" isCacheable="false" includeProjects="PlasmoDB,EuPathDB">

      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">Pf_01_000539044_barcode</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Strains for sequencing SNPs -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="Strains" includeProjects="PlasmoDB" 
              isCacheable="false">
            <column name="source_id" />
            <column name="project_id" />
            <column name="strain"/>
            <column name="allele"/>
            <column name="allele_gene_strand"/>
            <column name="phenotype"/>
            <column name="product"/>
            <sql>
            <![CDATA[
SELECT sf.source_id, 
       '@PROJECT_ID@' AS project_id,
       var.strain,
       CASE WHEN snp.gene_strand = 'reverse' THEN apidb.reverse_complement(var.allele) 
            WHEN snp.gene_source_id is null THEN ''
       ELSE var.allele 
       END as allele_gene_strand,
       var.allele,
       var.phenotype, 
       var.product
FROM  
       DoTS.SeqVariation var, 
       DoTS.SnpFeature sf,
       APIDBTUNING.SnpChipAttributes snp
WHERE var.parent_id = sf.na_feature_id
     AND snp.source_id = sf.source_id    
     AND sf.name like 'Broad_%'
             ]]>
           </sql>
        </sqlQuery>

        <sqlQuery name="StrainsWithMetaData" includeProjects="PlasmoDB" 
              isCacheable="false">
            <column name="source_id" />
            <column name="project_id" />
            <column name="strain"/>
            <column name="allele"/>
            <column name="data_type"/>
            <column name="isolate_id"/>
            <column name="country"/>
            <column name="allele_gene_strand"/>
            <column name="phenotype"/>
            <column name="product"/>
            <sql>
            <![CDATA[
SELECT snp.source_id, 
       '@PROJECT_ID@' AS project_id,
       strain.isolate_id, 
       var.strain,
       var.name as data_type,
       geolocation.value as country,
       CASE WHEN sa.gene_strand = 'reverse' THEN apidb.reverse_complement(var.allele) 
            WHEN sa.gene_source_id is null THEN ''
       ELSE var.allele 
       END as allele_gene_strand,
       var.allele,
       var.phenotype, 
       var.product
FROM  dots.snpfeature snp, 
      dots.seqvariation var,
      apidbtuning.SnpChipAttributes sa,
      ( SELECT bmc.value as strain, bs.name as isolate_id, sbm.BIO_MATERIAL_ID, 
              s.study_id, s.EXTERNAL_DATABASE_RELEASE_ID
        FROM  study.study s,
              RAD.STUDYBIOMATERIAL sbm,
              study.biosample bs,
              STUDY.BIOMATERIALCHARACTERISTIC bmc,
              study.ontologyentry oe
        WHERE s.study_id = sbm.study_id
          AND bs.BIO_MATERIAL_ID = sbm.BIO_MATERIAL_ID
          AND bmc.BIO_MATERIAL_ID = bs.BIO_MATERIAL_ID
           AND oe.ontology_entry_id = bmc.ONTOLOGY_ENTRY_ID
           AND oe.category = 'BioMaterialCharacteristics' 
           AND oe.value = 'StrainOrLine'
      ) strain,
      ( SELECT bmc.value, bs.name as isolate_id, sbm.BIO_MATERIAL_ID, s.study_id, s.external_database_release_id
        FROM  study.study s,
              RAD.STUDYBIOMATERIAL sbm,
              study.biosample bs,
              STUDY.BIOMATERIALCHARACTERISTIC bmc,
              study.ontologyentry oe
         WHERE s.study_id = sbm.study_id
           AND bs.BIO_MATERIAL_ID = sbm.BIO_MATERIAL_ID
           AND bmc.BIO_MATERIAL_ID = bs.BIO_MATERIAL_ID
           AND oe.ontology_entry_id = bmc.ONTOLOGY_ENTRY_ID
           AND oe.category = 'Sample Collection Location' --and oe.category = 'BioMaterialCharacteristics' 
           AND oe.value = 'GeographicLocation'
       ) geolocation
WHERE var.parent_id = snp.na_feature_id
  AND sa.na_feature_id = snp.na_feature_id
  AND strain.strain = var.strain
  AND strain.external_database_release_id = var.external_database_release_id
  AND geolocation.bio_material_id = strain.bio_material_id  
             ]]>
        </sql>
      </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Other SNPs at the same location - All NGS SNPs               -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="OtherSNPs" includeProjects="PlasmoDB" 
               isCacheable="false">
            <column name="source_id" />
            <column name="project_id" />
            <column name="other_snp_id"/>
            <column name="link"/>
            <column name="name"/>

            <sql>
            <![CDATA[
SELECT sa.source_id,  '@PROJECT_ID@' AS project_id,
       sb.source_id other_snp_id,
       'showRecord.do?name=SnpRecordClasses.SnpRecordClass'|| chr(38) || 'project_id=@PROJECT_ID@' || chr(38) || 'source_id=' || sb.source_id as link,
       sb.dataset as name
FROM  apidbtuning.SnpChipAttributes sa, 
      apidbtuning.snpAttributes sb
WHERE sa.na_sequence_id = sb.na_sequence_id
  and sa.start_min = sb.location
  and sb.source_id != sa.source_id
Union
SELECT sa.source_id,  '@PROJECT_ID@' AS project_id,
       sb.source_id other_snp_id, 
       'showRecord.do?name=SnpChipRecordClasses.SnpChipRecordClass' || chr(38) || 'project_id=@PROJECT_ID@' || chr(38) || 'source_id=' || sb.source_id as link,
       sb.dataset as name
FROM  apidbtuning.SnpChipAttributes sa, 
      apidbtuning.snpChipAttributes sb
WHERE sa.na_sequence_id = sb.na_sequence_id
  and sa.start_min = sb.start_min
  and sb.source_id != sa.source_id

             ]]>
           </sql>

        </sqlQuery> 

    </querySet>
</wdkModel>
