<wdkModel>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Legacy SNP / SNP Chip (PlasmoDB) table query -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <querySet name="SnpChipTables" queryType="table" isCacheable="false" includeProjects="PlasmoDB,EuPathDB">

      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">Pf_01_000539044_barcode</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Strains for sequencing SNPs -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="Strains" includeProjects="PlasmoDB" 
              isCacheable="false">
            <column name="source_id" />
            <column name="project_id" />
            <column name="strain"/>
            <column name="allele"/>
            <column name="allele_gene_strand"/>
            <column name="phenotype"/>
            <column name="product"/>
            <sql>
            <![CDATA[
SELECT snp.source_id, 
       '@PROJECT_ID@' AS project_id,
       var.strain,
       CASE WHEN snp.gene_strand = 'reverse' THEN apidb.reverse_complement(var.allele) 
            WHEN snp.gene_source_id is null THEN ''
       ELSE var.allele 
       END as allele_gene_strand,
       var.allele, 
       var.product,
       'todo' as phenotype
FROM  
       results.SeqVariation var, ApidbTuning.SnpAttributesDots snp
WHERE var.snp_na_feature_id = snp.na_feature_id
             ]]>
           </sql>
        </sqlQuery>

        <sqlQuery name="StrainsWithMetaData" includeProjects="PlasmoDB" 
              isCacheable="false">
            <column name="source_id" />
            <column name="project_id" />
            <column name="strain"/>
            <column name="allele"/>
            <column name="country"/>
            <column name="allele_gene_strand"/>
            <column name="phenotype"/>
            <column name="product"/>
            <sql>
            <![CDATA[
 SELECT sa.source_id, 
       '@PROJECT_ID@' AS project_id,
       var.strain,
       loc.value as country,
       CASE WHEN sa.gene_strand = 'reverse' THEN apidb.reverse_complement(var.allele) 
            WHEN sa.gene_source_id is null THEN ''
       ELSE var.allele 
       END as allele_gene_strand,
       var.allele,
       'todo' as phenotype,
       var.product
FROM  results.seqvariation var,
      ApidbTuning.SnpAttributesDots sa,
      (select Protocol_App_Node_Id,value from apidbtuning.Pancharacteristicmetadata where term = 'geographic location') loc
WHERE var.snp_na_feature_id = sa.na_feature_id
  AND var.allele in ('A','C','G','T')
  AND loc.Protocol_App_Node_Id = var.Protocol_App_Node_Id
             ]]>
        </sql>
      </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Other SNPs at the same location - All NGS SNPs               -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="OtherSNPs" includeProjects="PlasmoDB" 
               isCacheable="false">
            <column name="source_id" />
            <column name="project_id" />
            <column name="other_snp_id"/>
            <column name="link"/>
            <column name="name"/>

            <sql>
            <![CDATA[
SELECT sa.source_id,  '@PROJECT_ID@' AS project_id,
       sb.source_id other_snp_id,
       'showRecord.do?name=SnpRecordClasses.SnpRecordClass'|| chr(38) || 'project_id=@PROJECT_ID@' || chr(38) || 'source_id=' || sb.source_id as link,
       sb.dataset as name
FROM  ApidbTuning.SnpAttributesDots sa, 
      apidbtuning.snpAttributes sb
WHERE sa.na_sequence_id = sb.na_sequence_id
  and sa.start_min = sb.location
  and sb.source_id != sa.source_id
Union
SELECT sa.source_id,  '@PROJECT_ID@' AS project_id,
       sb.source_id other_snp_id, 
       'showRecord.do?name=SnpChipRecordClasses.SnpChipRecordClass' || chr(38) || 'project_id=@PROJECT_ID@' || chr(38) || 'source_id=' || sb.source_id as link,
       sb.dataset as name
FROM  ApidbTuning.SnpAttributesDots sa, 
      ApidbTuning.SnpAttributesDots sb
WHERE sa.na_sequence_id = sb.na_sequence_id
  and sa.start_min = sb.start_min
  and sb.source_id != sa.source_id

             ]]>
           </sql>

        </sqlQuery> 

               <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- country summary -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="CountrySummary" includeProjects="PiroplasmaDB,GiardiaDB,ToxoDB,PlasmoDB,CryptoDB,AmoebaDB,TriTrypDB,FungiDB" isCacheable="false">
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="geographic_location"/>
            <column name="total_strains"/>
            <column name="major_allele"/>
            <column name="minor_allele"/>
            <column name="other_allele"/>
            <sql>
                <![CDATA[
select source_id,'PlasmoDB' AS project_id,geographic_location, total_strains,
major_allele || ' ('||maj_freq||')' as major_allele,
CASE WHEN minor_allele is not null THEN 
   CASE WHEN other_allele is not null THEN minor_allele || ' ('||other_freq||')' ELSE minor_allele || ' ('||min_freq||')' END 
ELSE null END as minor_allele,
CASE WHEN other_allele is not null THEN other_allele || ' ('||min_freq||')' ELSE null END as other_allele
from (
select source_id,geographic_location,
substr(listagg(allele_gene_strand, ', ') within group (order by count_strains desc),1,1) as major_allele,
substr(listagg(allele_gene_strand, ', ') within group (order by count_strains desc),4,1) as minor_allele,
substr(listagg(allele_gene_strand, ', ') within group (order by count_strains desc),7,1) as other_allele,
sum(count_strains) as total_strains,
round((max(count_strains) / sum(count_strains)),2) as maj_freq,
round((min(count_strains) / sum(count_strains)),2) as min_freq,
round((median(count_strains) / sum(count_strains)),2) as other_freq
from (
select source_id,geographic_location,allele_gene_strand,product,count(*) as count_strains
from (
SELECT sa.source_id, '@PROJECT_ID@' AS project_id,
       CASE WHEN var.strain = sa.reference_strain THEN var.strain||' (reference)' ELSE var.strain END as strain,
       CASE WHEN sa.gene_strand = 'reverse' THEN apidb.reverse_complement(var.allele) 
            WHEN sa.gene_source_id is null THEN ''
            ELSE var.allele 
       END as allele_gene_strand,
       var.product,
       var.coverage,
        nvl(loc.value,'unknown') as geographic_location
FROM   results.SeqVariation var, apidbtuning.snpattributesdots sa,
       (select Protocol_App_Node_Id,value from apidbtuning.Pancharacteristicmetadata where term = 'geographic location') loc
WHERE sa.na_feature_id = var.snp_na_feature_id
and var.allele in ('A','C','G','T')
and var.protocol_app_node_id = loc.protocol_app_node_id(+) )
group by source_id,geographic_location,allele_gene_strand,product )
group by source_id,geographic_location)
                ]]>
            </sql>
       </sqlQuery>       

    </querySet>
</wdkModel>
