<wdkModel>

<!-- notes

  - so far this is only a unification of p and t.  crypto seemed pretty different

  - the pathways query is diff between t and p, but shouldn't be.  one is wrong.

--> 

  <querySet name="IsolateTables" queryType="table" includeProjects="CryptoDB,PlasmoDB,ToxoDB,EuPathDB,GiardiaDB">
    
      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">FJ490884</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="CryptoDB">
         <paramValue name="source_id">AY168847</paramValue>
         <paramValue name="project_id">CryptoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="ToxoDB">
         <paramValue name="source_id">EF639858</paramValue>
         <paramValue name="project_id">ToxoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="GiardiaDB">
         <paramValue name="source_id">AF176672</paramValue>
         <paramValue name="project_id">GiardiaDB</paramValue>
      </defaultTestParamValues>


       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolate Publication -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<!--

       <sqlQuery name="Reference" isCacheable="true" includeProjects="CryptoDB,PlasmoDB,EuPathDB">
            <paramRef ref="recordParams.source_id"/>
            <paramRef ref="recordParams.project_id"/>
            <column name="source_id" />
            <column name="project_id" />
            <column name="title"/>
            <column name="author"/>
            <column name="journal_or_book_name"/>
            <sql>
            <![CDATA[
            SELECT etn.source_id,
                   ref.title,
                   ref.author,
                   ref.journal_or_book_name,
                   '@PROJECT_ID@' as project_id
            FROM   DoTS.ExternalNASequence etn,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
               AND nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND etn.source_id = $$source_id$$
            ORDER BY ref.reference_id
            ]]>
            </sql>
        </sqlQuery>

-->

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolates in the same study -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<!-- Replace with link to summary page using the Study Question

       <sqlQuery name="IsoStudy" isCacheable="true" includeProjects="CryptoDB,PlasmoDB,EuPathDB">

         <testParamValues includeProjects="CryptoDB">
            <paramValue name="source_id">AF266267</paramValue>
         </testParamValues>

            <paramRef ref="recordParams.source_id"/>
            <paramRef ref="recordParams.project_id"/>
            <column name="source_id" />
            <column name="project_id" />
            <column name="definition" />
            <column name="checkbox" />
            <column name="strain" />
            <column name="organism" />
            <sql>
            <![CDATA[
            SELECT distinct etn.source_id,
                   '<input type="checkbox" name="selectedFields" value="' || etn.source_id || '">' checkbox,
                   etn.description definition,
                   src.organism organism,
                   src.strain || src.isolate strain,
                   '@PROJECT_ID@' as project_id
            FROM   DoTS.ExternalNASequence etn,
                   DoTS.IsolateSource src,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  src.na_sequence_id = etn.na_sequence_id
               AND edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
               AND nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND etn.source_id != $$source_id$$
               AND ref.title != 'Direct Submission'
               AND ref.reference_id IN 
            (
            SELECT distinct ref.reference_id
            FROM   DoTS.ExternalNASequence etn,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   SRes.ExternalDatabaseRelease edr,
                   SRes.ExternalDatabase edb
            WHERE  edr.external_database_id = edb.external_database_id
               AND edr.external_database_release_id = etn.external_database_release_id
               AND edb.name = 'Isolates Data'
               AND edr.version = '2007-12-12'
               AND nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND etn.source_id = $$source_id$$
            )
            ORDER BY etn.source_id
            ]]>
            </sql>
        </sqlQuery>

-->

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolate Barcode SNPs -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="SNP" isCacheable="true" includeProjects="EuPathDB,PlasmoDB">
         <testParamValues includeProjects="PlasmoDB">
            <paramValue name="source_id">CP3.911230</paramValue>
         </testParamValues>
            <column name="source_id" />
            <column name="project_id" />
            <column name="start_min"/>
            <column name="chromosome"/>
            <column name="allele"/>
            <column name="snp_id"/>
            <column name="colored_allele"/>
            <column name="major_allele"/>
            <column name="minor_allele"/>
            <sql>
            <![CDATA[
            SELECT nal.start_min,
                   chr.source_id chromosome,
                   if.source_id snp_id, 
                   etn.source_id source_id, 
                   if.allele,
                   case when if.allele = snp.major_allele
                        then '<font color=#342D7E><b>' || if.allele || '</b></font>'
                        else  if.allele
                   end colored_allele,
                   snp.major_allele,
                   snp.minor_allele,
                   '@PROJECT_ID@' as project_id
            FROM   ApiDB.IsolateAttributes etn,
                   DoTS.IsolateFeature if,
                   DoTS.IsolateSource src,
                   DoTS.ExternalNASequence chr,
                   DoTS.NALocation nal,
                   ( SELECT source_id, major_allele, minor_allele
                     FROM   DoTS.SNPFeature ) snp 
            WHERE  etn.na_sequence_id = src.na_sequence_id
               AND src.na_feature_id = if.parent_id
               AND nal.na_feature_id = if.na_feature_id
               AND chr.na_sequence_id = if.na_sequence_id
               AND snp.source_id = if.source_id
            ORDER BY if.source_id
            ]]>
            </sql>
        </sqlQuery>


       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- RFLP data -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

      <sqlQuery name="RFLPdata" includeProjects="ToxoDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="locus"/>
            <column name="type"/> 
            <sql>
            <![CDATA[
select s.source_id,'@PROJECT_ID@' as project_id,f.product as locus,f.gene_type as type
from dots.nasequence s, dots.ISOLATEFEATURE f
where f.na_sequence_id = s.na_sequence_id
            ]]>
            </sql>
        </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- GeneOverlap -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

      <sqlQuery name="GeneOverlap" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
         <testParamValues includeProjects="GiardiaDB">
            <paramValue name="source_id">L49327</paramValue>
         </testParamValues>

            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="gene"/>
            <column name="gene_product"/>
            <column name="pvalue_mant"/>
            <column name="pvalue_exp"/>
            <column name="start_min"/>
            <column name="end_max"/>
            <column name="organism"/>
            <column name="sequence_source_id"/>
            <sqlParamValue name="pvalueCutoff">-5</sqlParamValue>
            <sql>
            <![CDATA[
            select sim.*, gene.gene, gene.gene_product, '@PROJECT_ID@' as project_id
            from ((select i.source_id, s.pvalue_mant , s.pvalue_exp,  tn.name as organism,
                   s.min_subject_start as start_min, s.max_subject_end as end_max, nas.source_id as sequence_source_id
                  from dots.similarity s, apidb.isolateattributes i, 
                       core.tableinfo t, dots.nasequence nas, sres.taxonname tn
                  where s.query_id = i.na_sequence_id
                  and nas.na_sequence_id = s.subject_id
                   and t.table_id = s.subject_table_id
                   and t.table_id = s.query_table_id
                   and t.name = 'ExternalNASequence'
                   and tn.taxon_id = nas.taxon_id
                   and tn.name_class = 'scientific name'
                 ) sim left join
                (select i.source_id, seq.source_id as sequence_id, g.source_id as gene, g.product as gene_product
                 from  dots.similarity s, apidb.isolateattributes i,
                       dots.genefeature g, core.tableinfo t, dots.nalocation l, dots.nasequence seq
                 where s.query_id = i.na_sequence_id
                  and s.subject_id = g.na_sequence_id
                  and t.table_id = s.subject_table_id
                  and t.table_id = s.query_table_id
                  and s.min_subject_start <=  l.end_max
                  and s.max_subject_end >= l.start_min
                  and l.na_feature_id = g.na_feature_id
                  and g.na_sequence_id = seq.na_sequence_id
                  and t.name = 'ExternalNASequence'
                  ) gene
                  on gene.source_id = sim.source_id and gene.sequence_id = sim.sequence_source_id)
             where pvalue_exp <= &&pvalueCutoff&&
            order by sim.pvalue_exp, pvalue_mant
            ]]>
           </sql>
      </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Attributes as tables (to feed text search)  -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

      <sqlQuery name="organism" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="organism"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.organism
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="description" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="description"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.description
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="product" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="product"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.product
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="strain" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="strain"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.strain
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="host" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="host"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.specific_host as host
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="note" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="note"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.note
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="isolation_source" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="isolation_source"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.isolation_source
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="geographic_location" includeProjects="PlasmoDB,CryptoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="geographic_location"/>
            <sql>
            <![CDATA[
            select ia.source_id, '@PROJECT_ID@' as project_id, ia.country as geographic_location
            from apidb.IsolateAttributes ia
            ]]>
           </sql>
      </sqlQuery>


       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- ProteinSequence -->
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

      <sqlQuery name="ProteinSequence" includeProjects="CryptoDB,PlasmoDB,ToxoDB,EuPathDB,GiardiaDB" doNotTest="true">
         <testParamValues includeProjects="CryptoDB">
            <paramValue name="source_id">AB089288</paramValue>
         </testParamValues>
         <testParamValues includeProjects="PlasmoDB">
            <paramValue name="source_id">AF063138</paramValue>
         </testParamValues>
         <testParamValues includeProjects="ToxoDB">
            <paramValue name="source_id">EF639858</paramValue>
         </testParamValues>
         <testParamValues includeProjects="GiardiaDB">
            <paramValue name="source_id">AF176672</paramValue>
         </testParamValues>

            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="protein_sequence"/>
            <sql>
            <![CDATA[
            SELECT etn.source_id, '@PROJECT_ID@' as project_id,
                      tas.sequence as protein_sequence
               FROM   DoTS.TranslatedAAFeature taf,
                      DoTS.Transcript trp, 
                      DoTS.TranslatedAASequence tas,
                      DoTS.IsolateFeature gf,
                      DOTS.NALocation l,
                      DoTS.ExternalNASequence etn
               WHERE trp.na_feature_id = taf.na_feature_id
                  AND tas.aa_sequence_id = taf.aa_sequence_id
                  AND trp.parent_id = gf.na_feature_id
                  AND etn.na_sequence_id = gf.na_sequence_id
                  AND l.na_feature_id = gf.na_feature_id
                  ORDER by etn.source_id, l.start_min
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="Reference" includeProjects="CryptoDB,PlasmoDB,ToxoDB,EuPathDB,GiardiaDB">
            <column name="project_id"/>
            <column name="source_id"/> 
            <column name="title"/>
            <column name="author"/>
            <column name="journal"/>
            <column name="studyLink"/>
            <sql>
            <![CDATA[
            SELECT distinct ia.source_id, 
                   ref.title,
                   ref.author,
                   ref.journal_or_book_name as journal,
                   '@PROJECT_ID@' as project_id,
                   case when title is null then 'N/A'
                        when title = 'Direct Submission' then 'N/A'
                   else '<a href="showSummary.do?questionFullName=IsolateQuestions.IsolateByStudy&' || 'myProp(study)=' || apidb.alphanumeric_str(title)
       || '">view</a>' end as studyLink
            FROM   DoTS.NASequence etn,
                   DoTS.NASequenceRef nasr,
                   SRES.Reference ref,
                   apidb.isolateattributes ia
            WHERE   nasr.reference_id = ref.reference_id
               AND etn.na_sequence_id = nasr.na_sequence_id
               AND ia.source_id = etn.source_id (+)
            ]]>
           </sql>
      </sqlQuery>

      <sqlQuery name="AllResults" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.isolate_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT source_id, project_id
                    FROM $$isolate_answer$$
                ]]>
            </sql>
        </sqlQuery>
      <sqlQuery name="ApiProjectIsolates" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.Project"/>
            <paramRef ref="recordParams.isolate_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT c.source_id, c.project_id
                    FROM $$isolate_answer$$ c, apidb.isolateattributes ia
                    where ia.source_id = c.source_id
                    and ia.project_id = $$Project$$
                ]]>
            </sql>
     </sqlQuery>

     <sqlQuery name="CountryCount" isCacheable='false'  doNotTest="true">
            <column name="source_id" />
            <column name="project_id" />
            <column name="country" />
            <column name="count" />
            <sql>
            <![CDATA[           
                SELECT  'test' as source_id, 
                       '@PROJECT_ID@' as project_id,
                       count(v.term) as count, 
                       v.term as country
                FROM   apidb.isolatevocabulary v,
                       apidb.isolatemapping m,
                       apidb.isolateattributes i
                WHERE  v.type = 'geographic_location'
                   AND v.isolate_vocabulary_id = m.isolate_vocabulary_id
                   AND i.na_sequence_id = m.na_sequence_id
                GROUP BY v.term 
            ]]>
            </sql>
      </sqlQuery>

   </querySet>
</wdkModel>
