<wdkModel>

<!-- notes

  - so far this is only a unification of p and t.  crypto seemed pretty different

  - the pathways query is diff between t and p, but shouldn't be.  one is wrong.

-->

  <querySet name="IsolateTables" queryType="table" isCacheable="false">


      <defaultTestParamValues includeProjects="AmoebaDB">
         <paramValue name="source_id">GQ423750</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="CryptoDB">
         <paramValue name="source_id">AY168847</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="GiardiaDB,EuPathDB">
         <paramValue name="source_id">AF176672</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="MicrosporidiaDB">
         <paramValue name="source_id">AB472273</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="PiroplasmaDB">
         <paramValue name="source_id">EU362993</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">FJ490884</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="ToxoDB">
         <paramValue name="source_id">AB703307</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="FungiDB">
         <paramValue name="source_id">GQ247676</paramValue>
      </defaultTestParamValues>


       <!--+++++++++++++-->
       <!-- GeneOverlap -->
       <!--+++++++++++++-->

      <sqlQuery name="GeneOverlap">
        <testParamValues includeProjects="GiardiaDB">
          <paramValue name="source_id">L49327</paramValue>
        </testParamValues>

        <column name="source_id"/>
        <column name="project_id"/>
        <column name="gene"/>
        <column name="gene_product"/>
        <column name="pvalue_mant"/>
        <column name="pvalue_exp"/>
        <column name="start_min"/>
        <column name="end_max"/>
        <column name="organism"/>
        <column name="sequence_source_id"/>
        <sqlParamValue name="pvalueCutoff">-5</sqlParamValue>
        <sql>
          <![CDATA[
            select sim.*, '@PROJECT_ID@' AS project_id, gene.gene, gene.gene_product
            from ((select i.source_id, s.pvalue_mant , s.pvalue_exp,  tn.name as organism,
                   s.min_subject_start as start_min, s.max_subject_end as end_max, nas.source_id as sequence_source_id
                  from dots.similarity s, ApidbTuning.IsolateAttributes i, 
                       dots.nasequence nas, sres.taxonname tn
                  where s.query_id = i.na_sequence_id
                  and nas.na_sequence_id = s.subject_id
                   and s.subject_table_id = (select table_id from core.TableInfo where name = 'ExternalNASequence')
                   and s.subject_table_id = s.query_table_id
                   and tn.taxon_id = nas.taxon_id
                   and tn.name_class = 'scientific name'
                 ) sim left join
                (select g.source_id as gene, g.gene_product, loc.sequence_source_id, loc.start_min, loc.end_max
                 from ApidbTuning.TranscriptAttributes g, ApidbTuning.FeatureLocation loc
                 where g.na_feature_id = loc.na_feature_id
                   and loc.feature_type = 'GeneFeature'
                  ) gene
                  on gene.sequence_source_id = sim.sequence_source_id and gene.start_min <= sim.end_max and gene.end_max >= sim.start_min)
            where pvalue_exp <= &&pvalueCutoff&&
            order by sim.pvalue_exp, pvalue_mant
          ]]>
        </sql>
      </sqlQuery>


       <!--+++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Attributes as tables (to feed text search)  -->
       <!--+++++++++++++++++++++++++++++++++++++++++++++-->

      <sqlQuery name="organism">
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="organism"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.organism
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="description" >
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="description"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.description
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="product" >
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="product"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.product
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="strain" >
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="strain"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.strain
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="host" >
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="host"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.host
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="note" >
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="note"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.note
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="isolation_source" >
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="isolation_source"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.isolation_source
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="geographic_location" >
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="geographic_location"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ia.geographic_location
            from ApidbTuning.IsolateAttributes ia
          ]]>
        </sql>
      </sqlQuery>


       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- ProteinSequence -->
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

<!--
      <sqlQuery name="ProteinSequence" excludeProjects="EuPathDB" doNotTest="true">
        <testParamValues includeProjects="CryptoDB">
          <paramValue name="source_id">AB089288</paramValue>
        </testParamValues>
        <testParamValues includeProjects="PlasmoDB">
          <paramValue name="source_id">AF063138</paramValue>
        </testParamValues>
        <testParamValues includeProjects="ToxoDB">
          <paramValue name="source_id">EF639858</paramValue>
        </testParamValues>
        <testParamValues includeProjects="GiardiaDB">
          <paramValue name="source_id">AF176672</paramValue>
        </testParamValues>

        <column name="source_id"/>
        <column name="protein_sequence"/>
        <sql>
          <![CDATA[
            select etn.source_id, tas.sequence as protein_sequence
            from dots.TranslatedAaFeature taf, dots.Transcript trp,
                 dots.TranslatedAASequence tas, dots.IsolateFeature gf,
                 dots.NaLocation l, dots.ExternalNaSequence etn
            where trp.na_feature_id = taf.na_feature_id
              and tas.aa_sequence_id = taf.aa_sequence_id
              and trp.parent_id = gf.na_feature_id
              and etn.na_sequence_id = gf.na_sequence_id
              and l.na_feature_id = gf.na_feature_id
            order by etn.source_id, l.start_min
          ]]>
        </sql>
      </sqlQuery>
-->

      <sqlQuery name="Reference" excludeProjects="EuPathDB">
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="title"/>
        <column name="author"/>
        <column name="journal"/>
        <column name="studyLink"/>
        <sql>
          <![CDATA[
            select ia.source_id, '@PROJECT_ID@' AS project_id, ref.title, ref.authors as author,
                   ref.publication as journal,
                   case when title is null then 'N/A'
                        when title = 'Direct Submission' then 'N/A'
                        else '<a href="processQuestion.do?questionFullName=IsolateQuestions.IsolateByStudy&'
                             || 'value(study)=' || apidb.alphanumeric_str(title)
                             || '">view</a>'
                   end as studyLink
            from apidbTuning.IsolateAttributes ia, study.StudyLink sl,
                 study.StudyBibRef sbr, sres.BibliographicReference ref
            where ia.protocol_app_node_id = sl.protocol_app_node_id
              and sl.study_id = sbr.study_id
              and sbr.bibliographic_reference_id = ref.bibliographic_reference_id
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="AllResults" isCacheable="false" includeProjects="EuPathDB">
        <paramRef ref="recordParams.isolate_answer"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="wdk_weight"/>
        <sql>
          <![CDATA[
            select c.source_id, '@PROJECT_ID@' AS project_id, c.wdk_weight
            from $$isolate_answer$$ c
          ]]>
        </sql>
      </sqlQuery>

      <sqlQuery name="ApiProjectIsolates" isCacheable="false" includeProjects="EuPathDB">
        <paramRef ref="recordParams.Project"/>
        <paramRef ref="recordParams.isolate_answer"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="wdk_weight"/>
        <sql>
          <![CDATA[
            select c.source_id, '@PROJECT_ID@' AS project_id, c.wdk_weight 
            from $$isolate_answer$$ c, ApidbTuning.IsolateAttributes ia
            where ia.source_id = c.source_id
          ]]>
        </sql>
      </sqlQuery>

      <!-- this is not a filter query, it is the query used for basket function -->
      <sqlQuery name="AllIsolateRecords" isCacheable="false" doNotTest="true">
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
            select sa.source_id, '@PROJECT_ID@' AS project_id
            from ApidbTuning.IsolateAttributes sa
          ]]>
        </sql>
      </sqlQuery>


   </querySet>
</wdkModel>
