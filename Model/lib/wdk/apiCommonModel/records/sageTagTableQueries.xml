<wdkModel>

  <querySet name="SageTagTables" queryType="table" includeProjects="PlasmoDB,GiardiaDB,TriTrypDB,ToxoDB,EuPathDB">

             <defaultTestParamValues includeProjects="PlasmoDB">
               <paramValue name="source_id">Pf3D7_06-1129291-1129305.1</paramValue>
               <paramValue name="project_id">PlasmoDB</paramValue>
            </defaultTestParamValues>

            <defaultTestParamValues includeProjects="ToxoDB">
               <paramValue name="source_id">TGME49_chrII-1015856-1015870.1</paramValue>
               <paramValue name="project_id">ToxoDB</paramValue>
            </defaultTestParamValues>

            <defaultTestParamValues includeProjects="GiardiaDB">
               <paramValue name="source_id">CH991779-75398-75413.0</paramValue>
               <paramValue name="project_id">GiardiaDB</paramValue>
            </defaultTestParamValues>


      <sqlQuery name="Experiments" isCacheable="false" includeProjects="ToxoDB,PlasmoDB,GiardiaDB,TriTrypDB">
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="experiment"/>
            <column name="norm_count"/>
            <column name="total_norm_count"/>
            <column name="norm_percent"/>
            <column name="raw_count"/>
            <column name="total_raw_count"/>
            <sql excludeProjects="TriTrypDB">
            <![CDATA[
            select a.source_id, '@PROJECT_ID@' AS project_id,
                   aa.library_name as experiment, 
                   to_char(aa.raw_count, '999999') as raw_count,
                   to_char(aa.total_raw_count, '99999999') as total_raw_count, 
                   to_char(aa.tag_count, '999999.99') as norm_count,
                   to_char(aa.library_total_tag_count, '99999999') as total_norm_count, 
                   to_char(aa.library_tag_percentage, '990D00000') || '%' as norm_percent
            from apidb.SAGETAGANALYSISATTRIBUTES aa, apidb.SAGETAGATTRIBUTES a, Rad.Assay ra
            where a.composite_element_id = aa.composite_element_id
            and ra.name = aa.library_name
            order by ra.assay_id
            ]]>
           </sql>
            <sql includeProjects="TriTrypDB">
            <![CDATA[
            select a.source_id, '@PROJECT_ID@' AS project_id,
                   aa.library_name as experiment, 
                   to_char(aa.raw_count, '999999') as raw_count,
                   to_char(aa.total_raw_count, '99999999') as total_raw_count, 
                   to_char(aa.tag_count, '999999.99') as norm_count,
                   to_char(aa.library_total_tag_count, '99999999') as total_norm_count, 
                   to_char(aa.library_tag_percentage, '990D00000') || '%' as norm_percent
            from apidb.SAGETAGANALYSISATTRIBUTES aa, apidb.SAGETAGATTRIBUTES a, Rad.Assay ra
            where a.composite_element_id = aa.composite_element_id
            and ra.name = aa.library_name
						and aa.library_name in ('procyclic_gambiense', 'bloodstream_gambiense')
            order by ra.assay_id
            ]]>
           </sql>
      </sqlQuery>

       <sqlQuery name="AlignedGenes" isCacheable="false" includeProjects="ToxoDB,PlasmoDB,GiardiaDB,TriTrypDB">
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="aligned_source_id"/>
            <column name="gene_source_id"/>
            <column name="gene_product"/>
            <column name="gene_location"/>
            <column name="gene_strand"/>
            <column name="bp_from_gene"/>
            <sql excludeProjects="TriTrypDB">
            <![CDATA[
            select distinct sta1.source_id AS source_id, '@PROJECT_ID@' AS project_id,
                   sg.gene_source_id AS aligned_source_id, sg.gene_source_id, g.product as gene_product,
                   g.sequence_id || ':' || g.start_min || '-' || g.end_max || '(' || 
                       case when g.is_reversed = 1 then '-' 
                            when g.is_reversed = 0 then '+'
                            else '' end || ')' as gene_location,
                   case when sg.antisense = 1 then 'antisense' else 'sense' end as gene_strand,
                  sg.distance as bp_from_gene
            from apidb.SAGETAGGENE sg,  apidb.GENEATTRIBUTES g, 
                 apidb.SAGETAGATTRIBUTES sta1, apidb.SAGETAGATTRIBUTES sta2
            where sg.tag_feature_id = sta2.na_feature_id
            and sta2.composite_element_id = sta1.composite_element_id
            and sg.gene_source_id = g.source_id 
            and sg.distance = 0
            and sg.antisense = 0
            order by sta1.source_id, gene_strand desc, bp_from_gene asc
            ]]>
           </sql>
            <sql includeProjects="TriTrypDB">
            <![CDATA[
            select distinct sta1.source_id AS source_id, '@PROJECT_ID@' AS project_id,
                   sg.gene_source_id AS aligned_source_id, sg.gene_source_id, g.product as gene_product,
                   g.sequence_id || ':' || g.start_min || '-' || g.end_max || '(' || 
                       case when g.is_reversed = 1 then '-' 
                            when g.is_reversed = 0 then '+'
                            else '' end || ')' as gene_location,
                   case when sg.antisense = 1 then 'antisense' else 'sense' end as gene_strand,
                  sg.distance as bp_from_gene
            from apidb.SAGETAGGENE sg,  apidb.GENEATTRIBUTES g, 
                 apidb.SAGETAGATTRIBUTES sta1, apidb.SAGETAGATTRIBUTES sta2
            where sg.tag_feature_id = sta2.na_feature_id
            and sta2.composite_element_id = sta1.composite_element_id
            and sg.gene_source_id = g.source_id 
            and sg.distance = 0
            and sg.antisense = 0
						and sg.library_name in ('procyclic_gambiense', 'bloodstream_gambiense')
            order by sta1.source_id, gene_strand desc, bp_from_gene asc
            ]]>
           </sql>
      </sqlQuery>

     <sqlQuery name="Locations" isCacheable="false" includeProjects="GiardiaDB,TriTrypDB,PlasmoDB,ToxoDB">
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="sequence_source_id"/>
            <column name="is_top_level"/>
            <column name="start_min"/>
            <column name="end_max"/>
            <column name="is_reversed"/>
            <column name="start_context"/>
            <column name="end_context"/>
            <column name="term_name"/>
            <column name="feature_source_id"/>
            <sql>
            <![CDATA[ 
            select t.source_id,sta.feature_source_id, '@PROJECT_ID@' AS project_id, t.sequence_source_id, t.term_name, 
                   t.is_top_level,t.start_min,t.end_max,t.is_reversed,t.start_context,t.end_context 
              from apidb.sagetagattributes sta,
                     (SELECT sta.source_id, sta.composite_element_id as ceid,
                     sta.feature_source_id,
                     fl.sequence_source_id,
                     so.term_name,
                     fl.is_top_level,
                     fl.start_min,
                     fl.end_max,
                     Decode(fl.is_reversed, 0, '+', 1, '-') is_reversed,
                    (fl.start_min-5000)as start_context,
                    (fl.end_max+5000)as end_context
                     FROM apidb.featurelocation fl, apidb.sagetagattributes sta,
                          dots.nasequence s, sres.sequenceontology so
                     WHERE fl.na_feature_id = sta.na_feature_id
                      and s.na_sequence_id = fl.na_sequence_id
                      and s.sequence_ontology_id = so.sequence_ontology_id) t 
              where sta.feature_source_id = t.feature_source_id
              ORDER BY is_top_level desc
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="AllResults" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.sagetag_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="wdk_weight"/>
            <sql>
                <![CDATA[
                    SELECT  c.source_id, c.project_id, c.wdk_weight
                    FROM $$sagetag_answer$$ c
                ]]>
            </sql>
        </sqlQuery>

       <sqlQuery name="ApiProjectSageTags" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.Project"/>
            <paramRef ref="recordParams.sagetag_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="wdk_weight"/>
            <sql>
                <![CDATA[
                    SELECT  c.source_id, c.project_id, c.wdk_weight 
                    FROM $$sagetag_answer$$ c, apidb.sagetagattributes aa
                    where aa.source_id = c.source_id
                    and aa.project_id = $$Project$$
                ]]>
            </sql>
     </sqlQuery>


        <!-- this is not a filter query, it is the query used for basket function -->
       <sqlQuery name="AllSageTags" isCacheable="false">
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT  aa.source_id, aa.project_id 
                    FROM apidb.sagetagattributes aa
                ]]>
            </sql>
     </sqlQuery>
 </querySet>
</wdkModel>



