<wdkModel>
  <querySet name="SampleTables" queryType="table" isCacheable="false" >


    <sqlQuery name="Characteristics">
            <column name="name"/>
            <column name="material_type"/>
            <column name="property"/>
            <column name="value"/>
            <column name="type"/>
            <column name="filter"/>
           <sql>
            <![CDATA[
SELECT
  scm.pan_name AS name
, scm.category AS material_type
, scm.term AS property
, scm.value
, mt.type
, mt.filter
FROM
  ApidbTuning.SampleCharMetadata scm, ApidbTuning.MetadataType mt
WHERE
  scm.term = mt.property
            ]]>
            </sql>
    </sqlQuery>

    <sqlQuery name="Protocols">
            <column name="name"/>
            <column name="protocol_name"  />
            <column name="protocol_param_name"  />
            <column name="value"  />
           <sql>
            <![CDATA[
SELECT
  pan_name as name
, category as protocol_name
, term AS protocol_param_name
, value
FROM
  APIDBTUNING.sampleprotocolmetadata
            ]]>
            </sql>
    </sqlQuery>

    <sqlQuery name="ProcessedSample">
            <column name="name"/>
            <column name="input"  />
            <column name="input_type"  />
            <column name="protocol"  />
            <column name="output"  />
            <column name="output_type"  />
           <sql>
            <![CDATA[
SELECT
  name
, input
, nvl(input_material_type,  input_isa_type) as input_type
, protocol
, output
, nvl(nvl(output_material_type, output_isa_type), 'Data') as output_type
from
 apidbtuning.sampledownstream
            ]]>
            </sql>
    </sqlQuery>

    <sqlQuery name="TaxaRelativeAbundance">
            <column name="name"/>
            <column name="taxon_id"/>
             <column name="kingdom"/>
             <column name="phylum"/>
             <column name="class"/>
             <column name="rank_order"/>
             <column name="family"/>
             <column name="genus"/>
             <column name="species"/>
            <column name="relative abundance"  />
           <sql>
            <![CDATA[
                     select ta.*,
                               replace(decode(superkingdom, 'N/A',kingdom,superkingdom),'N/A', '') as kingdom,
                               replace(phylum,'N/A', '') as phylum,
                               replace(class,'N/A', '') as class,
                               replace(rank_order,'N/A', '') as rank_order,
                               replace(family,'N/A', '') as family,
                               replace(genus,'N/A', '') as genus,
                               replace(species,'N/A', '') as species
                     from (
                                select ds.name,
                                          oa.protocol_app_node_id,
                                          seq.TAXON_ID,
                                          round(sum(nvl(oa.RELATIVE_ABUNDANCE,0)),4) as relative_abundance
                                          from RESULTS.OTUABUNDANCE oa,
                                                  DOTS.EXTERNALNASEQUENCE seq,   
                                                  apidbtuning.sampledownstream ds
                                           where oa.PROTOCOL_APP_NODE_ID = ds.OUTPUT_PROTOCOL_APP_NODE_ID
                                           and ds.OUTPUT_ISA_TYPE = 'Data'
                                           and oa.NA_SEQUENCE_ID = seq.NA_SEQUENCE_ID
                                           group by  ds.name,  oa.protocol_app_node_id, seq.TAXON_ID
                                  ) ta,
                                  apidbtuning.EXTERNALSEQUENCETAXONRANK estr
                        where ta.taxon_id = estr.organism
                        and ta.relative_abundance > 0
                        order by name,relative_abundance desc, superkingdom, kingdom, phylum, class, rank_order, genus, species
            ]]>
            </sql>
    </sqlQuery>

    <sqlQuery name="Datasets">
            <column name="name"/>
            <column name="dataset_presenter_id"/>
            <column name="display_name"/>
            <column name="category"/>
            <column name="summary"/>
           <sql>
            <![CDATA[
select distinct  sd.name
 , edp.dataset_presenter_id
 , dsp.display_name
 , dsp.category
 , dbms_lob.substr( dsp.summary, 4000, 1 ) as summary
from apidbtuning.sampledownstream sd
   , apidbtuning.protocolappnoderesults panr
   , study.study s
   , study.studylink sl
   , apidbtuning.externaldbdatasetpresenter edp
   , apidbtuning.datasetpresenter dsp
where sd.output_protocol_app_node_id = panr.protocol_app_node_id
and panr.protocol_app_node_id = sl.protocol_app_node_id
and sl.study_id = s.study_id
and s.external_database_release_id = edp.external_database_release_id
and edp.dataset_presenter_id = dsp.dataset_presenter_id
            ]]>
            </sql>
    </sqlQuery>
    </querySet>
</wdkModel>
