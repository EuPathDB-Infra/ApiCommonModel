<wdkModel>

  <recordClassSet name="DatasetRecordClasses" includeProjects="HostDB,InitDB,FungiDB,PiroplasmaDB,PlasmoDB,CryptoDB,MicrosporidiaDB,ToxoDB,GiardiaDB,AmoebaDB,TriTrypDB">

   <recordClass name="DatasetRecordClass" displayName="Dataset">


      <!-- primary key definition
           NOTE:  the name here is from apidbtuning.datasetpresenter NOT apidb.datasource
      -->
      <primaryKeyAttribute name="primary_key"
                           displayName="Dataset ID">
          <columnRef>dataset_id</columnRef>
          <text>
              <![CDATA[
                   $$dataset_id$$
               ]]>
           </text>                
      </primaryKeyAttribute>


      <!-- =============================================================== -->
      <!--   Reporters -->  
      <!-- =============================================================== -->

          <reporter name="tabular" displayName="Summary - tab delimited"
                    implementation="org.gusdb.wdk.model.report.TabularReporter"/>

      <!-- =============================================================== -->
      <!--   Filters -->
      <!-- =============================================================== -->


      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->
       <attributeQueryRef ref="DatasetAttributes.All">
         <columnAttribute name="dataset_id" internal="true" inReportMaker="false"/>
         <columnAttribute name="dataset_name" internal="true" inReportMaker="false"/>
         <columnAttribute name="dataset_name_pattern" internal="true" inReportMaker="false"/>
         <columnAttribute name="display_name_piece" internal="true"/>
         <columnAttribute name="short_display_name" internal="true"/>
         <columnAttribute name="description"/>
         <columnAttribute name="summary"/>
         <columnAttribute name="protocol"/>
         <columnAttribute name="usage"/>         
         <columnAttribute name="caveat"/>
         <columnAttribute name="acknowledgement"/>
         <columnAttribute name="release_policy"/>
         <columnAttribute name="type" internal="true"/>
         <columnAttribute name="subtype" internal="true"/> 
         <columnAttribute name="is_species_scope" internal="true"/> 
       </attributeQueryRef>
	   
       <attributeQueryRef ref="DatasetAttributes.Contacts">
         <columnAttribute name="contact"/>
         <columnAttribute name="institution"/>
	   </attributeQueryRef>
	   
       <attributeQueryRef ref="DatasetAttributes.Category">
         <columnAttribute name="category" internal="true" inReportMaker="false"/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.Organisms">
         <columnAttribute name="organisms"/>
         <columnAttribute name="organism_prefix"/>
       </attributeQueryRef>




            <textAttribute name="display_name" displayName="Display Name" help="Dataset Display Name">
             <display>
                  <![CDATA[
                           <i>$$organism_prefix$$</i> $$display_name_piece$$
                  ]]>
              </display>
              <text>
                  <![CDATA[
                           $$organism_prefix$$ $$display_name_piece$$
                  ]]>
              </text>
            </textAttribute>



     <!-- =================================================================== -->
     <!-- Tables ++++++++-->
     <!-- =================================================================== -->

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Contacts -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Contacts"
               displayName="Principal Investigator and Collaborators"
               queryRef="DatasetTables.Contacts">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="contact_name" displayName="Principal investigator"/>
            <columnAttribute name="affiliation" displayName="Affiliation"/>
        </table>  

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Isolates / Samples -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Isolates"
               displayName="Isolates / Samples"
               queryRef="DatasetTables.Isolates">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="source_id" inReportMaker="true" internal="true"/>
            <columnAttribute name="strain" inReportMaker="true" internal="true"/>
            <columnAttribute name="contact_name" inReportMaker="true" internal="true"/>
            <linkAttribute name="isolate_link" inReportMaker="false" internal="false"
                           displayName="Isolate Source Id">

                 <displayText>
                    <![CDATA[
                    $$source_id$$ - ($$strain$$) $$contact_name$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                      /a/showRecord.do?name=IsolateRecordClasses.IsolateRecordClass&project_id=@PROJECT_ID@&source_id=$$source_id$$
                    ]]>
                 </url>
            </linkAttribute>
        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Publications -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Publications"
               displayName="Associated Publications"
               queryRef="DatasetTables.Publications">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="pmid" displayName="Pubmed ID" internal="true"/>
            <columnAttribute name="citation"/>


            <linkAttribute name="pubmed_link" inReportMaker="false" internal="false"
                           displayName="PubMed Link">

                 <displayText>
                    <![CDATA[
                    $$citation$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                             http://www.ncbi.nlm.nih.gov/pubmed/$$pmid$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>  


        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- External Links -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="HyperLinks"
               displayName="Links"
               queryRef="DatasetTables.HyperLinks">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="text" displayName="Description"/>
            <columnAttribute name="url" displayName="Hyperlink" internal="true"/>


            <linkAttribute name="hyper_link" inReportMaker="false" internal="false"
                           displayName="HyperLink">

                 <displayText>
                    <![CDATA[
                    $$text$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                          $$url$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- References -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="References"
               displayName="Searches using these data"
               queryRef="DatasetTables.References">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="record_type"/>
            <columnAttribute name="target_type"/>
            <columnAttribute name="target_name"/>
        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Version   -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <table name="Version"
               displayName="Version"
               queryRef="DatasetTables.Version">
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="organism"/>
            <columnAttribute name="version"/>
        </table>  
        
      </recordClass>
    </recordClassSet>



      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetAttributes" queryType="attribute" doNotTest="true"  
              isCacheable='false'
              includeProjects="HostDB,InitDB,FungiDB,PiroplasmaDB,PlasmoDB,CryptoDB,MicrosporidiaDB,ToxoDB,GiardiaDB,AmoebaDB,TriTrypDB">

      <testRowCountSql>
select count(*) from apidbtuning.datasetpresenter
       </testRowCountSql>

       <sqlQuery name="Category" isCacheable="false">
         <column name="category"/>
         <column name="dataset_id"/>
         <sql>
           <![CDATA[
                    select distinct dsp.dataset_presenter_id as dataset_id, 
                           nvl(dsp.display_category, 
                               decode(ds.type,
                                      'epitope', 'Genomes and Annotation',
                                      'dbxref', 'External Links',
                                      'isolates', 'Population Biology',
                                      'organellar_genome', 'Genomes and Annotation',
                                      'genome', 'Genomes and Annotation',
                                      'EST', 'Transcript Expression',
                                      'alias', 'Genomes and Annotation',
                                      'gene_annotation', 'Genomes and Annotation',
                                      'aligned_sequence', 'Miscellaneous',
                                      'orthology', 'Taxonomy and Phylogeny',
                                      'function', 'Function',
                                      'external_sequences', 'External Sequences',
                                      'feature', 'Miscellaneous',
                                      'sres', 'Ontology',
                                      'transcript_expression', 'Transcript Expression',
                                      'protein_expression', 'Protein Expression',
                                      'isolates', 'Population Biology',
                                      'SNP', 'Population Biology',
                                      null)
                                      ) as category
                    from apidbtuning.datasetnametaxon dsnt, 
                    apidb.datasource ds,
                    apidbtuning.datasetpresenter dsp
                    where dsnt.name = ds.name (+)
                    and dsnt.dataset_presenter_id (+) = dsp.dataset_presenter_id
                  ]]>
            </sql>
       </sqlQuery>


      <sqlQuery name="All"  isCacheable="false">
	    <column name="dataset_id"/>
		<column name="dataset_name"/>
        <column name="dataset_name_pattern"/>
		<column name="display_name_piece"/>
		<column name="short_display_name"/>
		<column name="description"/>
		<column name="summary"/>
		<column name="protocol"/>
		<column name="usage"/>
		<column name="caveat"/>
		<column name="acknowledgement"/> 
		<column name="release_policy"/>
		<column name="type"/>
		<column name="subtype"/>
		<column name="is_species_scope"/>
            <sql>
            <![CDATA[
			            select dsp.dataset_presenter_id as dataset_id,
                   dsp.name as dataset_name,
                   dsp.dataset_name_pattern,
                   dsp.display_name as display_name_piece,
                   dsp.short_display_name,
                   dsp.description,
                   nvl(dsp.summary, dsp.description) as summary,
                   dsp.protocol,
                   dsp.usage,
                   dsp.caveat,
                   dsp.acknowledgement, 
                   dsp.release_policy,
                   dsp.type,
                   dsp.subtype,
                   dsp.is_species_scope
            from apidbtuning.datasetpresenter dsp
                  ]]>
            </sql>
      </sqlQuery>

      <sqlQuery name="Contacts"  isCacheable="false">
	    <column name="dataset_id"/>
		<column name="contact"/>
        <column name="institution"/>
            <sql>
            <![CDATA[	  
			            select distinct dsp.dataset_presenter_id as dataset_id,
                   CASE WHEN  dsc.name is not null THEN dsc.name
                        WHEN dsc.affiliation is not null THEN dsc.affiliation
                        ELSE '<a href="http://eupathdb.org/eupathdb/contact.do" class="open-window-contact-us">Contact EuPathDB for more details</a>' 
                   END as contact,
                    CASE WHEN  (dsc.name is null and dsc.affiliation is not null) THEN dsc.name
                        ELSE   dsc.affiliation END as institution
            from apidbtuning.datasetpresenter dsp, apidbtuning.datasetcontact dsc, 
                 apidbtuning.datasetnametaxon dsnt, sres.taxonname tn
            where dsp.dataset_presenter_id = dsc.dataset_presenter_id (+)
            and dsp.dataset_presenter_id = dsnt.dataset_presenter_id (+)
            and dsc.is_primary_contact = 1
            and dsnt.taxon_id = tn.taxon_id (+)
            and tn.name_class (+) = 'scientific name'
 ]]>
            </sql>
      </sqlQuery>

           


      <sqlQuery name="Organisms"  isCacheable="false">
        <column name="dataset_id"/>
        <column name="organisms"/>
        <column name="organism_prefix"/>
            <sql>
            <![CDATA[

          select dataset_id,
                  case when organism_count = 1 and organisms is not null and expects_multiple = 0
                       then '<i>' || substr(organisms, 1, 1) || '.' ||
                                     substr(organisms, first_space, decode(second_space, 0, length(organisms) + 1, second_space) - first_space) || '</i>' ||
                                     substr(organisms, decode(second_space, 0, length(organisms) + 1, second_space))
                       else '' end as organism_prefix,
                       organisms
           from (
           select dsp.dataset_presenter_id as dataset_id,
                     listagg(tn.name, ', ') within group (order by tn.name) as organisms,
                     instr(listagg(tn.name, ', ') within group (order by tn.name), ' ', 1, 1) as first_space,
                     instr(listagg(tn.name, ', ') within group (order by tn.name), ' ', 1, 2) as second_space,
                     count(*) as organism_count,
                     -- if the dataset_name_pattern starts w/ a % we won't append an organism prefix to the datasetDisplayName
                     case when substr(dsp.dataset_name_pattern, 0, 1) = '%'
                      then 1
                      else 0
                      end as expects_multiple
            from apidbtuning.datasetpresenter dsp,apidbtuning.datasetnametaxon dsnt, sres.taxonname tn
            where dsp.dataset_presenter_id = dsnt.dataset_presenter_id (+)
            and dsnt.taxon_id = tn.taxon_id (+)
            and tn.name_class (+) = 'scientific name'
            group by dsp.dataset_presenter_id, dsp.dataset_name_pattern
            )
            ]]>
            </sql>
      </sqlQuery>

    </querySet>

      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Table queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetTables" queryType="table" 
              isCacheable='false'
              includeProjects="HostDB,InitDB,FungiDB,PiroplasmaDB,PlasmoDB,CryptoDB,MicrosporidiaDB,ToxoDB,GiardiaDB,AmoebaDB,TriTrypDB">

      <sqlQuery name="Publications"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="pmid"/>
            <column name="citation"/>
            <sql>
            <![CDATA[
             select dataset_presenter_id as dataset_id, pmid, citation from apidbtuning.datasetpublication where pmid is not null
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="Contacts"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="contact_name"/>
            <column name="affiliation"/>
            <sql>
            <![CDATA[
                     select dsp.name as dataset_name, dsp.dataset_presenter_id as dataset_id, dsc.name as contact_name, dsc.affiliation
                     from apidbtuning.datasetpresenter dsp, apidbtuning.datasetcontact dsc
                     where dsp.dataset_presenter_id = dsc.dataset_presenter_id
                     order by dsc.is_primary_contact desc
            ]]>
            </sql>
        </sqlQuery>



      <sqlQuery name="Isolates"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="source_id"/>
            <column name="strain"/>
            <column name="contact_name"/>
            <sql>
            <![CDATA[
                     select ia.source_id, 
                     ia.project_id, 
                     ds.name as dataset_name, 
                     iads.dataset_presenter_id as dataset_id,
                     ia.strain, 
                     listagg(iac.name, ',') within group (order by iac.name) as contact_name
                     from study.study s, apidb.datasource ds,
                     sres.externaldatabase d, sres.externaldatabaserelease r,
                     rad.studybiomaterial sb, apidbtuning.isolateattributes ia,
                     apidbtuning.datasetnametaxon iads,
                     apidbtuning.datasetcontact iac
                     where s.external_database_release_id = r.external_database_release_id
                     and r.external_database_id = d.external_database_id
                     and ds.name = d.name
                     and ds.version = r.version
                     and s.study_id = sb.study_id
                     and sb.bio_material_id = ia.bio_material_id
                     and ia.external_db_name = iads.name
                     and iads.dataset_presenter_id = iac.dataset_presenter_id (+)
                     group by iads.dataset_presenter_id,ia.source_id, ia.project_id, ds.name, ia.strain
            ]]>
            </sql>
        </sqlQuery>



      <sqlQuery name="HyperLinks"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="text"/>
            <column name="url"/>
            <sql>
            <![CDATA[
                     select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, nvl(ln.text, ln.url) as text, ln.url
                     from apidbtuning.datasethyperlink ln, apidbtuning.datasetpresenter dsp
                     where dsp.dataset_presenter_id = ln.dataset_presenter_id
                     and url is not null
            ]]>
            </sql>
        </sqlQuery>


      <sqlQuery name="References"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="record_type"/>
            <column name="target_type"/>
            <column name="target_name"/>
            <sql>
            <![CDATA[
                     select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, ref.record_type, ref.target_type, 
                     replace (ref.target_name, ':', '') as target_name
                     from apidbtuning.datasetmodelref ref, apidbtuning.datasetpresenter dsp
                     where dsp.dataset_presenter_id = ref.dataset_presenter_id
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="Version"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="organism"/>
            <column name="version"/>
            <sql>
            <![CDATA[
                    with TaxonScientificName as (
                    select taxon_id,name
                    from sres.taxonname where 
                    name_class = 'scientific name')
                    select dataset_name, dataset_id,organism, version from (
                      select distinct dnt.name as dataset_name, 
                           dnt.dataset_presenter_id as dataset_id,  
                           case when dnt.taxon_id = 0
                           then 'ALL' 
                           else tn.name 
                           end as organism,
                           ds.version as version
                      from TaxonScientificName tn, apidbtuning.DatasetNameTaxon dnt, 
                          apidb.datasource ds
                      where dnt.taxon_id = tn.taxon_id(+)
                      and   ds.name = dnt.name
                      order by dnt.name
                    )

            ]]>
            </sql>
        </sqlQuery>

    </querySet>

</wdkModel>
