<wdkModel>

  <recordClassSet name="DatasetRecordClasses" excludeProjects="TrichDB">

   <recordClass name="DatasetRecordClass" displayName="Dataset">

     <testParamValues >
       <paramValue name="dataset_id">1</paramValue>
     </testParamValues>


      <!-- primary key definition
           NOTE:  the name here is from apidbtuning.datasetpresenter NOT apidb.datasource
      -->
      <primaryKeyAttribute name="primary_key"
                           displayName="Dataset ID">
          <columnRef>dataset_id</columnRef>
          <text>
              <![CDATA[
                   $$dataset_id$$
               ]]>
           </text>                
      </primaryKeyAttribute>


      <!-- =============================================================== -->
      <!--   Reporters -->  
      <!-- =============================================================== -->

          <reporter name="tabular" displayName="Summary - tab delimited"
                    implementation="org.gusdb.wdk.model.report.TabularReporter"/>

      <!-- =============================================================== -->
      <!--   Filters -->
      <!-- =============================================================== -->


      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->
       <attributeQueryRef ref="DatasetAttributes.All">
         <columnAttribute name="dataset_id" internal="true" inReportMaker="false"/>
         <columnAttribute name="dataset_name" internal="true" inReportMaker="false"/>
         <columnAttribute name="dataset_name_pattern" internal="true" inReportMaker="false"/>
         <columnAttribute name="display_name_piece" internal="true"/>
         <columnAttribute name="short_display_name" internal="true"/>
         <columnAttribute name="description"/>
         <columnAttribute name="summary"/>
         <columnAttribute name="protocol"/>
         <columnAttribute name="usage"/>         
         <columnAttribute name="caveat"/>
         <columnAttribute name="acknowledgement"/>
         <columnAttribute name="release_policy"/>
         <columnAttribute name="type" internal="true"/>
         <columnAttribute name="subtype" internal="true"/> 
         <columnAttribute name="is_species_scope" internal="true"/> 
         <columnAttribute name="build_number_introduced" internal="true"/> 
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.Contacts">
         <columnAttribute name="contact"/>
         <columnAttribute name="institution"/>
         <columnAttribute name="short_attribution"/>
       </attributeQueryRef>
	   
       <attributeQueryRef ref="DatasetAttributes.Category">
         <columnAttribute name="category" internal="true" inReportMaker="false"/>
       </attributeQueryRef>

       <attributeQueryRef ref="DatasetAttributes.Organisms">
         <columnAttribute name="organisms"/>
         <columnAttribute name="organism_prefix"/>
       </attributeQueryRef>




            <textAttribute name="display_name" displayName="Display Name" help="Dataset Display Name">
             <display>
                  <![CDATA[
                           <i>$$organism_prefix$$</i> $$display_name_piece$$
                  ]]>
              </display>
              <text>
                  <![CDATA[
                           $$organism_prefix$$ $$display_name_piece$$
                  ]]>
              </text>
            </textAttribute>



     <!-- =================================================================== -->
     <!-- Tables ++++++++-->
     <!-- =================================================================== -->


      <table name="ExampleGraphs"
	     displayName="Internal Example Graphs"
	     queryRef="DatasetTables.ExampleGraphs" inReportMaker="false">
	<columnAttribute displayName="source_id" name="source_id"/>
	<columnAttribute displayName="project_id" name="project_id"/>
	<columnAttribute displayName="graph_ids" name="graph_ids"/>
	<columnAttribute displayName="module" name="module"/>
	<columnAttribute displayName="species" name="species"/>
	<columnAttribute displayName="mainOpen" name="mainOpen"/>
	<columnAttribute displayName="dataOpen" name="dataOpen"/>
	<columnAttribute displayName="display_name" name="display_name"/>
	<columnAttribute displayName="description" name="description"/>
	<columnAttribute displayName="x_axis" name="x_axis"/>
	<columnAttribute displayName="y_axis" name="y_axis"/>
	<columnAttribute displayName="visible_parts" name="visible_parts"/>
	<columnAttribute displayName="has_graph_data" name="has_graph_data"/>
	<columnAttribute displayName="has_meta_data" name="has_meta_data"/>
	<columnAttribute displayName="dataset_name" name="dataset_name"/>
	<columnAttribute displayName="is_graph_custom" name="is_graph_custom"/>
	<propertyList name="excludeFromDumper"><value>true</value></propertyList>
      </table>



        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Contacts -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Contacts"
               displayName="Principal Investigator and Collaborators"
               queryRef="DatasetTables.Contacts">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="contact_name" displayName="Principal investigator"/>
            <columnAttribute name="affiliation" displayName="Affiliation"/>
        </table>  

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Isolates / Samples -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Isolates"
               displayName="Isolates / Samples"
               queryRef="DatasetTables.Isolates">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="source_id" inReportMaker="true" internal="true"/>
            <columnAttribute name="strain" inReportMaker="true" internal="true"/>
            <columnAttribute name="contact_name" inReportMaker="true" internal="true"/>
            <linkAttribute name="isolate_link" inReportMaker="false" internal="false"
                           displayName="Isolate Source Id">

                 <displayText>
                    <![CDATA[
                    $$source_id$$ - ($$strain$$) $$contact_name$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                      /a/showRecord.do?name=IsolateRecordClasses.IsolateRecordClass&project_id=@PROJECT_ID@&source_id=$$source_id$$
                    ]]>
                 </url>
            </linkAttribute>
        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Publications -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Publications"
               displayName="Associated Publications"
               queryRef="DatasetTables.Publications">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="pmid" displayName="Pubmed ID" internal="true"/>
            <columnAttribute name="citation"/>


            <linkAttribute name="pubmed_link" inReportMaker="false" internal="false"
                           displayName="PubMed Link">

                 <displayText>
                    <![CDATA[
                    $$citation$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                             http://www.ncbi.nlm.nih.gov/pubmed/$$pmid$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>  


        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- External Links -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="HyperLinks"
               displayName="Links"
               queryRef="DatasetTables.HyperLinks">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="text" displayName="Description"/>
            <columnAttribute name="url" displayName="Hyperlink" internal="true"/>

            <columnAttribute name="description" displayName="description" internal="true"/>


            <linkAttribute name="hyper_link" inReportMaker="false" internal="false"
                           displayName="HyperLink">

                 <displayText>
                    <![CDATA[
                    $$text$$
                    ]]>
                 </displayText>
                 <url>
                    <![CDATA[
                          $$url$$
                    ]]>
                 </url>
            </linkAttribute>


        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- History -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="History"
               displayName="Release History"
               queryRef="DatasetTables.History">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="build" displayName="EuPathDB Build #"/>
            <columnAttribute name="date" displayName="Date"/>
            <columnAttribute name="note" displayName="Note"/>
        </table>  

        <table name="GenomeHistory"
               displayName="Release History"
               queryRef="DatasetTables.GenomeHistory">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="build" displayName="EuPathDB Build #"/>
            <columnAttribute name="date" displayName="Date"/>
            <columnAttribute name="genome_source" displayName="Genome Source"/>
            <columnAttribute name="genome_version" displayName="Genome Version"/>
            <columnAttribute name="annotation_source" displayName="Annotation Source"/>
            <columnAttribute name="annotation_version" displayName="Annotation Version"/>
            <columnAttribute name="note" displayName="Note"/>
        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- References -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="References"
               displayName="Searches using these data"
               queryRef="DatasetTables.References">
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="record_type"/>
            <columnAttribute name="target_type"/>
            <columnAttribute name="target_name"/>
        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Version   -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <table name="Version"
               displayName="Version"
               queryRef="DatasetTables.Version">
            <columnAttribute name="dataset_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="dataset_id"  inReportMaker="false" internal="true"/>
            <columnAttribute name="organism"/>
            <columnAttribute name="version"/>
        </table>  
        
      </recordClass>
    </recordClassSet>



      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetAttributes" queryType="attribute" doNotTest="true"  
              isCacheable='false'
              excludeProjects="TrichDB">

      <testRowCountSql>
select count(*) from apidbtuning.datasetpresenter
       </testRowCountSql>

       <sqlQuery name="Category" isCacheable="false">
         <column name="category"/>
         <column name="dataset_id"/>
         <sql>
           <![CDATA[
                   select distinct dsp.dataset_presenter_id as dataset_id, 
                           nvl(dsp.display_category, 
                               decode(dsp.type,
                                      'epitope', 'Genomes and Annotation',
                                      'dbxref', 'External Links',
                                      'isolates', 'Population Biology',
                                      'organellar_genome', 'Genomes and Annotation',
                                      'genome', 'Genomes and Annotation',
                                      'EST', 'Transcript Expression',
                                      'alias', 'Genomes and Annotation',
                                      'gene_annotation', 'Genomes and Annotation',
                                      'aligned_sequence', 'Miscellaneous',
                                      'orthology', 'Taxonomy and Phylogeny',
                                      'function', 'Function',
                                      'external_sequences', 'External Sequences',
                                      'feature', 'Miscellaneous',
                                      'sres', 'Ontology',
                                      'transcript_expression', 'Transcript Expression',
                                      'transcript_expression_platform', 'Transcript Expression',
                                      'protein_expression', 'Protein Expression',
                                      'isolates', 'Population Biology',
                                      'SNP', 'Population Biology',
                                      null)
                                      ) as category
                    from apidbtuning.datasetpresenter dsp
                  ]]>
            </sql>
       </sqlQuery>


      <sqlQuery name="All"  isCacheable="false">
	    <column name="dataset_id"/>
		<column name="dataset_name"/>
                <column name="dataset_name_pattern"/>
		<column name="display_name_piece"/>
		<column name="short_display_name"/>
		<column name="description"/>
		<column name="summary"/>
		<column name="protocol"/>
		<column name="usage"/>
		<column name="caveat"/>
		<column name="acknowledgement"/> 
		<column name="release_policy"/>
		<column name="type"/>
		<column name="subtype"/>
		<column name="is_species_scope"/>
		<column name="build_number_introduced"/>
            <sql>
            <![CDATA[
			            select dsp.dataset_presenter_id as dataset_id,
                   dsp.name as dataset_name,
                   dsp.dataset_name_pattern,
                   dsp.display_name as display_name_piece,
                   dsp.short_display_name,
                   dsp.description,
                   nvl(dsp.summary, dsp.description) as summary,
                   dsp.protocol,
                   dsp.usage,
                   dsp.caveat,
                   dsp.acknowledgement, 
                   dsp.release_policy,
                   dsp.type,
                   dsp.subtype,
                   dsp.is_species_scope,
                   dsp.build_number_introduced
            from apidbtuning.datasetpresenter dsp
                  ]]>
            </sql>
      </sqlQuery>



      <sqlQuery name="Contacts"  isCacheable="false">
	    <column name="dataset_id"/>
		<column name="contact"/>
        <column name="institution"/>
        <column name="short_attribution"/>
            <sql>
            <![CDATA[	  
			            select distinct dsp.dataset_presenter_id as dataset_id,
                   CASE WHEN  dsc.name is not null THEN dsc.name
                        WHEN dsc.affiliation is not null THEN dsc.affiliation
                        ELSE '<a href="http://eupathdb.org/eupathdb/contact.do" class="new-window" data-name="contact_us">Contact EuPathDB for more details</a>' 
                   END as contact,
                    CASE WHEN  (dsc.name is null and dsc.affiliation is not null) THEN dsc.name
                        ELSE   dsc.affiliation END as institution,
                    nvl(dsp.short_attribution, dsc.name) as short_attribution
            from apidbtuning.datasetpresenter dsp, apidbtuning.datasetcontact dsc
            where dsp.dataset_presenter_id = dsc.dataset_presenter_id (+)
            and dsc.is_primary_contact = 1
 ]]>
            </sql>
      </sqlQuery>

           


      <sqlQuery name="Organisms"  isCacheable="false">
        <column name="dataset_id"/>
        <column name="organisms"/>
        <column name="organism_prefix"/>

            <sql excludeProjects="EuPathDB">
            <![CDATA[

          select dataset_id,
                  case when organism_count = 1 and organisms is not null and expects_multiple = 0
                       then '<i>' || substr(organisms, 1, 1) || '.' ||
                                     substr(organisms, first_space, decode(second_space, 0, length(organisms) + 1, second_space) - first_space) || '</i>' ||
                                     substr(organisms, decode(second_space, 0, length(organisms) + 1, second_space))
                       else '' end as organism_prefix,
                       organisms
           from (
           select dsp.dataset_presenter_id as dataset_id,
                     listagg(tn.name, ', ') within group (order by tn.name) as organisms,
                     instr(listagg(tn.name, ', ') within group (order by tn.name), ' ', 1, 1) as first_space,
                     instr(listagg(tn.name, ', ') within group (order by tn.name), ' ', 1, 2) as second_space,
                     count(*) as organism_count,
                     -- if the dataset_name_pattern starts w/ a % we won't append an organism prefix to the datasetDisplayName
                     case when substr(dsp.dataset_name_pattern, 0, 1) = '%'
                      then 1
                      else 0
                      end as expects_multiple
            from apidbtuning.datasetpresenter dsp,apidbtuning.datasetnametaxon dsnt, sres.taxonname tn
            where dsp.dataset_presenter_id = dsnt.dataset_presenter_id (+)
            and dsnt.taxon_id = tn.taxon_id (+)
            and tn.name_class (+) = 'scientific name'
            group by dsp.dataset_presenter_id, dsp.dataset_name_pattern
            )
            ]]>
            </sql>

           <sql includeProjects="EuPathDB">
            <![CDATA[
        select dataset_id,
                  case when organism_count = 1 and organisms is not null and expects_multiple = 0
                       then '<i>' || substr(organisms, 1, 1) || '.' ||
                                     substr(organisms, first_space, decode(second_space, 0, length(organisms) + 1, second_space) - first_space) || '</i>' ||
                                     substr(organisms, decode(second_space, 0, length(organisms) + 1, second_space))
                       else '' end as organism_prefix,
                       organisms
           from (
           select dsp.dataset_presenter_id as dataset_id,
                     listagg(oa.organism_name, ', ') within group (order by oa.organism_name) as organisms,
                     instr(listagg(oa.organism_name, ', ') within group (order by oa.organism_name), ' ', 1, 1) as first_space,
                     instr(listagg(oa.organism_name, ', ') within group (order by oa.organism_name), ' ', 1, 2) as second_space,
                     count(*) as organism_count,
                     -- if the dataset_name_pattern starts w/ a % we won't append an organism prefix to the datasetDisplayName
                     case when substr(dsp.dataset_name_pattern, 0, 1) = '%'
                      then 1
                      else 0
                      end as expects_multiple
            from apidbtuning.datasetpresenter dsp,apidbtuning.datasetnametaxon dsnt, apidb.datasource ds, apidbtuning.organismattributes oa
            where dsp.dataset_presenter_id = dsnt.dataset_presenter_id (+)
            and dsnt.name = ds.name (+)
            and ds.taxon_id = oa.component_taxon_id (+)
            and ds.project_id = oa.project_id (+)
            group by dsp.dataset_presenter_id, dsp.dataset_name_pattern              
            )
            ]]>
            </sql>
      </sqlQuery>

    </querySet>

      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Table queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DatasetTables" queryType="table" 
              isCacheable='false'
              excludeProjects="TrichDB">

      <sqlQuery name="Publications"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="pmid"/>
            <column name="citation"/>
            <sql>
            <![CDATA[
             select dataset_presenter_id as dataset_id, pmid, citation from apidbtuning.datasetpublication where pmid is not null
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="History"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="build"/>
            <column name="date"/>
            <column name="note"/>
            <sql>
            <![CDATA[
             select dataset_presenter_id as dataset_id, build_number, 'unknown' as date, note from apidbtuning.datasethistory
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="GenomeHistory"  isCacheable='false'>
            <column name="dataset_id"/>
            <column name="build"/>
            <column name="date"/>
            <column name="genome_source"/>
            <column name="genome_version"/>
            <column name="annotation_source"/>
            <column name="annotation_version"/>
            <column name="note"/>
            <sql>
            <![CDATA[
             select dataset_presenter_id as dataset_id, build_number, 'unknown' as date, genome_source, genome_version, annotation_source, annotation_version, note from apidbtuning.datasethistory
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="Contacts"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="contact_name"/>
            <column name="affiliation"/>
            <sql>
            <![CDATA[
                     select dsp.name as dataset_name, dsp.dataset_presenter_id as dataset_id, dsc.name as contact_name, dsc.affiliation
                     from apidbtuning.datasetpresenter dsp, apidbtuning.datasetcontact dsc
                     where dsp.dataset_presenter_id = dsc.dataset_presenter_id
                     order by dsc.is_primary_contact desc
            ]]>
            </sql>
        </sqlQuery>



      <sqlQuery name="Isolates"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="source_id"/>
            <column name="strain"/>
            <column name="contact_name"/>
            <sql excludeProjects="EuPathDB">
            <![CDATA[
                     select ia.source_id, 
                     ia.project_id, 
                     ds.name as dataset_name, 
                     iads.dataset_presenter_id as dataset_id,
                     ia.strain, 
                     listagg(iac.name, ',') within group (order by iac.name) as contact_name
                     from study.study s, apidb.datasource ds,
                     sres.externaldatabase d, sres.externaldatabaserelease r,
                     rad.studybiomaterial sb, apidbtuning.isolateattributes ia,
                     apidbtuning.datasetnametaxon iads,
                     apidbtuning.datasetcontact iac
                     where s.external_database_release_id = r.external_database_release_id
                     and r.external_database_id = d.external_database_id
                     and ds.name = d.name
                     and ds.version = r.version
                     and s.study_id = sb.study_id
                     and sb.bio_material_id = ia.bio_material_id
                     and ia.external_db_name = iads.name
                     and iads.dataset_presenter_id = iac.dataset_presenter_id (+)
                     group by iads.dataset_presenter_id,ia.source_id, ia.project_id, ds.name, ia.strain
            ]]>
            </sql>
            <sql includeProjects="EuPathDB">
            <![CDATA[
                     select '' as source_id, 
                     '' as project_id, 
                     name as dataset_name, 
                     dataset_presenter_id as dataset_id,
                     '' as strain, 
                     '' as  contact_name
                     from apidbtuning.datasetpresenter ds
                     where ds.name = 'no isolates for portal'
            ]]>
            </sql>

        </sqlQuery>



      <sqlQuery name="HyperLinks"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="text"/>
            <column name="url"/>
            <column name="description"/>
            <sql excludeProjects="EuPathDB">
            <![CDATA[
with sequences as (
select sa.source_id, 
       sa.taxon_id,
       row_number() over(partition by sa.taxon_id
                         order by sa.chromosome_order_num, sa.length desc) as rn
from apidbtuning.sequenceattributes sa
where sa.is_top_level = 1),
proteomicsgenes as (
select ga.source_id, 
       d.name, 
       row_number() over(partition by d.name
                         order by mss.aa_seq_percent_covered desc) as rn
from APIDB.massspecsummary mss, apidbtuning.geneattributes ga,
     SRES.externaldatabase d, SRES.externaldatabaserelease r
where mss.external_database_release_id = r.external_database_release_id
and r.external_database_id = d.external_database_id
and mss.aa_sequence_id = ga.aa_sequence_id
)
-- MAIN QUERY STARTS HERE
 -- first query handles genomes... replace needed macros
select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, 
       nvl(hl.text, hl.url) as text,
       hl.description,
       replace(replace(replace(replace(hl.url, 'DEFAULT_PROJECT', '@PROJECT_ID@'), 'DEFAULT_LC_PROJECT', lower('@PROJECT_ID@')), 'DEFAULT_SEQUENCE', def_seq.source_id), 'ORGANISM_PK', def_seq.organismpk) as url
from (select dsp.dataset_presenter_id, os.source_id, oa.source_id as organismpk
      from apidbtuning.datasetpresenter dsp, apidbtuning.datasetnametaxon nt, apidbtuning.organismattributes oa, sequences os
      where dsp.dataset_presenter_id = nt.dataset_presenter_id
      and nt.taxon_id = os.taxon_id
      and nt.taxon_id = oa.component_taxon_id
      and os.rn = 1 
      ) def_seq,
      apidbtuning.datasetpresenter dsp, apidbtuning.datasethyperlink hl
where dsp.dataset_presenter_id = def_seq.dataset_presenter_id (+)
and dsp.dataset_presenter_id = hl.dataset_presenter_id (+)
and dsp.type = 'genome'
and hl.url is not null
UNION
 -- this query handles proteomics... replace needed macros
select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, 
       nvl(hl.text, hl.url) as text,
       hl.description,
       replace(replace(replace(replace(hl.url, 'DEFAULT_LC_PROJECT', lower('@PROJECT_ID@')), 'DEFAULT_PROTEOMICS_GENE', def_prot.source_id),'DEFAULT_DATASET', dsp.name), 'DEFAULT_PROJECT', '@PROJECT_ID@') as url
from (select dsp.dataset_presenter_id, pg.source_id
      from apidbtuning.datasetpresenter dsp, apidbtuning.datasetnametaxon dsnt, proteomicsgenes pg
      where pg.name = dsnt.name
      and pg.rn = 1
      and dsnt.dataset_presenter_id = dsp.dataset_presenter_id
      ) def_prot,
      apidbtuning.datasetpresenter dsp, apidbtuning.datasethyperlink hl
where dsp.dataset_presenter_id = def_prot.dataset_presenter_id (+)
and dsp.dataset_presenter_id = hl.dataset_presenter_id (+)
and dsp.type = 'protein_expression'
and dsp.subtype is null
and hl.url is not null
and ((hl.url like '%DEFAULT_PROTEOMICS_GENE%' and def_prot.source_id is not null)
     or (hl.url not like '%DEFAULT_PROTEOMICS_GENE%'))
UNION
-- Get the RNASeq Ones
select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, 
       nvl(hl.text, hl.url) as text,
       hl.description,
       replace(replace(replace(replace(hl.url, 'DEFAULT_LC_PROJECT', lower('@PROJECT_ID@')), 'DEFAULT_RNASEQ_GENE', esi.example_source_id),'DEFAULT_DATASET', dsp.name), 'DEFAULT_PROJECT', '@PROJECT_ID@') as url
from APIDBTUNING.datasetexamplesourceid esi,
      apidbtuning.datasetpresenter dsp, apidbtuning.datasethyperlink hl,
      apidbtuning.datasetnametaxon dnt
where dsp.dataset_presenter_id = hl.dataset_presenter_id (+)
and dsp.dataset_presenter_id = dnt.dataset_presenter_id (+)
and esi.dataset = dnt.name
and dsp.type = 'transcript_expression'
and dsp.subtype = 'rnaseq'
and hl.url is not null
and ((hl.url like '%DEFAULT_RNASEQ_GENE%' and esi.example_source_id is not null)
     or (hl.url not like '%DEFAULT_RNASEQ_GENE%'))
UNION
 -- Get the remaining ones
select dataset_id, dataset_name, text, description, url 
from (select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, nvl(ln.text, ln.url) as text, ln.url, ln.description
      from apidbtuning.datasethyperlink ln, apidbtuning.datasetpresenter dsp
      where dsp.dataset_presenter_id = ln.dataset_presenter_id
      minus
      select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, nvl(ln.text, ln.url) as text, ln.url, ln.description
      from apidbtuning.datasethyperlink ln, apidbtuning.datasetpresenter dsp
      where dsp.dataset_presenter_id = ln.dataset_presenter_id
      and ((dsp.type = 'genome')
        OR (dsp.type = 'protein_expression' and subtype is null)
        OR (dsp.type = 'transcript_expression' and subtype = 'rnaseq')
        )
      )
where url is not null
            ]]>
            </sql>

            <sql includeProjects="EuPathDB">
select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, hl.text, hl.url, hl.description
from apidbtuning.datasetpresenter dsp, apidbtuning.datasethyperlink hl
where dsp.dataset_presenter_id = hl.dataset_presenter_id
            </sql>

        </sqlQuery>


      <sqlQuery name="References"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="record_type"/>
            <column name="target_type"/>
            <column name="target_name"/>
            <sql>
            <![CDATA[
                     select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, ref.record_type, ref.target_type, 
                     replace (ref.target_name, ':', '') as target_name
                     from apidbtuning.datasetmodelref ref, apidbtuning.datasetpresenter dsp
                     where dsp.dataset_presenter_id = ref.dataset_presenter_id
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="Version"  isCacheable='false'>
            <column name="dataset_name"/>
            <column name="dataset_id"/>
            <column name="organism"/>
            <column name="version"/>
            <sql excludeProjects="EuPathDB">
            <![CDATA[
                    with TaxonScientificName as (
                    select taxon_id,name
                    from sres.taxonname where 
                    name_class = 'scientific name')
                    select dataset_name, dataset_id,organism, version from (
                      select distinct dnt.name as dataset_name, 
                           dnt.dataset_presenter_id as dataset_id,  
                           case when dnt.taxon_id = 0
                           then 'ALL' 
                           else tn.name 
                           end as organism,
                           ds.version as version
                      from TaxonScientificName tn, apidbtuning.DatasetNameTaxon dnt, 
                          apidb.datasource ds
                      where dnt.taxon_id = tn.taxon_id(+)
                      and   ds.name = dnt.name
                      order by dnt.name
                    )

            ]]>
            </sql>
            <sql includeProjects="EuPathDB">
              select dsp.dataset_presenter_id as dataset_id, dsp.name as dataset_name, '' as version, '' as organism
              from apidbtuning.datasetpresenter dsp
              where dsp.name = 'no version for portal'
            </sql>
        </sqlQuery>





       <sqlQuery name="ExampleGraphs">
            <column name="dataset_name" />
            <column name="dataset_id" />

            <column name="source_id" /> <!-- same as graphIds -->
            <column name="project_id" />
            <column name="graph_ids" /> <!-- some example source_id from apidb.profile -->
            <column name="module" />
            <column name="species"/> <!-- null -->
            <column name="mainOpen" />
            <column name="dataOpen" />
            <column name="display_name" />
            <column name="description" />
            <column name="x_axis" />
            <column name="y_axis" />
            <column name="visible_parts" />
            <column name="has_graph_data"/>
	    <column name="has_meta_data"/>
            <column name="is_graph_custom"/>


            <sql includeProjects="EuPathDB">
            <![CDATA[
                     select '' as source_id, 
                     '' as project_id, 
                     '' as graph_ids,
                     '' as module,
                     '' as species,
                     '' as mainOpen,
                     '' as dataOpen,
                     '' as display_name,
                     '' as description,
                     '' as x_axis,
                     '' as y_axis,
                     '' as visible_parts,
                     '' as has_graph_data,
                     '' as has_meta_data,
                     '' as is_graph_custom,
                     name as dataset_name, 
                     dataset_presenter_id as dataset_id
                     from apidbtuning.datasetpresenter ds
                     where ds.name = 'no graphs for portal'
            ]]>
            </sql>

            <sql excludeProjects="EuPathDB">
            <![CDATA[
select p.dataset as dataset_name, dnt.dataset_presenter_id as dataset_id,
       p.example_source_id as source_id, '@PROJECT_ID@' as project_id, p.example_source_id as graph_ids, '' as species,
       'true' as mainOpen, 'false' as dataOpen,
       graph_descrip.display_name, graph_descrip.description,
       graph_descrip.module, graph_descrip.x_axis, graph_descrip.y_axis,
       graph_descrip.visible_parts, graph_descrip.is_graph_custom,
       graph_descrip.order_num, '1' as has_graph_data, 'false' as has_meta_data
from (select '' as dataset,
       '' as display_name,
       '' as description,
       '' as module,
       '' as x_axis,
       '' y_axis,
       '' as visible_parts,
       '' as is_graph_custom,
       1 as order_num
       from dual
      -- TEMPLATE_ANCHOR datasetExampleGraphDescriptions
       ) graph_descrip, apidbtuning.datasetexamplesourceid p,
       apidbtuning.datasetnametaxon dnt
where p.dataset = graph_descrip.dataset
and graph_descrip.dataset = dnt.name
             ]]>
            </sql>
        </sqlQuery>



    </querySet>

</wdkModel>
