<wdkModel>
    <querySet name="SnpAttributes" queryType="attribute" includeProjects="PlasmoDB,ToxoDB,EuPathDB,CryptoDB">


      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">CombinedSNP.MAL11.3000</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="ToxoDB,EuPathDB">
         <paramValue name="source_id">SNP_VI_485196</paramValue>
         <paramValue name="project_id">ToxoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="CryptoDB">
         <paramValue name="source_id">chr3-2_66329</paramValue>
         <paramValue name="project_id">CryptoDB</paramValue>
      </defaultTestParamValues>


       <testRowCountSql excludeProjects="EuPathDB">
               select count(na_feature_id)
               from dots.SnpFeature
       </testRowCountSql>

       <testRowCountSql includeProjects="EuPathDB">
	 SELECT count(*) FROM apidb.SnpAttributes
       </testRowCountSql>


        <sqlQuery name="Bfmv">
            <column name="source_id" />
            <column name="project_id" />
            <column name="dataset" 
                    ignoreCase="true"/>
            <column name="dataset_hidden" 
                    sortingColumn="dataset" ignoreCase="true"/>
            <column name="seq_source_id"  sortingColumn="chromosome_order_num"/>
            <column name="start_min"  sortingColumn="start_min" />
            <column name="start_min_text"  sortingColumn="start_min" />
            <column name="chromosome_order_num"  sortingColumn="chromosome_order_num" />
            <column name="is_coding"  />
            <column name="position_in_CDS"  />
            <column name="position_in_protein"  />
            <column name="has_nonsynonymous_allele"  />
            <column name="gene_source_id"  ignoreCase="true"/>
            <column name="gene_strand"  />
            <column name="strains"   />
            <column name="strains_gene_strand"  sortingColumn="strains" ignoreCase="true"/>
            <column name="lflank"  ignoreCase="true"/>
            <column name="allele"  sortingColumn="reference_na" ignoreCase="true"/>
            <column name="rflank"  ignoreCase="true"/>
            <column name="lflank_gene_strand"  sortingColumn="lflank" ignoreCase="true"/>
            <column name="allele_gene_strand"  sortingColumn="allele" ignoreCase="true"/>
            <column name="rflank_gene_strand"  sortingColumn="rflank" ignoreCase="true"/>
            <column name="organism"  ignoreCase="true"/>
            <column name="formatted_organism"  sortingColumn="organism" />
            <column name="ncbi_tax_id"  />
            <column name="minor_allele_frequency"  />
            <column name="major_allele_frequency"  />
            <column name="strain_count"  />
            <column name="minor_product"  />
            <column name="major_product"  />
            <column name="minor_allele"  />
            <column name="major_allele"  />
            <column name="major_strains"  />
            <column name="minor_strains"  />
            <column name="reference_na"  />
            <column name="reference_aa"  />
            <column name="reference_strain"  />
            <sqlParamValue includeProjects="EuPathDB" name="datasets">
                 'Genomic Sequence SNPs', 'AmitAlignmentSnps',
                 'Genetic Markers - David Sibley', 'GeneticMarkers_Sibley',
                 'John Boothroyd lab at Stanford', 'ME49_SNPs',
                 'Lindstrom 454 SNPs', 'Lindstrom454Snps',
                 'WinzelerGeneticVariationArray_RSRC', 'WinzelerGeneticVariationArray',
                 'NIH SNPs', 'Su_SNPs',
                 'Pf_Broad_SNPs_RSRC', 'Broad_SNPs',
                 'sangerItGhanaSnps_RSRC', 'sangerItGhanaSnps',
                 'sangerPReichenowiSnps_RSRC', 'sangerReichenowiSnps',
                 'Pf_plasmoDbCombinedSnps_RSRC', 'plasmoDbCombinedSnps',
                 'Widmer SNPs', 'Widmer_SNPs'
            </sqlParamValue>
            <sqlParamValue includeProjects="PlasmoDB" name="datasets">
                 'NIH SNPs', 'Su_SNPs',
                 'Pf_Broad_SNPs_RSRC', 'Broad_SNPs',
                 'sangerItGhanaSnps_RSRC', 'sangerItGhanaSnps',
                 'sangerPReichenowiSnps_RSRC', 'sangerReichenowiSnps',
                 'Pf_plasmoDbCombinedSnps_RSRC', 'plasmoDbCombinedSnps',
                 'WinzelerGeneticVariationArray_RSRC', 'WinzelerGeneticVariationArray'
            </sqlParamValue>
            <sqlParamValue includeProjects="ToxoDB" name="datasets">
                 'Genomic Sequence SNPs', 'AmitAlignmentSnps',
                 'Genetic Markers - David Sibley', 'GeneticMarkers_Sibley',
                 'John Boothroyd lab at Stanford', 'ME49_SNPs',
                 'Lindstrom 454 SNPs', 'Lindstrom454Snps'
            </sqlParamValue>
            <sqlParamValue includeProjects="CryptoDB" name="datasets">
                'Widmer SNPs', 'Widmer_SNPs'
            </sqlParamValue>
            <sqlParamValue  name="dataset_display_names">
                 'Pf_plasmoDbCombinedSnps_RSRC', 'NIH, Broad, and Sanger SNPs'
            </sqlParamValue>
            <sql>
            <![CDATA[
           SELECT bfmv.source_id, bfmv.project_id, bfmv.chromosome_order_num,
                  DECODE(bfmv.dataset, &&dataset_display_names&&, bfmv.dataset) AS dataset,
                  DECODE(bfmv.dataset, &&datasets&&, bfmv.dataset) AS dataset_hidden,
                  bfmv.seq_source_id, bfmv.start_min, 
                  CASE
                  WHEN bfmv.reference_strain = 'iowa_II' THEN 'IOWA II'
                  WHEN bfmv.reference_strain = 'md' THEN 'MD'
                  WHEN bfmv.reference_strain = 'tu114' THEN 'TU114'
                  ELSE bfmv.reference_strain
                  END as reference_strain,
                  bfmv.reference_na, bfmv.is_coding, bfmv.position_in_CDS,
                  bfmv.position_in_protein, bfmv.reference_aa, bfmv.has_nonsynonymous_allele,
                  bfmv.gene_source_id, bfmv.gene_strand, bfmv.lflank,
                  bfmv.rflank, bfmv.reference_na as allele, bfmv.organism, bfmv.ncbi_tax_id,
                  '<i>' || SUBSTR(bfmv.organism, 1, 1) || '.' ||
                  REGEXP_REPLACE(SUBSTR(bfmv.organism, INSTR(bfmv.organism, ' ')), '[[:space:]]+',
                                 chr(38) || 'nbsp;') || '</i>'
                    AS formatted_organism,
                  bfmv.minor_allele_frequency, bfmv.major_allele_frequency,
                  bfmv.strain_count,bfmv.minor_product,bfmv.major_strains,bfmv.minor_strains,
                  bfmv.major_product,bfmv.major_allele,bfmv.minor_allele,bfmv.strains,bfmv.strains_revcomp,
                  trim(to_char(bfmv.start_min,'99,999,999')) as start_min_text,
                  CASE WHEN bfmv.gene_strand = 'reverse' THEN apidb.reverse_complement(bfmv.rflank) 
                       WHEN bfmv.gene_strand is null THEN ''
                       ELSE bfmv.lflank  END as lflank_gene_strand,
                  CASE WHEN bfmv.gene_strand = 'reverse' THEN apidb.reverse_complement(bfmv.lflank) 
                       WHEN bfmv.gene_strand is null THEN ''
                       ELSE bfmv.rflank  END as rflank_gene_strand,
                  CASE WHEN bfmv.gene_strand = 'reverse' THEN apidb.reverse_complement(bfmv.reference_na) 
                       WHEN bfmv.gene_strand is null THEN ''
                       ELSE bfmv.reference_na END as allele_gene_strand,
                  CASE WHEN bfmv.gene_strand = 'reverse' THEN bfmv.strains_revcomp 
                       WHEN bfmv.gene_strand is null THEN ''
                       ELSE bfmv.strains END as strains_gene_strand
       FROM   apidb.SnpAttributes bfmv
             ]]>
           </sql>
        </sqlQuery>

<!--
       <sqlQuery name="isolateSummary" isCacheable="false" includeProjects="PlasmoDB">
            <column name="source_id" />
            <column name="project_id" />
            <column name="iso_major_allele"/>
            <column name="iso_major_percent"/>
            <column name="iso_minor_allele"/>
            <column name="iso_minor_percent"/>
            <column name="iso_number_strains"/>
            <sql>
            <![CDATA[    
               select snp_source_id as source_id, '@PROJECT_ID@' as project_id,
                 major_allele as iso_major_allele,
                 round((to_number(major_count) / total),2) as iso_major_percent,
                 minor_allele as iso_minor_allele,
                 round((to_number(minor_count) / total),2) as iso_minor_percent,
                 total as iso_number_strains
               from (
               select snp_source_id,
                apidb.tab_to_string(CAST(COLLECT(CASE WHEN row_number = 1 THEN allele END) AS apidb.varchartab), ', ') as major_allele,
                apidb.tab_to_string(CAST(COLLECT(CASE WHEN row_number = 1 THEN to_char(ct) END) AS apidb.varchartab), ', ') as major_count,
                apidb.tab_to_string(CAST(COLLECT(CASE WHEN row_number = 2 THEN allele END) AS apidb.varchartab), ', ') as minor_allele,
                apidb.tab_to_string(CAST(COLLECT(CASE WHEN row_number = 2 THEN to_char(ct) END) AS apidb.varchartab), ', ') as minor_count,
                sum(ct) as total
               from (
               select rownum as row_number,snp_source_id,allele,ct from (
               select snp_source_id,allele,count(*) as ct
               from apidb.ISOLATESNPS
               where  allele in ('A','C','G','T')
               group by snp_source_id,allele
               order by ct desc))
               group by snp_source_id)
             ]]>
           </sql>
        </sqlQuery>
-->

        <sqlQuery name="Sequence" excludeProjects="EuPathDB">
            <column name="source_id" />
            <column name="project_id" />
            <column name="lflank"/>
            <column name="allele"/>
            <column name="rflank"/>
            <sql>
            <![CDATA[    
            select sf.source_id, '@PROJECT_ID@' AS project_id,
            SUBSTR(nas.sequence,l.start_min - 60,60) as lflank,
            SUBSTR(nas.sequence,l.start_min,1) as allele,
            SUBSTR(nas.sequence,l.start_min + 1,60) as rflank
            from  dots.nasequence nas, dots.snpfeature sf, dots.nalocation l
            where sf.na_sequence_id = nas.na_sequence_id
            and l.na_feature_id = sf.na_feature_id
             ]]>
           </sql>
        </sqlQuery>
    </querySet>
</wdkModel>
