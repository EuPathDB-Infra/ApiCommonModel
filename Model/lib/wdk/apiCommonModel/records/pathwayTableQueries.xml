<wdkModel>

  <querySet name="PathwayTables" queryType="table" isCacheable="false" excludeProjects="EuPathDB">

      <defaultTestParamValues>
         <paramValue name="source_id">ec00626</paramValue>
          <paramValue name="project_id">@PROJECT_ID@</paramValue>
      </defaultTestParamValues>


      <sqlQuery name="CompoundsFromMetabolicPathways" >
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="pathway_source"/> <!-- TODO -->
            <column name="substrates"/>
            <column name="enzyme"/>
            <column name="enzyme_link"/>
            <column name="reaction"/>
            <column name="products"/>
            <column name="direction"/>
            <sql>
            <![CDATA[
WITH enzy AS (SELECT DISTINCT ec.ec_number 
            FROM apidbtuning.transcriptAttributes gf,
                 dots.aaSequenceEnzymeClass asec, sres.enzymeClass ec
            WHERE asec.aa_sequence_id = gf.aa_sequence_id
              AND ec.enzyme_class_id = asec.enzyme_class_id)
SELECT  '@PROJECT_ID@' as project_id, pc1.pathway AS source_id, pc1.reaction, pc1.enzyme,
CASE WHEN pc1.enzyme IN (SELECT ec_number FROM enzy) 
 THEN '<a href="processQuestion.do?questionFullName=GeneQuestions.InternalGenesByEcNumber&organism=all&'  || 'array%28ec_source%29=all&' || 'array%28ec_number_pattern%29=N/A&ec_wildcard=' || pc1.enzyme || '&' || 'questionSubmit=Get+Answer'  || '">' || pc1.enzyme || '</a>'
              ELSE  pc1.enzyme   END AS enzyme_link, 
apidb.tab_to_string(SET(CAST(COLLECT( pc1.chebi_accession ) AS apidb.varchartab))) AS substrates,
apidb.tab_to_string(set(cast(COLLECT( pc2.chebi_accession ) AS apidb.varchartab))) AS products,
CASE WHEN pc1.TYPE = 'substrate/product' THEN  'reversible' ELSE 'irreversible' END as direction
FROM apidbtuning.pathwayCompounds pc1,  apidbtuning.pathwayCompounds pc2
WHERE pc1.pathway_id = pc2.pathway_id 
AND pc1.reaction = pc2.reaction
AND pc1.TYPE = 'substrate' AND pc2.TYPE = 'product'
GROUP BY pc1.pathway, pc1.enzyme, pc1.reaction, pc1.TYPE
ORDER BY pc1.enzyme
            ]]>
           </sql>
        </sqlQuery>

        <sqlQuery name="PathwayReactionsXrefs">
            <column name="project_id"/>
            <column name="source_id"/>
            <column name="pathway_source"/>
            <column name="alt_pathway_source_id"/>
            <column name="alt_pathway_source"/>
            <column name="alt_pathway_url"/>
            <column name="name"/>
            <column name="reaction_count"/>
            <column name="alt_reaction_count"/>
            <column name="pct"/>
            <column name="overlap_count"/>
            <sql>
                <![CDATA[
                    select tbl.* from (
                    with pathway_reaction as (select distinct  pathway_id,
                    pathway_reaction_id from apidb.pathwayreactionrel),
                      pathway_counts as (select pathway_id, count(*) as ct from
                    pathway_reaction group by pathway_id)
                    select
                       '@PROJECT_ID@' as project_id
                       , pa1.source_id
                       , pa1.pathway_source
                       , pa2.pathway_source as alt_pathway_source
                       , pa2.source_id as alt_pathway_source_id
                       --, pa2.url as alt_pathway_url
                       , pa2.name
                       , pc1.ct as reaction_count
                       , pc2.ct as alt_reaction_count
                       , case when pc1.ct < pc2.ct then count(*) / pc1.ct else count(*) /
                    pc2.ct end * 100 as pct
                       , count(*) as overlap_count
                    from apidbtuning.pathwayattributes pa1
                    , apidbtuning.pathwayattributes pa2
                    ,  pathway_reaction ap
                    ,  pathway_counts pc1
                    ,  pathway_counts pc2
                    ,(SELECT DISTINCT
                         pr.pathway_id
                       , prx.associated_reaction_id AS pathway_reaction_id
                       FROM
                         pathway_reaction pr
                       , apidb.pathwayreactionxref prx
                       WHERE
                         prx.pathway_reaction_id = pr.pathway_reaction_id
                       UNION
                       SELECT DISTINCT
                         pr.pathway_id
                       , pr.pathway_reaction_id
                       FROM
                         pathway_reaction pr
                       ) ax
                    WHERE
                       ap.pathway_reaction_id = ax.pathway_reaction_id
                       and pa1.pathway_id = ap.pathway_id
                       and pa2.pathway_id = ax.pathway_id
                       and pa1.pathway_id = pc1.pathway_id
                       and pa2.pathway_id = pc2.pathway_id
                       and pa1.pathway_id != pa2.pathway_id
                    HAVING count(*) >1
                    group by    pa1.source_id
                       , pa1.pathway_source
                       , pa2.source_id
                       , pa2.pathway_source
                       , pa2.name
                       , pc1.ct
                       , pc2.ct
                       --, pa2.url
                    ) tbl
                    order by tbl.pct desc
                ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="PathwayGraphs" >
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="pathway_source"/> 
            <column name="display_name"/>
            <column name="internal"/>
            <column name="xaxis_description"/>
            <sql>
            <![CDATA[
select pa.source_id, '@PROJECT_ID@' as project_id, pa.pathway_source,
       g.display_name, g.internal || '&template=' || decode(g.is_graph_custom, 'true', 0, 1) as internal, g.xaxis_description
from apidbtuning.pathwayattributes pa, (select '*** Default ***' as display_name, '' as internal, '' as is_graph_custom, '' as xaxis_description, '' as project_id from dual
      -- TEMPLATE_ANCHOR pathwayGraphs
) g
Where g.project_id = '@PROJECT_ID@'
AND NOT g.internal LIKE '%MassSpec%' 
            ]]>
           </sql>
        </sqlQuery>



      <sqlQuery name="ECNumberOrganismMap" >
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="pathway_source"/> <!-- TODO -->
            <column name="display_label"/>
            <column name="x1"/>
            <column name="y1"/>
            <column name="x2"/>
            <column name="y2"/>
            <column name="organisms"/>
            <column name="genes"/>

            <sql>
            <![CDATA[
               SELECT DISTINCT p.source_id as source_id, '@PROJECT_ID@' as project_id, ec.ec_number as display_label,
                       (pn.x - (pn.width/2)) as x1, (pn.y - (pn.height/2)) as y1,
                       (pn.x + (pn.width/2)) as x2, (pn.y + (pn.height/2)) as y2,
                       apidb.tab_to_string(set(cast(COLLECT(ga.organism) AS apidb.varchartab)), ', ') as organisms,
                       apidb.tab_to_string(set(cast(COLLECT(ga.source_id) AS apidb.varchartab)), ', ') as genes
                FROM    ApidbTuning.GenomicSeqAttributes gs,
                       sres.pathway p, sres.pathwaynode pn,
                       dots.aaSequenceEnzymeClass asec, sres.enzymeClass ec,ApidbTuning.TranscriptAttributes ga
                WHERE  gs.na_sequence_id = ga.na_sequence_id
                AND    ga.aa_sequence_id = asec.aa_sequence_id
                AND    asec.enzyme_class_id = ec.enzyme_class_id
                AND    p.pathway_id = pn.pathway_id
                AND    ec.ec_number = pn.display_label
                group by p.source_id, ec.ec_number, pn.x, pn.y,pn.width, pn.height
            ]]>
           </sql>
        </sqlQuery>

        <sqlQuery name="CompoundLabel" >
            <column name="source_id"/>
            <column name="pathway_source"/> <!-- TODO -->
            <column name="compound_source_id"/>
            <column name="project_id"/>
            <column name="display_label"/>
            <column name="x"/>
            <column name="y"/>
            <column name="radius"/>
            <sql>
              <![CDATA[
              Select p.source_id, pc.compound_source_id, '@PROJECT_ID@' as project_id,
                     pn.display_label, pn.x, pn.y, pn.height as radius 
              From   ApiDB.Pathway p, ApiDB.PathwayNode pn, ApiDBTuning.PathwayCompounds pc
              Where  p.pathway_id = pn.parent_id
              And    pn.pathway_node_type_id = 2
              AND    pn.display_label = pc.compound
              Group By p.source_id, pc.compound_source_id, pn.display_label, pn.x, pn.y, pn.height, pn.width
            ]]>
           </sql>
        </sqlQuery>

 </querySet>
</wdkModel>



