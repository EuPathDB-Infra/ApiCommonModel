<wdkModel>

  <recordClassSet name="DataSourceRecordClasses" includeProjects="InitDB,FungiDB,PiroplasmaDB,PlasmoDB,CryptoDB,MicrosporidiaDB">

   <recordClass name="DataSourceRecordClass" type="DataSource">

     <testParamValues>
       <paramValue name="data_source_name">NRDB_RSRC</paramValue>
       <paramValue name="project_id">@PROJECT_ID@</paramValue>
     </testParamValues>


      <!-- primary key definition -->
      <primaryKeyAttribute name="primary_key"
                           displayName="Data Source Id">
          <columnRef>data_source_name</columnRef>
          <columnRef>project_id</columnRef>
          <text>
              <![CDATA[
                   $$data_source_name$$
               ]]>
           </text>                
      </primaryKeyAttribute>


      <!-- =============================================================== -->
      <!--   Reporters -->  
      <!-- =============================================================== -->

          <reporter name="tabular" displayName="Summary - tab delimited"
                    implementation="org.gusdb.wdk.model.report.TabularReporter"/>

      <!-- =============================================================== -->
      <!--   Filters -->
      <!-- =============================================================== -->


      <!-- =================================================================== -->
      <!--  Text Attributes  ++++++++-->
      <!-- =================================================================== -->
       <attributeQueryRef ref="DataSourceAttributes.All">

         <columnAttribute name="data_source_name"  inReportMaker="false" internal="true"/>
         <columnAttribute name="display_name" displayName="Data Source" inReportMaker="false"/>
         <columnAttribute name="version" displayName="Version" inReportMaker="false"/>
         <columnAttribute name="public_url" displayName="URL" inReportMaker="false"/>
         <columnAttribute name="category" displayName="Category" inReportMaker="false"/>
         <columnAttribute name="organism" displayName="Organism" inReportMaker="false"/>
         <columnAttribute name="description" displayName="Description" inReportMaker="false"/>
         <columnAttribute name="summary" displayName="Summary" inReportMaker="false"/>
         <columnAttribute name="contact" displayName="Provider" inReportMaker="false"/>
         <columnAttribute name="institution" displayName="Institution" inReportMaker="false"/>
       </attributeQueryRef>

     <!-- =================================================================== -->
     <!-- Tables ++++++++-->
     <!-- =================================================================== -->

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Contacts -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Contacts"
               displayName="Associated contacts"
               queryRef="DataSourceTables.Contacts">
            <columnAttribute name="data_source_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="name" displayName="Name"/>
            <columnAttribute name="email" displayName="Email"/>
            <columnAttribute name="affiliation" displayName="Affiliation"/>
        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- Publications -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="Publications"
               displayName="Associated publications"
               queryRef="DataSourceTables.Publications">
            <columnAttribute name="data_source_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="pmid" displayName="Pubmed ID" internal="true"/>
            <columnAttribute name="doi" displayName="DOI" internal="true"/>
            <columnAttribute name="citation" displayName=""/>
        </table>  


        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- External Links -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="ExternalLinks"
               displayName="External Links"
               queryRef="DataSourceTables.ExternalLinks">
            <columnAttribute name="data_source_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="descrip" displayName="Description" internal="true"/>
            <columnAttribute name="url" displayName=""/>
            <columnAttribute name="url_type" displayName="Link Type" internal="true"/>
        </table>  

        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <!-- References -->  
        <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
        <table name="References"
               displayName="Searches using these data"
               queryRef="DataSourceTables.References">
            <columnAttribute name="data_source_name"  inReportMaker="false" internal="true"/>
            <columnAttribute name="record_type"/>
            <columnAttribute name="target_type"/>
            <columnAttribute name="target_name"/>
        </table>  

      </recordClass>
    </recordClassSet>


      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Attribute queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DataSourceAttributes" queryType="attribute" doNotTest="true"  includeProjects="InitDB,FungiDB,PiroplasmaDB,PlasmoDB,CryptoDB,MicrosporidiaDB">

      <testRowCountSql includeProjects="EuPathDB">
	 SELECT count(*) FROM ApiDBTuning.DataSourceAttribution 
       </testRowCountSql>

      <sqlQuery name="All"  isCacheable="false">
        <column name="data_source_name"/>
        <column name="project_id"/>
        <column name="display_name"/>
        <column name="version"/>
        <column name="public_url"/>
        <column name="category"/>
        <column name="organism"/>
        <column name="summary"/>
        <column name="description"/>
        <column name="contact"/>
        <column name="institution"/>
            <sql>
            <![CDATA[
            SELECT DISTINCT ds.name as data_source_name, p.name as project_id,
                   ds.version, tn.name as organism,dsa.display_name, dsu.url as public_url, 
                   dsa.display_category as category,dsa.description, dsc.affiliation as institution,
                   case when dsa.summary is null then dsa.description else dsa.summary end as summary,
                   case when dsc.name is null then '<a href="http://eupathdb.org/eupathdb/help.jsp" target="_blank" onClick="poptastic(this.href); return false;">Contact EuPathDB for more details</a>' else dsc.name END as contact
            FROM   ApiDB.DataSource ds, ApiDBTuning.DataSourceAttribution dsa, Core.projectInfo p,
                   (Select url, data_source_id From  ApiDBTuning.DataSourceAttributionURL Where url_type = 'publicUrl') dsu,
                    ApiDBTuning.DataSourceContact dsc, (Select distinct taxon_id, name From Sres.TaxonName
                   Where name_class = 'scientific name') tn 
            WHERE  ds.row_project_id  = p.project_id
            AND    dsa.data_source_id = ds.data_source_id
            AND    dsc.data_source_id(+) = dsa.data_source_id
            AND    dsu.data_source_id(+) = dsa.data_source_id
            AND    tn.taxon_id  (+)   = ds.taxon_id
            AND    p.name  = '@PROJECT_ID@' 
            ORDER BY  dsa.display_category, tn.name 
            ]]>
            </sql>
      </sqlQuery>

    </querySet>

      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
      <!-- Table queries -->  
      <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <querySet name="DataSourceTables" queryType="table">

      <sqlQuery name="Publications"  isCacheable='false'>
            <column name="data_source_name"/>
            <column name="project_id"/>
            <column name="pmid"/>
            <column name="pubmed_url"/>
            <column name="doi"/>
            <column name="citation"/>
            <sql>
            <![CDATA[
            SELECT DISTINCT ds.name as data_source_name, p.name as project_id,dsp.pmid, dsp.doi,
                   '<a href="http://www.ncbi.nlm.nih.gov/pubmed/' || dsp.pmid || '">' ||dsp.citation||'</a>' as citation
            FROM   ApiDB.DataSource ds, ApiDBTuning.DataSourceAttribution dsa,  
                   ApiDBTuning.DataSourceAttrPublication dsp, core.projectinfo p
            WHERE  ds.data_source_id = dsa.data_source_id
              AND  dsa.data_source_id = dsp.data_source_id
              AND ds.row_project_id = p.project_id
              AND p.name = '@PROJECT_ID@'  
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="Contacts"  isCacheable='false'>
            <column name="data_source_name"/>
            <column name="project_id"/>
            <column name="name"/>
            <column name="email"/>
            <column name="affiliation"/>
            <sql>
            <![CDATA[
            SELECT DISTINCT ds.name as data_source_name, p.name as project_id,
                   dsc.name, dsc.email, dsc.affiliation
            FROM   ApiDB.DataSource ds, ApiDBTuning.DataSourceAttribution dsa,
                   ApiDBTuning.DataSourceContact dsc,  core.projectinfo p
            WHERE  ds.data_source_id = dsa.data_source_id
              AND  dsa.data_source_id = dsc.data_source_id
              AND  ds.row_project_id = p.project_id
              AND  p.name = '@PROJECT_ID@'  
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="ExternalLinks"  isCacheable='false'>
            <column name="data_source_name"/>
            <column name="project_id"/>
            <column name="descrip"/>
            <column name="url"/>
            <column name="url_type"/>
            <sql>
            <![CDATA[
       SELECT data_source_name, '@PROJECT_ID@' as project_id, descrip, url_type,
              CASE WHEN descrip is null THEN '<a href="' || url ||'">' || url || '</a>' ELSE '<a href="' || url ||'">' || descrip || '</a>' END as url
       FROM  (SELECT DISTINCT ds.name as data_source_name, dsu.url_description as descrip, dsu.url_type,
                   REPLACE(REPLACE(dsu.url,'PROJECT_ID','@PROJECT_ID@'),'ORGANISM_ABBREV',org.name_for_filenames) as url
            FROM   ApiDB.DataSource ds, ApiDBTuning.DataSourceAttribution dsa, ApiDB.Organism org,
                   ApiDBTuning.DataSourceAttributionURL dsu,  core.projectinfo p
            WHERE  ds.data_source_id = dsa.data_source_id
              AND  dsa.data_source_id = dsu.data_source_id
              AND  ds.row_project_id = p.project_id
              AND  org.taxon_id(+) = ds.taxon_id
              AND  p.name = '@PROJECT_ID@')
            ]]>
            </sql>
        </sqlQuery>


      <sqlQuery name="References"  isCacheable='false'>
            <column name="data_source_name"/>
            <column name="project_id"/>
            <column name="record_type"/>
            <column name="target_type"/>
            <column name="target_name"/>
            <sql>
            <![CDATA[
            SELECT DISTINCT ds.name as data_source_name, p.name as project_id,
                   dsr.record_type, dsr.target_type, dsr.target_name
            FROM   ApiDB.DataSource ds, ApiDBTuning.DataSourceAttribution dsa, 
                   ApiDBTuning.DataSourceWdkReference dsr, core.projectinfo p
            WHERE  ds.data_source_id = dsa.data_source_id
              AND  dsa.data_source_id = dsr.data_source_id
              AND  ds.row_project_id = p.project_id
              AND p.name = '@PROJECT_ID@'  
            ]]>
            </sql>
        </sqlQuery>

    </querySet>

</wdkModel>
