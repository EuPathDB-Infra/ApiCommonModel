<wdkModel>
    <querySet name="SnpTables" queryType="table" isCacheable="false" includeProjects="ToxoDB,PlasmoDB,CryptoDB,EuPathDB,AmoebaDB,TriTrypDB,FungiDB">

      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">NGS_SNP.Pf3D7_11_v3.1293957</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="ToxoDB">
         <paramValue name="source_id">NGS_SNP.tgme49_asmbl.1154.490</paramValue>
         <paramValue name="project_id">ToxoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="CryptoDB">
         <paramValue name="source_id">chr3-2_66329</paramValue>
         <paramValue name="project_id">CryptoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="TriTrypDB">
         <paramValue name="source_id">NGS_SNP.Tb927_01_v4.36382</paramValue>
         <paramValue name="project_id">TriTrypDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="FungiDB">
         <paramValue name="source_id">NGS_SNP.AfumAf293_Chr1.120</paramValue>
         <paramValue name="project_id">FungiDB</paramValue>
      </defaultTestParamValues>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Strains for HTS SNPs -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="HTSStrainsTable" excludeProjects="TrichDB,GiardiaDB,EuPathDB"
                 isCacheable="false" doNotTest="1">

           <testParamValues includeProjects="CryptoDB">
               <paramValue name="source_id">NGS_SNP.AAEE01000002.1096761</paramValue>
            </testParamValues>
           <testParamValues includeProjects="PlasmoDB">
               <paramValue name="source_id">NGS_SNP.Pf3D7_05_v3.694493</paramValue>
            </testParamValues>
           <testParamValues includeProjects="ToxoDB">
               <paramValue name="source_id">NGS_SNP.TGME49_chrIb.1890502</paramValue>
            </testParamValues>
           <testParamValues includeProjects="FungiDB">
               <paramValue name="source_id">NGS_SNP.AfumAf293_Chr1.120</paramValue>
            </testParamValues>

            <column name="source_id" />
            <column name="project_id" />
            <column name="strain"/>
            <column name="strain_link"/>
            <column name="allele"/>
            <column name="allele_gene_strand"/>
            <column name="product"/>
            <column name="coverage"/>
            <column name="read_frequency"/>
            <column name="view_align"/>
            <column name="has_align"/>
            <column name="isolate_source_id"/>
            <column name="haplogroup" includeProjects="ToxoDB"/>
            <sql includeProjects="PiroplasmaDB,GiardiaDB,PlasmoDB,CryptoDB,AmoebaDB,TriTrypDB,FungiDB">
            <![CDATA[
SELECT distinct snp.source_id, '@PROJECT_ID@' AS project_id,
       b.source_id as isolate_source_id,
       var.strain as strain,
       '<a href=showRecord.do?name=IsolateRecordClasses.IsolateRecordClass&' ||'project_id=@PROJECT_ID@&'|| 'primary_key='||ia.source_id||'>'|| var.strain ||'</a>' AS strain_link,
       var.allele,
       CASE WHEN snp.gene_strand = 'reverse' THEN apidb.reverse_complement(var.allele) 
            WHEN snp.gene_source_id is null THEN ''
            ELSE var.allele 
       END as allele_gene_strand,
       decode(var.strain, snp.reference_strain, 1, 2) as strain_order,
       var.product,
       var.coverage, 
       var.read_percent as read_frequency,
       CASE WHEN b.source_id is null THEN ''
            ELSE lower(snp.project_id) || 
              '/?name=' || nas.source_id || ':' || to_char(snp.location - 50) || '..' || to_char(snp.location + 50) || 
              ';l=' || d.name  || 
              ';h_region=' || nas.source_id || ':' || to_char(snp.location) || '..' || to_char(snp.location + 1) || '@red'  
       END as view_align,
       CASE WHEN b.source_id is null THEN '' ELSE 'view alignment' END as has_align,
       d.name 
FROM   apidbtuning.SnpAttributes snp, 
      apidb.SequenceVariation var, 
      -- study.study s, 
      rad.studybiomaterial sb, 
      study.biomaterial b, 
      apidbtuning.isolateAttributes ia, 
      dots.nasequence nas,
      SRES.externaldatabase d,
      sres.externaldatabaserelease r
WHERE snp.na_sequence_id = var.ref_na_sequence_id
  AND snp.location = var.location
  AND nas.na_sequence_id = snp.na_sequence_id
  AND var.external_database_release_id = b.external_database_release_id(+)
  AND b.bio_material_id = sb.bio_material_id(+)
  --AND sb.study_id = s.study_id(+)
  --and s.external_database_release_id = r.external_database_release_id
  and ia.external_db_name = d.name
  AND r.external_database_id = d.external_database_id
  AND r.EXTERNAL_DATABASE_RELEASE_ID = var.EXTERNAL_DATABASE_RELEASE_ID
ORDER BY strain_order, var.strain
             ]]>
           </sql>
           <sql includeProjects="ToxoDB">
            <![CDATA[
SELECT distinct snp.source_id, '@PROJECT_ID@' AS project_id,
       b.source_id as isolate_source_id,
       var.strain as strain,
       CASE WHEN b.source_id  in (select source_id from apidbtuning.isolateattributes)
         THEN  '<a href=showRecord.do?name=IsolateRecordClasses.IsolateRecordClass&' ||'project_id=@PROJECT_ID@&'|| 'primary_key='||b.source_id||'>'|| var.strain ||'</>'
         ELSE  var.strain END AS strain_link,
       var.allele,
       CASE WHEN snp.gene_strand = 'reverse' THEN apidb.reverse_complement(var.allele) 
            WHEN snp.gene_source_id is null THEN ''
            ELSE var.allele 
       END as allele_gene_strand,
       decode(var.strain, snp.reference_strain, 1, 2) as strain_order,
       var.product,
       var.coverage, 
       nvl(h.haplogroup,'unknown') as haplogroup,
       nvl(h.order_num, 0) as order_num,
       var.read_percent as read_frequency,
       CASE WHEN b.source_id is null THEN ''
            ELSE lower(snp.project_id) || 
              '/?name=' || nas.source_id || ':' || to_char(snp.location - 50) || '..' || to_char(snp.location + 50) || 
              ';l=' || d.name  || 
              ';h_region=' || nas.source_id || ':' || to_char(snp.location) || '..' || to_char(snp.location + 1) || '@red'  
       END as view_align,
       CASE WHEN b.source_id is null THEN '' ELSE 'view alignment' END as has_align,
       d.name 
FROM   apidbtuning.SnpAttributes snp, 
      apidb.SequenceVariation var,
      (  SELECT distinct b.name as strain,
                     bmc.value as haplogroup,
                     CASE WHEN bmc.value = '6a' THEN 6
                              WHEN bmc.value = '6b' THEN 6
                              WHEN bmc.value = 'unknown' THEN 0
                              ELSE to_number(bmc.value)
                     END as order_num
             FROM    Study.Ontologyentry oe,
                         Study.Biomaterialcharacteristic Bmc,
                         study.biosample b,
                         SRES.externaldatabase d,
                         sres.externaldatabaserelease r
          WHERE  b.external_database_release_id = r.external_database_release_id
               AND r.external_database_id = d.external_database_id
               AND d.name like '%SNPSample%'
               AND b.Bio_Material_Id = Bmc.Bio_Material_Id
               AND Bmc.Ontology_Entry_Id = Oe.Ontology_Entry_Id
               AND oe.category ='BioMaterialCharacteristics'
               AND oe.value ='Haplogroup'
           UNION
            select  'ME49' as strain, '2' as haplogroup, 2 as order_num from dual   
      ) h,
      rad.studybiomaterial sb, 
      study.biomaterial b, 
      dots.nasequence nas,
      SRES.externaldatabase d,
      sres.externaldatabaserelease r
WHERE snp.na_sequence_id = var.ref_na_sequence_id
  AND snp.location = var.location
  AND var.strain = h.strain(+)
  AND nas.na_sequence_id = snp.na_sequence_id
  AND var.external_database_release_id = b.external_database_release_id(+)
  AND b.bio_material_id = sb.bio_material_id(+)
  AND r.external_database_id = d.external_database_id
  AND r.EXTERNAL_DATABASE_RELEASE_ID = var.EXTERNAL_DATABASE_RELEASE_ID
ORDER BY strain_order,order_num, strain
             ]]>
           </sql>
        </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Allele count -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="AlleleCount" includeProjects="PiroplasmaDB,GiardiaDB,ToxoDB,PlasmoDB,CryptoDB,AmoebaDB,TriTrypDB,FungiDB" isCacheable="false">
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="allele_count"/>
            <column name="allele"/>
            <sql>
                <![CDATA[
           SELECT snp.source_id, '@PROJECT_ID@' AS project_id,
                  count(*) as allele_count, var.allele
           FROM   apidbtuning.SnpAttributes snp, 
                  apidb.sequencevariation var
           WHERE  snp.na_sequence_id = var.ref_na_sequence_id
              AND snp.location = var.location
           GROUP BY snp.source_id, var.allele
           ORDER BY var.allele
                ]]>
            </sql>
       </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Product count -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

       <sqlQuery name="ProductCount" includeProjects="PiroplasmaDB,GiardiaDB,ToxoDB,PlasmoDB,CryptoDB,AmoebaDB,TriTrypDB,FungiDB" isCacheable="false">
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="product_count"/>
            <column name="product"/>
            <sql>
                <![CDATA[
           SELECT snp.source_id, '@PROJECT_ID@' AS project_id,
                  count(*) as product_count, var.product
           FROM   apidbtuning.SnpAttributes snp, 
                  apidb.sequencevariation var
           WHERE  snp.na_sequence_id = var.ref_na_sequence_id
              AND snp.location = var.location
              AND var.product is not null
           GROUP BY snp.source_id, var.product
           ORDER BY var.product
                ]]>
            </sql>
       </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Providers -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

        <sqlQuery name="Providers" includeProjects="PlasmoDB" 
               isCacheable="false">
            <column name="source_id" />
            <column name="project_id" />
            <column name="snpchip_source_id"/>
            <column name="name"/>

            <sql>
            <![CDATA[
SELECT sb.source_id, '@PROJECT_ID@' AS project_id,
       sa.source_id as snpchip_source_id, sa.dataset as name
FROM   apidbtuning.SnpChipAttributes sa, 
       apidbtuning.snpattributes sb
WHERE  sa.na_sequence_id = sb.na_sequence_id
   and sa.start_min = sb.location
   and sb.source_id != sa.source_id
   and sa.type in ('Broad_barcode','Broad_3k_chip','Broad_hd_array')
             ]]>
           </sql>

        </sqlQuery>

       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
       <!-- Isolates -->  
       <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

      <sqlQuery name="AllResults" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.snps_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="wdk_weight"/>
            <sql>
                <![CDATA[
                    SELECT  c.source_id, c.project_id, c.wdk_weight 
                    FROM $$snps_answer$$ c
                ]]>
            </sql>
        </sqlQuery>
      <sqlQuery name="ApiProjectSnps" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.Project"/>
            <paramRef ref="recordParams.snps_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="wdk_weight"/>
            <sql>
                <![CDATA[
                    SELECT c.source_id, c.project_id, c.wdk_weight 
                    FROM $$snps_answer$$ c, ApidbTuning.SnpAttributes sa
                    where sa.source_id = c.source_id
                    and sa.project_id = $$Project$$
                ]]>
            </sql>
     </sqlQuery>

        <!-- this is not a filter query, it is the query used for basket function -->
        <sqlQuery name="AllSnpRecords" isCacheable="false" doNotTest="true">
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[ 
                SELECT sa.source_id, sa.project_id
                FROM ApidbTuning.SnpAttributes sa
                ]]>
            </sql>
        </sqlQuery>
    </querySet>

</wdkModel>
