
<wdkModel>
    <querySet name="AssemblyTables" queryType="table" isCacheable="false" excludeProjects="TrichDB,CryptoDB">

      <defaultTestParamValues includeProjects="PlasmoDB">
         <paramValue name="source_id">PfDT.489225.tmp</paramValue>
         <paramValue name="project_id">PlasmoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="ToxoDB">
         <paramValue name="source_id">NcDT.312941.tmp</paramValue>
         <paramValue name="project_id">ToxoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="CryptoDB">
         <paramValue name="source_id">CpDT.318857.tmp</paramValue>
         <paramValue name="project_id">CryptoDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="GiardiaDB">
         <paramValue name="source_id">GlDT.157066.tmp</paramValue>
         <paramValue name="project_id">GiardiaDB</paramValue>
      </defaultTestParamValues>

      <!--TODO - revisit source_id. it is correct but random-->
      <defaultTestParamValues includeProjects="TriTrypDB">
         <paramValue name="source_id">Tb927DT.110744.tmp</paramValue>
         <paramValue name="project_id">TriTrypDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="AmoebaDB">
         <paramValue name="source_id">EdDT.160381.tmp</paramValue>
         <paramValue name="project_id">AmoebaDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="MicrosporidiaDB">
         <paramValue name="source_id">EcDT.160512.tmp</paramValue>
         <paramValue name="project_id">MicrosporidiaDB</paramValue>
      </defaultTestParamValues>

      <defaultTestParamValues includeProjects="FungiDB,HostDB,SchistoDB,InitDB,PiroplasmaDB">
         <paramValue name="source_id"></paramValue>
         <paramValue name="project_id"></paramValue>
      </defaultTestParamValues>


        <!-- AssemblyTables.AlignmentInfo -->
        <sqlQuery name="AlignmentInfo"  isCacheable='true' includeProjects="ToxoDB,CryptoDB,GiardiaDB,PlasmoDB,TriTrypDB,AmoebaDB,MicrosporidiaDB">
            <column name="source_id" />
            <column name="project_id" />
            <column name="id" />
            <column name="sequence_id" />
            <column name="length" />
            <column name="target_start" />
            <column name="target_end" />
            <column name="context_start" />
            <column name="context_end" />
            <column name="percent_identity" />
            <column name="score" />
            <column name="count" />
            <column name="is_consistent" />
            <column name="is_reversed" />
            <column name="organism" />
            <column name="gene" />

            <sql>
            <![CDATA[
            SELECT a.source_id, '@PROJECT_ID@' AS project_id,
                   etn.source_id as sequence_id,
                   a.source_id as id,
                   a.length,
                   blat.target_start,
                   blat.target_end,
                   blat.target_start - 10000 as context_start,
                   blat.target_end + 10000 as context_end,
                   decode(blat.is_consistent,0,'No',1,'Yes', blat.is_consistent) as is_consistent, 
                   decode(blat.is_reversed,0,'No',1,'Yes', blat.is_reversed) as is_reversed, 
                   blat.percent_identity,       
                   blat.score || '' score, 
                   etn.organism,
                   a.number_of_contained_sequences as count,
                   aags.gene
            FROM   ApidbTuning.BlatAlignmentLocation blat, 
                   dots.Assembly a, 
                   ApidbTuning.SequenceAttributes etn,
                   ApidbTuning.AsmAlignmentGenesummary aags
            WHERE  blat.query_na_sequence_id = a.na_sequence_id 
              AND  blat.target_na_sequence_id = etn.na_sequence_id 
              AND  etn.is_top_level = 1
              AND  (blat.target_end - blat.target_start ) < 5000 
              AND  aags.blat_alignment_id = blat.blat_alignment_id
              AND  blat.is_best_alignment = 1 
            ORDER BY blat.is_best_alignment desc, blat.percent_identity desc
            ]]>
            </sql>

        </sqlQuery>


        <!-- AssemblyTables.LibraryInfo -->
        <sqlQuery name="LibraryInfo"  isCacheable='false' includeProjects="ToxoDB,CryptoDB,GiardiaDB,PlasmoDB,TriTrypDB,AmoebaDB,MicrosporidiaDB,FungiDB,HostDB,SchistoDB,InitDB,PiroplasmaDB">
            <column name="source_id" />
            <column name="project_id" />
            <column name="library" />
            <column name="est_count" />
            <sql>
            <![CDATA[
            SELECT asmbly.source_id, '@PROJECT_ID@' AS project_id,
                   l.dbest_name as library, count(e.est_id) as est_count
            FROM   dots.est e, dots.library l, dots.assemblysequence aseq, dots.assembly asmbly
            WHERE  asmbly.na_sequence_id = aseq.assembly_na_sequence_id
              AND  aseq.na_sequence_id = e.na_sequence_id
              AND  e.library_id = l.library_id 
            GROUP BY asmbly.source_id,l.dbest_name
            ORDER BY est_count desc
            ]]>
            </sql>
        </sqlQuery>


        <!-- AssemblyTables.EstInfo -->
            <sqlQuery name="EstInfo"  isCacheable='false' includeProjects="ToxoDB,CryptoDB,GiardiaDB,PlasmoDB,TriTrypDB,AmoebaDB,MicrosporidiaDB,FungiDB,HostDB,SchistoDB,InitDB,PiroplasmaDB">
            <column name="source_id" />
            <column name="project_id" />
            <column name="est" />
            <column name="library" />
            <column name="start" />
            <column name="end" />
            <column name="assembly_strand" />
            <column name="gapped_length" />

            <sql>
            <![CDATA[

              select att.assembly_source_id AS source_id, '@PROJECT_ID@' AS project_id,
                     att.source_id as est, length(aseq.gapped_sequence)  as gapped_length,
                     aseq.assembly_offset + 1 as "start", 
                     aseq.assembly_offset + length(aseq.gapped_sequence) as "end",
                     decode(assembly_strand,1,'+','-') as assembly_strand, 
                     library_dbest_name as library
              from ApidbTuning.EstAttributes att, dots.ASSEMBLYSEQUENCE aseq,dots.EXTERNALNASEQUENCE enas
              where aseq.na_sequence_id  = enas.na_sequence_id
              and enas.source_id = att.source_id
              order by aseq.assembly_offset
            ]]>
            </sql>
        </sqlQuery>

      <sqlQuery name="AllResults" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.assembly_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="wdk_weight"/>
            <sql>
                <![CDATA[
                    SELECT  c.source_id, c.project_id, c.wdk_weight
                    FROM $$assembly_answer$$ c
                ]]>
            </sql>
        </sqlQuery>

       <sqlQuery name="ApiProjectAssemblies" isCacheable="false" includeProjects="EuPathDB">
            <paramRef ref="recordParams.Project"/>
            <paramRef ref="recordParams.assembly_answer"/>
            <column name="source_id"/>
            <column name="project_id"/>
            <column name="wdk_weight"/>
            <sql>
                <![CDATA[
                    SELECT  c.source_id, c.project_id, c.wdk_weight 
                    FROM $$assembly_answer$$ c, ApidbTuning.AssemblyAttributes aa
                    where aa.source_id = c.source_id
                    and aa.project_id = $$Project$$
                ]]>
            </sql>
       </sqlQuery>

       <!-- this is not a filter query, it is the query used for basket function -->
       <sqlQuery name="AllAssemblies" isCacheable="false">
            <column name="source_id"/>
            <column name="project_id"/>
            <sql>
                <![CDATA[
                    SELECT  aa.source_id, aa.project_id 
                    FROM ApidbTuning.AssemblyAttributes aa
                ]]>
            </sql>
     </sqlQuery>

    </querySet>
</wdkModel>
