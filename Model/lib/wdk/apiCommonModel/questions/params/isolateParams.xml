<wdkModel>

  <!-- notes

     - should ms_assay param be a controlled vocab pulled from the database?

  -->

  <paramSet name="isolateParams">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- ID -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
        <datasetParam name="isolate_id" prompt="Isolate ID" 
                      recordClassRef="IsolateRecordClasses.IsolateRecordClass" >
            <help>Input a comma delimited set of  Isolate IDs, or upload a file. Wildcards (*) are allowed.</help>
            <suggest includeProjects="AmoebaDB"
                     default="GQ423750"/>
            <suggest includeProjects="CryptoDB"
                     default="AF527841"/>
            <suggest includeProjects="GiardiaDB"
                     default="EU815931, AF176672"/>
            <suggest includeProjects="MicrosporidiaDB"
                     default="AB472273,EU123526"/>
            <suggest includeProjects="PiroplasmaDB"
                     default="EU362993,EU711062"/>
            <suggest includeProjects="PlasmoDB"
                     default="FJ490884, AB430787"/>
            <suggest includeProjects="ToxoDB"
                     default="AB703307,AF378312"/>
           <suggest includeProjects="EuPathDB"
                     default="AF527841"/>
         </datasetParam>

        <stringParam name="gene_id" prompt="Gene Name" number="false">
            <help>Enter an Gene Name.  Wildcards (*) are allowed.</help>
            <suggest includeProjects="CryptoDB,PlasmoDB,EuPathDB,ToxoDB"
                     default="cgd5_3160"/>
        </stringParam>

        <stringParam name="author" prompt="Author/Submitter" number="false">
            <help>Enter an Author name.  Wildcards (*) are allowed.</help> 
            <suggest default="Xiao"/> 
        </stringParam>

        <stringParam name="product_wildcard"
		     prompt="Locus Sequence  wildcard search" number="false">
	  <suggest default="N/A"/>
	  <help>Asterisks can be used as wildcard characters in a Locus Sequence Name (e.g. "dna*" or "*kinase*")</help>
        </stringParam>



        <flatVocabParam name="specific_host"
             queryRef="hostVQ.withIsolates"
             default="Mammals - Human"
             prompt="Host"
             multiPick="true"
             quote="true"
             displayType="treeBox">
        </flatVocabParam>

        <flatVocabParam name="isolation_source"
             queryRef="isolationSourceVQ.withIsolates"
             prompt="Isolation Source"
             multiPick="true"
             quote="true">
        </flatVocabParam>

        <flatVocabParam name="product"
            queryRef="productVQ.withIsolates"
            prompt="Locus Sequence Name"
            quote="false"
            displayType="typeAhead">
        </flatVocabParam>

        <flatVocabParam name="genotype" includeProjects="ToxoDB,EuPathDB"
            queryRef="genotypeVQ.withIsolates"
            prompt="Genotype #"
            multiPick="true"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_SAG1" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.SAG1"
            prompt="Protein SAG1"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_53_SAG2" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-II-III-nd"
            prompt="5'+3' SAG2"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_alt_SAG2" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-II-III-nd"
            prompt="alt. SAG2"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_SAG3" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-II-III"
            prompt="SAG3"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_CS3" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-u-1"
            prompt="CS3"
            multiPick="false"
            quote="false">
        </flatVocabParam> 

        <flatVocabParam name="rflp_protein_BTUB" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-II-III"
            prompt="BTUB"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_GRA6" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-II-III"
            prompt="GRA6"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_c22-8" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.c22-8"
            prompt="c22-8"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_c29-2" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.c29-2"
            prompt="c29-2"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="rflp_protein_L358" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-II-III"
            prompt="L358"
            multiPick="false"
            quote="false">
        </flatVocabParam> 

        <flatVocabParam name="rflp_protein_PK1" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.PK1"
            prompt="PK1"
            multiPick="false"
            quote="false">
        </flatVocabParam> 

        <flatVocabParam name="rflp_protein_Apico" includeProjects="ToxoDB,EuPathDB"
            queryRef="rflpGenotypeVQ.I-II-III-nd"
            prompt="Apico"
            multiPick="false"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="study" 
            queryRef="studyVQ.withIsolates"
            prompt="Study Name"
            multiPick="true"
            quote="false">
        </flatVocabParam>

        <flatVocabParam name="country" 
            queryRef="countryVQ.withIsolates"
            prompt="Geographic Locations"
            default="Unknown"
            multiPick="true"
            quote="true"
            displayType="treeBox">
            <suggest selectMode="all" />
        </flatVocabParam>

        <flatVocabParam name="continent" includeProjects="CryptoDB,PlasmoDB,EuPathDB"
            queryRef="continentVQ.withIsolates"
            prompt="Continent Name"
            default="--None--"
            multiPick="true"
            quote="false">
        </flatVocabParam> 

        <flatVocabParam name="strain" 
            queryRef="strainVQ.withIsolates"
            prompt="Species/Strain Name"
            multiPick="true"
            quote="true"
            displayType="treeBox">
                  <help>
                        Names from the NCBI Taxonomy 
                        </help>
            <suggest selectMode="first" />
       </flatVocabParam>

       <flatVocabParam name="type" 
            queryRef="typeVQ.withIsolates"
            prompt="Isolate assay type"
            multiPick="true"
            quote="true"> 
        <help>
          Choose the isolate type you want to query
            </help>
        <suggest selectMode="all" />
       </flatVocabParam>

       <enumParam name="text_fields"
                  prompt="Fields"
                  multiPick="true">
        <noTranslation value="true" includeProjects="EuPathDB" />
	 <noTranslation value="false" excludeProjects="EuPathDB" />
         <help>
             Choose which text fields to search.
         </help>
         <suggest selectMode="all" />
         <enumList>
           <enumValue>
             <term>Organism</term>
             <internal>organism</internal>
           </enumValue>
           <enumValue>
             <term>Description</term>
             <internal>description</internal>
           </enumValue>
           <enumValue>
             <term>Strain</term>
             <internal>strain</internal>
           </enumValue>
           <enumValue>
             <term>Host</term>
             <internal>host</internal>
           </enumValue>
           <enumValue>
             <term>Note</term>
             <internal>note</internal>
           </enumValue>
           <enumValue>
             <term>Isolation Source</term>
             <internal>isolation_source</internal>
           </enumValue>
           <enumValue>
             <term>Geographic Location</term>
             <internal>geographic_location</internal>
           </enumValue>
           <enumValue>
             <term>Reference</term>
             <internal>Reference</internal>
           </enumValue>
           <enumValue>
             <term>Overlapping gene (ID or product)</term>
             <internal>GeneOverlap</internal>
           </enumValue>
         </enumList>
       </enumParam>

    <answerParam name="isolate_result"
                  prompt="Input Result Set"
                  readonly="true"
                  visible="false">
        <recordClass ref="IsolateRecordClasses.IsolateRecordClass" />
    </answerParam>

     <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
     <!-- hts isolate answer param -->
     <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
     <answerParam name="htsIsolateList" includeProjects="PlasmoDB"
                    prompt="HTS Isolate Set"
                  readonly="true"
                visible="false">
        <recordClass ref="IsolateRecordClasses.IsolateRecordClass" />
     </answerParam>

    </paramSet>


  <querySet name="hostVQ" queryType="vocab" isCacheable="true">
    <sqlQuery name="withIsolates" excludeProjects="EuPathDB">
    <column name="internal"/>
    <column name="term"/>
    <column name="parentTerm"/>
    <sql>
    <![CDATA[
    select distinct initcap(term) as term, term as internal, initcap(parent) as parentTerm
    from apidb.isolatevocabulary
    where type = 'specific_host'
    start with term in (select distinct annotated_specific_host from apidbtuning.isolateattributes)
    connect by prior parent = term
    order by parentTerm, term
    ]]>
    </sql>
    </sqlQuery>

    <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
      <wsColumn name="parentTerm" width="200" wsName="parentTerm"/>
    </processQuery>

    </querySet>

  <querySet name="isolationSourceVQ" queryType="vocab" isCacheable="true">
    <sqlQuery name="withIsolates" excludeProjects="EuPathDB">
    <column name="term"/>
    <column name="internal"/>
    <sql>
    <![CDATA[
    select distinct initcap(term) as term, term as internal, initcap(parent) as parentTerm
    from apidb.isolatevocabulary
    where type = 'isolation_source'
    start with term in (select distinct annotated_isolation_source from apidbtuning.isolateattributes)
    connect by prior parent = term
    order by parentTerm, term
    ]]>
    </sql>
    </sqlQuery>

    <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="200" wsName="internal"/>
      <wsColumn name="term" width="200" wsName="term"/>
    </processQuery>

    </querySet>

  <querySet name="productVQ" queryType="vocab" isCacheable="true">
    <sqlQuery name="withIsolates" excludeProjects="EuPathDB">
    <column name="display"/>
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
     SELECT product AS display, replace(product, ',', '') as term, product as internal from (
        SELECT distinct ga.product 
          FROM apidbtuning.GeneIsolateOverlap gio, apidbtuning.GeneAttributes ga
         WHERE gio.gene_source_id = ga.source_id
           AND min_pvalue_exp<-5)
     UNION
     SELECT 'N/A' AS display, 'N/A' AS term, 'N/A' AS internal
     FROM dual

    ]]>
    </sql>
    </sqlQuery>

    <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB" sorting="term ASC">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
      <wsColumn name="parentTerm" width="200" wsName="parentTerm"/>
    </processQuery>

     </querySet>

  <querySet name="genotypeVQ" queryType="vocab" isCacheable="true">
    <sqlQuery name="withIsolates" includeProjects="ToxoDB">
    <column name="display"/>
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select distinct 'Genotype #' || v.prediction_number as display, 
      v.prediction_number as term, v.prediction_number as internal
from dots.isolatefeature v 
where name = 'RFLP'
 and v.prediction_number is not null
order by v.prediction_number
    ]]>
    </sql>
    </sqlQuery>

    <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>

  </querySet>

  <querySet name="rflpGenotypeVQ" queryType="vocab" isCacheable="true">

    <sqlQuery name="I-II-III" includeProjects="ToxoDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select 'Don''t Care' as term, 'all' as internal
from dual 
union
select distinct v.gene_type as term, v.gene_type as internal
from dots.isolatefeature v 
where v.name = 'RFLP'
and v.product = 'BTUB'
    ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="I-u-1" includeProjects="ToxoDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select 'Don''t Care' as term, 'all' as internal
from dual 
union
select distinct v.gene_type as term, v.gene_type as internal
from dots.isolatefeature v 
where v.name = 'RFLP'
and v.product = 'CS3'
    ]]>
    </sql>
    </sqlQuery> 
		
    <sqlQuery name="I-II-III-nd" includeProjects="ToxoDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select 'Don''t Care' as term, 'all' as internal
from dual 
union
select distinct v.gene_type as term, v.gene_type as internal
from dots.isolatefeature v 
where v.name = 'RFLP'
and v.product = 'Apico'
    ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="c29-2" includeProjects="ToxoDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select 'Don''t Care' as term, 'all' as internal
from dual 
union
select distinct v.gene_type as term, v.gene_type as internal
from dots.isolatefeature v 
where v.name = 'RFLP'
and v.product = 'c29-2'
    ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="c22-8" includeProjects="ToxoDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select 'Don''t Care' as term, 'all' as internal
from dual 
union
select distinct v.gene_type as term, v.gene_type as internal
from dots.isolatefeature v 
where v.name = 'RFLP'
and v.product = 'c22-8'
    ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="PK1" includeProjects="ToxoDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select 'Don''t Care' as term, 'all' as internal
from dual 
union
select distinct v.gene_type as term, v.gene_type as internal
from dots.isolatefeature v 
where v.name = 'RFLP'
and v.product = 'PK1'
    ]]>
    </sql>
    </sqlQuery>

    <sqlQuery name="SAG1" includeProjects="ToxoDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
select 'Don''t Care' as term, 'all' as internal
from dual 
union
select distinct v.gene_type as term, v.gene_type as internal
from dots.isolatefeature v 
where v.name = 'RFLP'
and v.product = 'SAG1'
    ]]>
    </sql>
    </sqlQuery>

    <processQuery name="I-II-III" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>

    <processQuery name="I-II-III-nd" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>

    <processQuery name="I-u-1" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>

    <processQuery name="c29-2" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>
		
    <processQuery name="c22-8" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>

    <processQuery name="PK1" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>

    <processQuery name="SAG1" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="100" wsName="internal"/>
      <wsColumn name="term" width="100" wsName="term"/>
    </processQuery>


  </querySet> 

  <querySet name="studyVQ" queryType="vocab" isCacheable="true">
    <sqlQuery name="withIsolates" excludeProjects="EuPathDB">
    <column name="internal"/>
    <column name="term"/>
    <sql>
    <![CDATA[
    select distinct apidb.alphanumeric_str(r.title) as term,
                    r.title as internal
    from ApidbTuning.IsolateAttributes ia, dots.nasequenceref sr, sres.reference r
    where ia.na_sequence_id = sr.na_sequence_id
    and r.reference_id = sr.reference_id
    and r.title is not null
    ]]>
    </sql>
    </sqlQuery>

    <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <wsColumn name="internal" width="200" wsName="internal"/>
      <wsColumn name="term" width="200" wsName="term"/>
    </processQuery>

  </querySet>



  <querySet name="countryVQ" queryType="vocab" isCacheable="true">

    <sqlQuery name="withIsolates" excludeProjects="EuPathDB">
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>

      <sql>
      <![CDATA[
    select distinct initcap(term) as term, term as internal, initcap(parent) as parentTerm
    from apidb.isolatevocabulary
    where type = 'geographic_location'
    start with term in (select distinct annotated_geographic_location from apidbtuning.isolateattributes)
    connect by prior parent = term
    order by parentTerm, term
      ]]>
      </sql>
    </sqlQuery>

 
    <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB"  sorting="term ASC">
      <wsColumn name="internal" width="200" wsName="internal"/>
      <wsColumn name="term" width="200" wsName="term"/>
      <wsColumn name="parentTerm" width="200" wsName="parentTerm"/>
    </processQuery>

  </querySet>

  <querySet name="continentVQ" queryType="vocab" isCacheable="true">

     <sqlQuery name="withIsolates" includeProjects="CryptoDB, PlasmoDB">
        <column name="internal"/>
        <column name="term"/>
        <sql>
        <![CDATA[
        SELECT distinct initcap(src.continent) AS term,
               src.continent AS internal
        FROM   ApiDB.Continents src
        WHERE  src.continent is not null
        UNION
        SELECT '--None--' AS term,
               '0' AS internal
        FROM   dual
        ]]> 
     </sql> 
  </sqlQuery>

  <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB"> 
      <wsColumn name="internal" width="200" wsName="internal"/> 
      <wsColumn name="term" width="200" wsName="term"/> 
  </processQuery> 
  </querySet>


  <querySet name="typeVQ" queryType="vocab" isCacheable="true">
    <sqlQuery name="withIsolates" excludeProjects="EuPathDB">
      <column name="internal"/>
      <column name="term"/>
      <sql>
      <![CDATA[
      SELECT distinct src.data_type AS term,
             src.data_type AS internal
      FROM   ApidbTuning.IsolateAttributes src
      ORDER BY src.data_type
      ]]>
      </sql>
    </sqlQuery>

 <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB" sorting="term ASC">
      <wsColumn name="internal" width="200" wsName="internal"/>
      <wsColumn name="term" width="200" wsName="term"/>
    </processQuery>

  </querySet>

  <querySet name="strainVQ" queryType="vocab" isCacheable="true">

    <sqlQuery name="withIsolates" excludeProjects="EuPathDB">
      <column name="internal"/>
      <column name="term"/>
      <column name="parentTerm"/>


<sql>
      <![CDATA[
select distinct regexp_replace(organism, '['']', '') as term,
                organism as internal,
                case when organism = 'environmental samples'
                     then ''
                     else regexp_replace(parent, '['']', '')
                end as parentTerm
from (select tn.name as organism, 
             pn.name as parent
      from (select t.taxon_id, t.parent_id
            from sres.taxon t
            start with taxon_id in (select distinct tn.taxon_id 
                                    from apidb.organism o, sres.taxonname tn
                                    where family_name_for_files is not null 
                                    and tn.name = o.family_name_for_files

                                    -- TODO: these can be removed when the workflow populates apidb.organism.family_name_for_files
                                    union
                                    select taxon_id from sres.taxonname 
                                    where name = case when '@PROJECT_ID@' = 'PlasmoDB'
                                                      then 'Plasmodium'
                                                 else '' end
                                    )
            connect by prior taxon_id = parent_id
           ) tree, sres.taxonname tn, sres.taxonname pn
     where tree.taxon_id = tn.taxon_id and tn.name_class = 'scientific name'
     and tree.parent_id = pn.taxon_id and pn.name_class = 'scientific name'
     and not tn.name = pn.name
     )
start with organism in (select distinct organism from apidbtuning.isolateattributes)
connect by prior parent = organism
order by organism
     ]]>
      </sql>

    </sqlQuery>


 <processQuery name="withIsolates" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB" sorting="term ASC">
      <wsColumn name="internal" width="200" wsName="internal"/>
      <wsColumn name="term" width="200" wsName="term"/>
      <wsColumn name="parentTerm" width="200" wsName="parentTerm"/>
    </processQuery>

  </querySet>


</wdkModel>
