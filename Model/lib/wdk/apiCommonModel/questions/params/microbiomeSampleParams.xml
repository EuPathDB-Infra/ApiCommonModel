<?xml version="1.0" encoding="utf-8"?>
<wdkModel>

  <!-- notes

     - should ms_assay param be a controlled vocab pulled from the database?

  -->

  <paramSet name="sampleParams">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- ID -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
  
      <datasetParam name="sample_id" prompt="Sample ID" 
                      recordClassRef="SampleRecordClasses.MicrobiomeSampleRecordClass" >
            <help>Input a comma delimited set of  Sample IDs, or upload a file. Wildcards (*) are allowed.</help>
             <suggest includeProjects="MicrobiomeDB"
                     default="1064.G.CJV227"/>
          </datasetParam>

       <flatVocabParam name="metadata_datasets"
                     queryRef="samplesVQ.MicrobiomeDatasets"
                     prompt="Dataset"
                     quote="false"
                     visible="true"
                     multiPick="false">
            <help>Choose an Experiment</help> 
        </flatVocabParam>

       <filterParam name="samples_filter_metadata" includeProjects="MicrobiomeDB" 
                      queryRef="samplesVQ.SamplesWithMetadata"
                      metadataQueryRef="samplesVQ.SamplesMetadata"
                      metadataSpecQueryRef="samplesVQ.MetadataSpec"
                      prompt="Samples"
                      multiPick="true"
                      dependedParamRef="sampleParams.metadata_datasets"
                      quote="true"
                      trimMetadataTerms="false">
         <help>
              Select reference samples. 
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParam>
    
  </paramSet>

  <querySet name="samplesVQ" queryType="vocab" isCacheable="true">


       <sqlQuery name="MicrobiomeDatasets" excludeProjects="EuPathDB">
             <column name="internal"/>
             <column name="term"/>
             <column name="display"/>
          <sql>
             select distinct dataset_name AS internal, dataset_name as term,
                    dataset_name AS display
             from apidbTuning.MetadataSpec
             where dataset_name like 'otu_%_RSRC'
          </sql>
        </sqlQuery>

    <sqlQuery name="SamplesWithMetadata" excludeProjects="EuPathDB">
         <paramRef ref="sampleParams.metadata_datasets"/>
         <column name="internal"/>
         <column name="term"/>
         <column name="display"/>
         <sql>
           select * from (
              select pan_name as term, pan_name as display, protocol_app_node_id as internal
              from apidbTuning.panCharacteristicMetadata
              where dataset_name = '$$metadata_datasets$$'
              and pan_name not like '[alpha_diversity]'
              union
              select pan_name as term, pan_name as display, protocol_app_node_id as internal
              from apidbTuning.panProtocolMetadata
              where dataset_name = '$$metadata_datasets$$'
              union
              select pan_name as term, pan_name as display, protocol_app_node_id as internal
              from apidbTuning.FallbackMetadata
              where dataset_name = '$$metadata_datasets$$')
            where term not like '%[alpha_diversity]%' 
          </sql>
        </sqlQuery>

        <sqlQuery name="SamplesMetadata" doNotTest="1" excludeProjects="EuPathDB">
          <paramRef ref="sampleParams.metadata_datasets"/>
          <column name="term" />
          <column name="value"/>
          <column name="property" />
          <sql>
            <![CDATA[
                select pan_name as term, term as property, value
                from apidbTuning.panCharacteristicMetadata
                where dataset_name = '$$metadata_datasets$$'
              union
                select pan_name as term, term as property, value
                from apidbTuning.panProtocolMetadata
                where dataset_name = '$$metadata_datasets$$'
              union
                select pan_name as term, term_name as property, pan_name as value
                from apidbTuning.FallbackMetadata
                where dataset_name = '$$metadata_datasets$$'
            ]]>
            </sql>
        </sqlQuery>

    <sqlQuery name="MetadataSpec" doNotTest="1" excludeProjects="EuPathDB"> 
            <paramRef ref="sampleParams.metadata_datasets"/>
            <column name="property" />
            <column name="spec_property"/>
            <column name="spec_value" />
            <sql>
              <![CDATA[
                select distinct property, spec_property, spec_value
                from apidbTuning.MetadataSpec
                where dataset_name =  '$$metadata_datasets$$'
                union
                select property, 'parent' as spec_property, 'Uncategorized' as spec_value
                from apidbTuning.MetadataSpec 
                where property in ( select distinct property 
                                      from apidbTuning.MetadataSpec
                                     where spec_property = 'leaf'
                                     and dataset_name =  '$$metadata_datasets$$'
                                       minus
                                    select distinct property 
                                      from apidbTuning.MetadataSpec
                                     where spec_property = 'parent'
                )
                union 
                select 'Uncategorized' as property, 'parent' as spec_property, null as spec_value
                from dual
               
              ]]>
            </sql>
        </sqlQuery>

 
  </querySet>


</wdkModel>
