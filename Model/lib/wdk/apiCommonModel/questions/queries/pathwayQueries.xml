<wdkModel>
  <querySet name="PathwayIds" queryType="id" isCacheable="false" includeProjects="PlasmoDB,AmoebaDB">

    <!-- ************************************************************ -->
    <!-- Pathway Name -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="PathwaysByPathwayID" doNotTest="true"  excludeProjects="EuPathDB"
              displayName="ID" isCacheable="true">
        <paramRef ref="pathwayParams.metabolic_pathway_id"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <sql>
            <![CDATA[
            SELECT DISTINCT n.name as source_id, '@PROJECT_ID@' as project_id
            FROM   ApiDB.NetworkContext n
            WHERE  n.network_context_id LIKE REPLACE(REPLACE(REPLACE(REPLACE($$metabolic_pathway_id$$,' ',''),'-', '%'),'*','%'),'any','%')
               ]]>
        </sql>
    </sqlQuery>

    <processQuery name="PathwaysByPathwayID" includeProjects="EuPathDB"
          doNotTest="true"
          processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="pathwayParams.metabolic_pathway_id" noTranslation="true"/>
        <wsColumn name="source_id" width="50" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>   

    <!-- ************************************************************ -->
    <!-- Gene List -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="PathwaysByGeneList" doNotTest="true"  excludeProjects="EuPathDB"
              displayName="ID" isCacheable="true">
        <paramRef ref="sharedParams.ds_gene_ids" excludeProjects="CryptoDB,ToxoDB,PlasmoDB"/>
        <paramRef ref="sharedParams.ds_gene_ids" default="TGGT1_036630" includeProjects="ToxoDB"/>
        <paramRef ref="sharedParams.ds_gene_ids" default="cgd3_510" includeProjects="CryptoDB"/>
        <paramRef ref="sharedParams.ds_gene_ids" default="PF3D7_1247300,PF3D7_1230600" includeProjects="PlasmoDB"/>
        <paramRef ref="geneParams.any_or_all_pathway"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="genes"/>
        <column name="gene_count"/>
        <sql>
            <![CDATA[
SELECT DISTINCT n.name as source_id, '@PROJECT_ID@' as project_id, count(distinct ga.source_id) as gene_count,
       apidb.tab_to_string(set(cast(COLLECT(ga.source_id) AS apidb.varchartab))) as genes
from   ($$ds_gene_ids$$) ds, sres.enzymeClass ec,
       dots.aaSequenceEnzymeClass asec,ApidbTuning.GeneId gi, ApidbTuning.GeneAttributes ga,
       apidb.networkrelationship nr, apidb.networkrelationshiptype nrt,
       ApiDB.NetworkRelContext nrc,  apidb.NetworkContext n, ApiDB.NetworkRelContextLink nrl, apidb.networknode nn
where  ga.aa_sequence_id = asec.aa_sequence_id
AND    lower(gi.id) = lower(ds.source_id)
AND    ga.source_id = gi.gene
AND    asec.enzyme_class_id = ec.enzyme_class_id
and    nn.display_label = ec.ec_number
and    nr.associated_node_id = nn.network_node_id
and    nrc.network_relationship_id = nr.network_relationship_id
and    nrt.network_relationship_type_id = nrc.network_relationship_type_id
and    nrl.network_rel_context_id = nrc.network_rel_context_id
and    nrc.network_context_id = n.network_context_id
group by n.name
having (('$$any_or_all_pathway$$' = 'any') 
        OR (count(*) = (select count(*) 
                        from apidbtuning.geneattributes ga,($$ds_gene_ids$$) ds
                        where lower (ds.source_id) = lower (ga.source_id)
                       ))) ]]>
        </sql>
    </sqlQuery>

    <processQuery name="PathwaysByGeneList" includeProjects="EuPathDB"
          doNotTest="true"
          processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="sharedParams.ds_gene_ids"  noTranslation="true"/>
        <paramRef ref="geneParams.any_or_all_pathway" quote="false"/>
        <wsColumn name="source_id" width="50" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
        <wsColumn name="genes" width="100" wsName="genes"/>
        <wsColumn name="gene_count" width="20" wsName="gene_count"/>
    </processQuery>   


    <!-- ************************************************************ -->
    <!--Compound -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="PathwaysByCompounds" doNotTest="true"  excludeProjects="EuPathDB"
              displayName="Compound" isCacheable="true">
        <paramRef ref="compoundParams.ds_pubchem_compound_id" default="C00074"/>
        <paramRef ref="compoundParams.any_or_all_pathway"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <sql>
            <![CDATA[
            SELECT DISTINCT n.name as source_id, '@PROJECT_ID@' as project_id
            FROM   apidbtuning.PathwayCompounds p, ($$ds_pubchem_compound_id$$) ds, apidb.networkContext n
            WHERE  p.compound = ds.source_id
            AND    p.network_context_id = n.network_context_id
           GROUP BY n.name
           HAVING (('$$any_or_all_pathway$$' = 'any') 
                   OR (count(*) = (select count(*) 
                        FROM ($$ds_pubchem_compound_id$$) ds
                        WHERE ds.source_id IN (SELECT DISTINCT compound FROM apidbtuning.PathwayCompounds ))
               ))
               ]]>
        </sql>
    </sqlQuery>

    <processQuery name="PathwaysByCompounds" includeProjects="EuPathDB"
          doNotTest="true"
          processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="compoundParams.ds_pubchem_compound_id" noTranslation="true"/>
        <paramRef ref="compoundParams.any_or_all_pathway" quote="false"/>
        <wsColumn name="source_id" width="50" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>   


    <sqlQuery name="ByWeightFilter" isCacheable="true" doNotTest="true">
        <paramRef ref="pathwayParams.pathway_result"/>
        <paramRef ref="sharedParams.min_weight" default="0"/>
        <paramRef ref="sharedParams.max_weight" default="100"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="wdk_weight" />
        <sql>
            <![CDATA[
            SELECT a.source_id, a.project_id, a.wdk_weight
            FROM $$pathway_result$$ a
            WHERE a.wdk_weight >= $$min_weight$$
              AND a.wdk_weight <= $$max_weight$$
            ]]>
       </sql>
    </sqlQuery>

    <!-- ************************************************************ -->
    <!-- By Transform on Genes -->
    <!-- ************************************************************ -->

    <sqlQuery name="PathwaysByGeneIds" doNotTest="true"
              displayName="ID" isCacheable="true">
        <paramRef ref="geneParams.gene_result"/>
        <paramRef ref="geneParams.any_or_all_pathway"/>
        <paramRef ref="geneParams.use_ec_wildcard"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="genes"/>
        <column name="ecNums"/>
        <column name="enzyme_count"/>
        <column name="wdk_weight" />

        <sql>
            <![CDATA[
SELECT DISTINCT n.name as source_id, '@PROJECT_ID@' as project_id, count(distinct ec.ec_number) as enzyme_count,
       apidb.tab_to_string(set(cast(COLLECT(ds.source_id) AS apidb.varchartab))) as genes, 
       apidb.tab_to_string(set(cast(COLLECT(nn.display_label) AS apidb.varchartab))) as ecNums, 
       max(ds.wdk_weight) as wdk_weight
from   ($$gene_result$$) ds, sres.enzymeClass ec,
       dots.aaSequenceEnzymeClass asec, ApidbTuning.GeneAttributes ga,
       apidb.networkrelationship nr, apidb.networkrelationshiptype nrt,
       ApiDB.NetworkRelContext nrc,  apidb.NetworkContext n, ApiDB.NetworkRelContextLink nrl, apidb.networknode nn
where  ds.source_id =  ga.source_id
AND ga.aa_sequence_id = asec.aa_sequence_id
AND    asec.enzyme_class_id = ec.enzyme_class_id
AND  (   ( ec.ec_number LIKE REPLACE(nn.display_label,'-', '%')  OR nn.display_label LIKE REPLACE(ec.ec_number,'-', '%')  )
         $$use_ec_wildcard$$  ec.ec_number = nn.display_label    )
and    nr.associated_node_id = nn.network_node_id
and    nrc.network_relationship_id = nr.network_relationship_id
and    nrt.network_relationship_type_id = nrc.network_relationship_type_id
and    nrl.network_rel_context_id = nrc.network_rel_context_id
and    nrc.network_context_id = n.network_context_id
and n.name not in ('ec01100','ec01110','ec01120') /* temporary - these are to be removed later */
group by n.name
having '$$any_or_all_pathway$$' = 'any' or count(*) = (select count(*) from apidbtuning.geneattributes ga,($$gene_result$$) ds  where lower(ga.source_id) = lower(ds.source_id)) 
               ]]>
        </sql>
    </sqlQuery>


    <!-- ************************************************************ -->
    <!-- By Transform on Compounds -->
    <!-- ************************************************************ -->

    <sqlQuery name="PathwaysByCompoundIds" doNotTest="true"
              displayName="ID" isCacheable="true">
        <paramRef ref="compoundParams.compound_result"/>
        <paramRef ref="compoundParams.any_or_all_pathway"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="compounds"/>
        <column name="compound_count"/>
        <column name="wdk_weight" />

        <sql>
            <![CDATA[
SELECT DISTINCT p.source_id , '@PROJECT_ID@' as project_id, count(distinct ds.source_id) as compound_count,
       apidb.tab_to_string(set(cast(COLLECT(pc.compound) AS apidb.varchartab))) as compounds, max(ds.wdk_weight) as wdk_weight
FROM ($$compound_result$$) ds, ApiDB.Pathway p, ApiDB.PathwayNode pn, ApiDBTuning.PathwayCompounds pc,
       ApiDB.NetworkContext nc, ApiDB.NetworkRelContext nrc
WHERE  pc.compound_source_id = ds.source_id
AND    p.pathway_id = pn.parent_id
AND    pn.pathway_node_type_id = 2
AND    pn.display_label = pc.compound
AND    p.source_id not in ('ec01100','ec01110','ec01120') /* temporary - these are to be removed later */
AND    nc.name = p.source_id
AND    nc.network_context_id  = nrc.network_context_id  
GROUP BY p.source_id
HAVING '$$any_or_all_pathway$$' = 'any' or count(*) = (select count(*) from apidbtuning.PathwayCompounds pc,($$compound_result$$) ds  where lower(pc.compound_source_id) = lower(ds.source_id)) 
               ]]>
        </sql>
    </sqlQuery>

   </querySet>

</wdkModel>
