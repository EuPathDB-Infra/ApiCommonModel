<wdkModel>

   <!-- notes

      - in SourceId query changed 'sequence' and 'contig' param to 'sharedParams.genomicSequence'

      - in taxon query changed apidb's seqorganism to organism

      - assumes that NAsequence table has source_id

   -->
  <querySet name="SequenceIds" queryType="id">
    
    <!-- ************************************************************ -->
    <!-- SourceId -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="SequenceBySourceId" doNotTest="true" excludeProjects="EuPathDB"
        isCacheable="true">
        <paramRef ref="genomicParams.sequenceId" default="TGME49_chrIa" includeProjects="ToxoDB"/> 
        <paramRef ref="genomicParams.sequenceId" default="Pf3D7_04" includeProjects="PlasmoDB"/> 
        <paramRef ref="genomicParams.sequenceId" excludeProjects="ToxoDB,PlasmoDB"/> 
        <column name="source_id"/>
        <column name="project_id"/>
	<column name="input_id"/>
        <sql>
        <![CDATA[
            SELECT DISTINCT t.sequence AS source_id,
               apidb.tab_to_string(CAST(COLLECT(t.source_id) AS apidb.varchartab), ', ') AS input_id,
               '@PROJECT_ID@' as project_id
              FROM apidb.sequenceattributes sa,
                 (SELECT DISTINCT ds.source_id, si.sequence
                  FROM apidb.SequenceId si, ($$sequenceId$$) ds
                  WHERE si.id LIKE REGEXP_REPLACE(REPLACE(LOWER(ds.source_id), '*', '%'), '[[:space:]]', '')) t
             WHERE t.sequence = sa.source_id
               AND sa.project_id = '@PROJECT_ID@'
            GROUP BY t.sequence
           ]]>
        </sql>
    </sqlQuery>
    
    <processQuery name="SequenceBySourceId" includeProjects="EuPathDB" doNotTest="true"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="genomicParams.sequenceId" noTranslation="true"/>
        <paramRef ref="sharedParams.signature" noTranslation="true"/>
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
        <wsColumn name="input_id" width="32"/>
    </processQuery>
    
    
    <!-- ************************************************************ -->
    <!-- Species -->  
    <!-- ************************************************************ -->

    <sqlQuery name="SequencesByTaxon" excludeProjects="EuPathDB"
        isCacheable="true">

<!--
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withGenomicSeq"
                  excludeProjects="ToxoDB,AmoebaDB,TriTrypDB" displayType="checkBox"/>
-->
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withSequenceStrains" 
                  displayType="checkBox"/>
        <paramRef ref="genomicParams.sequenceTypes" includeProjects="GiardiaDB"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql includeProjects="PlasmoDB,ToxoDB,CryptoDB,TrichDB,TriTrypDB,AmoebaDB,MicrosporidiaDB,InitDB,PiroplasmaDB">
            <![CDATA[
            SELECT ens.source_id, '@PROJECT_ID@' as project_id
            FROM dots.NaSequence ens,apidb.sequenceattributes atr
            WHERE ens.taxon_id IN ($$organism$$)
               AND atr.na_sequence_id = ens.na_sequence_id
               AND atr.is_top_level = 1
           ]]>
        </sql>
       <sql includeProjects="GiardiaDB">
            <![CDATA[
            SELECT DISTINCT ens.source_id, '@PROJECT_ID@' as project_id
            FROM dots.NaSequence ens, sres.SequenceOntology so
            WHERE ens.taxon_id IN (SELECT taxon_id FROM sres.taxon                        
               CONNECT BY parent_id = prior taxon_id
               START WITH taxon_id in ($$organism$$))
               AND ens.sequence_ontology_id = so.sequence_ontology_id
              AND so.sequence_ontology_id in ($$sequenceTypes$$)
            ORDER BY ens.source_id           
           ]]>
        </sql>
    </sqlQuery>
    
    <processQuery name="SequencesByTaxon" includeProjects="EuPathDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withSequenceStrains"/>
  <!--     <paramRef ref="genomicParams.sequenceTypes" visible="false"  quote="false"/>  -->
        <wsColumn name="source_id" width="32" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>            
    </processQuery>
 
    
    <!-- ************************************************************ -->
    <!-- Similarity -->  
    <!-- ************************************************************ -->
    
    <processQuery name="SequencesBySimilarity" 
        processName="org.apidb.apicomplexa.wsfplugin.wublast.WuBlastPlugin">

        <testParamValues includeProjects="AmoebaDB">
            <paramValue name="BlastQuerySequence">AAGAATTTGCAGATAAATATATTGATAATTGGATTGCAATGTCAA</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>

        <testParamValues includeProjects="CryptoDB">
            <paramValue name="BlastQuerySequence">CGTATTCAAGAGAGTAGTCCATTTGGAATTGATTTCTGTCAAAGT</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>

        <testParamValues includeProjects="ToxoDB">
            <paramValue name="BlastQuerySequence">TGTCGCAAAAAAGCGCAACAACAGCCATTCAGCGCTGCACGTCTCCCCCGCGTCTCCAAGGAA</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
            <paramValue name="BlastDatabaseOrganism">Toxoplasma gondii ME49</paramValue>
        </testParamValues>

        <testParamValues includeProjects="GiardiaDB">
            <paramValue name="BlastQuerySequence">AGAGATCATCAGGATTAGTGATTGGAATTACTTAACTCGAACAAGATAGTATATGGTCCTTCATCTTCAGGCCGTTGTATAGACATGCGAGAATTTGTTCAAGGCTATAGAGCTCTAAAT</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
            <paramValue name="BlastDatabaseOrganism">Giardia Assemblage A isolate WB</paramValue>
        </testParamValues>

        <testParamValues includeProjects="PlasmoDB">
            <paramValue name="BlastQuerySequence">ATGGTGACGCAAAGTAGTGGTGGGGGTGCTGCTGGTAGTAGTGGTGAGGAAGATGCCAAACATGTATTGGATGAATTTGGGCAACAAGTGTACAATGAAAAAGTGGAAAAGTATGCTAATTCTAAAATATATAAAGAGGCGTTGAAAGGAGATTT</paramValue>
            <paramValue name="BlastDatabaseOrganism">Plasmodium falciparum</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>
        <testParamValues includeProjects="TrichDB">
            <paramValue name="BlastQuerySequence">GAAAAATGATATTTCAAAAGAATGGGAATATATTAGAAAGCAAATGGAAAGGTTGAATGATGTTAAACGTGAACAAATTAATTCGGGGCTCATGAATTTTAAACAAGGGGATAAAGTTT</paramValue>
            <paramValue name="BlastDatabaseOrganism">Trichomonas vaginalis</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>

        <testParamValues includeProjects="MicrosporidiaDB">
           <paramValue name="BlastQuerySequence">GTTTTGGCAGACGGTATGTTTAACAGGAAAATCTCCCATGAATCTGACGGGAATATTCATAGTATTGATTTCCATGGCCTAACCATGTGTGATATTCCGGTGATAAAAAGAGACAGATATAC</paramValue>
	   <paramValue name="BlastDatabaseOrganism">Encephalitozoon cuniculi GB-M1</paramValue>
        </testParamValues>

        <testParamValues includeProjects="PiroplasmaDB">
           <paramValue name="BlastQuerySequence">TATGCAATCAGGTATCTATCTCATCAATCCTTACGCTCAGCGCTGCCCAATTGGGAAGAGCAAATGTGGACCTGAGCATGATTCCACCCTAGGAAAGTGTGCCATGTACTCTGGTTG</paramValue>
	   <paramValue name="BlastDatabaseOrganism">Babesia bovis T2Bo</paramValue>
        </testParamValues>

        <!-- TODO copied from Toxo -->
         <testParamValues includeProjects="TriTrypDB,EuPathDB">
            <paramValue name="BlastQuerySequence">ATGCAACTCCAAAGGTTGGGTGCTCCACTACTTAAAAGGCTTGTGGGGGGATGCATACGC</paramValue>
            <paramValue name="BlastDatabaseOrganism">Trypanosoma brucei TREU927</paramValue>
            <paramValue name="BlastDatabaseType">Genome</paramValue>
        </testParamValues>

        <testParamValues includeProjects="InitDB">
           <paramValue name="BlastQuerySequence"></paramValue>
	   <paramValue name="BlastDatabaseOrganism"></paramValue>
        </testParamValues>

        <paramRef ref="sharedParams.BlastDatabaseType" quote="false" noTranslation="false" default="Genome"/>
        <paramRef ref="sharedParams.BlastAlgorithm" quote="false" noTranslation="false" />
        <paramRef ref="sharedParams.BlastDatabaseOrganism" quote="false" noTranslation="false" />
        <paramRef ref="sharedParams.BlastQuerySequence"/>
        <paramRef ref="sharedParams.-e"/>
        <paramRef ref="sharedParams.-v"/>
        <paramRef ref="sharedParams.-b"/>
        <paramRef ref="sharedParams.-filter" quote="false" />
        
        <wsColumn name="source_id" width="32" wsName="Identifier"/>
        <wsColumn name="project_id" width="32" wsName="ProjectId"/>
        <wsColumn name="TabularRow" width="3000"/>
        <wsColumn name="Alignment"  columnType="clob"/>
        <wsColumn name="Header" width="3000"/>
        <wsColumn name="Footer"  columnType="clob"/>
  <wsColumn name="Counter" width="30" columnType="number"/>
    </processQuery>





    
    <processQuery name="GSSBySimilarity" includeProjects="MicrosporidiaDB,EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.wublast.WuBlastPlugin">

        <testParamValues includeProjects="MicrosporidiaDB">
           <paramValue name="BlastQuerySequence">GTTTTGGCAGACGGTATGTTTAACAGGAAAATCTCCCATGAATCTGACGGGAATATTCATAGTATTGATTTCCATGGCCTAACCATGTGTGATATTCCGGTGATAAAAAGAGACAGATATAC</paramValue>
	   <paramValue name="BlastDatabaseOrganism">Genome Survey Sequences</paramValue>
        </testParamValues>

        <paramRef ref="sharedParams.BlastDatabaseType" quote="false" noTranslation="false" default="Genome"/>
        <paramRef ref="sharedParams.BlastAlgorithm" quote="false" noTranslation="false" />
        <paramRef ref="sharedParams.BlastDatabaseOrganism" quote="false" noTranslation="false" />
        <paramRef ref="sharedParams.BlastQuerySequence"/>
        <paramRef ref="sharedParams.-e"/>
        <paramRef ref="sharedParams.-v"/>
        <paramRef ref="sharedParams.-b"/>
        <paramRef ref="sharedParams.-filter" quote="false" />
        
        <wsColumn name="source_id" width="32" wsName="Identifier"/>
        <wsColumn name="project_id" width="32" wsName="ProjectId"/>
        <wsColumn name="TabularRow" width="3000"/>
        <wsColumn name="Alignment"  columnType="clob"/>
        <wsColumn name="Header" width="3000"/>
        <wsColumn name="Footer"  columnType="clob"/>
  <wsColumn name="Counter" width="30" columnType="number"/>
    </processQuery>
    
<!--
    <processQuery name="SequencesBySimilarity" includeProjects="EuPathDB" 
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="sharedParams.BlastDatabaseType"/>
        <paramRef ref="genomicSimilarityParams.BlastDatabaseOrganism"/>
        <paramRef ref="sharedParams.BlastAlgorithm"/>
        <paramRef ref="sharedParams.BlastQuerySequence"/>
        <paramRef ref="sharedParams.-e"/>
        <paramRef ref="sharedParams.-v"/>
        <paramRef ref="sharedParams.-b"/>
        <paramRef ref="sharedParams.-filter"/>
        
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
        <wsColumn name="TabularRow" width="3000"/>
        <wsColumn name="Alignment" width="4000"/>
        <wsColumn name="Header" width="3000"/>
        <wsColumn name="Footer" width="3000"/>
    </processQuery>
    
-->

  <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
  <!-- Query that retrieves all sequences by organism -->
  <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="SequenceDumpQuery" isCacheable="true" excludeProjects="EuPathDB">
        <paramRef ref="organismParams.gff_organism" queryRef="organismVQ.withGenesGFF"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <sqlParamValue name="sequence_table" excludeProjects="ToxoDB">dots.NaSequence</sqlParamValue>
        <sqlParamValue name="sequence_table" includeProjects="ToxoDB">dots.VirtualSequence</sqlParamValue>
        <sql>
            <!-- use CDATA because query includes angle brackets -->
            <![CDATA[
            SELECT DISTINCT sa.source_id, '@PROJECT_ID@' as project_id
            FROM  
                 apidb.SequenceAttributes sa
            WHERE sa.ncbi_tax_id IN (SELECT ncbi_tax_id FROM sres.taxon                                              where taxon_id in ($$gff_organism$$))
              AND sa.project_id = '@PROJECT_ID@'
              AND sa.is_top_level = 1
            ]]>
        </sql>
    </sqlQuery>
    
    
    <sqlQuery name="ByWeightFilter" isCacheable="true" doNotTest="true">
        <paramRef ref="genomicParams.sequence_result"/>
        <paramRef ref="sharedParams.min_weight" default="0"/>
        <paramRef ref="sharedParams.max_weight" default="100"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="wdk_weight" />
        <sql>
            <![CDATA[
            SELECT a.source_id, a.project_id, a.wdk_weight
            FROM $$sequence_result$$ a
            WHERE a.wdk_weight >= $$min_weight$$
              AND a.wdk_weight <= $$max_weight$$
            ]]>
       </sql>
    </sqlQuery>

  </querySet>

</wdkModel>
