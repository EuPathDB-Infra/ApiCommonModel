<wdkModel>
  <querySet name="CompoundIds" queryType="id" isCacheable="false"
	    includeProjects="PlasmoDB">

    <!-- ************************************************************ -->
    <!-- Compound Id -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="CompoundsByCompoundID" doNotTest="true"  excludeProjects="EuPathDB"
              displayName="ID" isCacheable="true">
        <paramRef ref="compoundParams.ds_pubchem_compound_id"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <sql>
            <![CDATA[
          SELECT DISTINCT compound_source_id  as source_id, '@PROJECT_ID@' as project_id
            FROM   apidbtuning.PathwayCompounds p, ($$ds_pubchem_compound_id$$) ds
            WHERE  p.compound = ds.source_id
          UNION
          SELECT c.source_id  as source_id, '@PROJECT_ID@' as project_id
            FROM   apidbtuning.CompoundAttributes c, ($$ds_pubchem_compound_id$$) ds
            WHERE  c.source_id = ds.source_id
               OR  to_char(c.compound_id) = ds.source_id
               ]]>
        </sql>
    </sqlQuery>

    <processQuery name="CompoundsByCompoundID" includeProjects="EuPathDB"
          doNotTest="true"
          processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
        <paramRef ref="compoundParams.ds_pubchem_compound_id" noTranslation="true"/>
        <wsColumn name="source_id" width="50" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>   

    <!-- ************************************************************ -->
    <!-- Compounds By Text Search -->  
    <!-- ************************************************************ -->
    <processQuery name="CompoundsByTextSearch" includeProjects="PlasmoDB"
          processName="org.apidb.apicomplexa.wsfplugin.textsearch.KeywordSearchPlugin">
       <paramRef ref="sharedParams.wdk_record_type" default="compound"/>
       <paramRef ref="sharedParams.text_expression" default="Aminobutanoic" />
       <paramRef ref="compoundParams.text_fields"/>
       <wsColumn name="source_id" width="32" wsName="RecordID"/>
       <wsColumn name="project_id" width="32" wsName="ProjectId"/>
       <wsColumn name="max_score" width="10" wsName="MaxScore" columnType="float"/>
       <wsColumn name="fields_matched" width="64" wsName="Datasets"/>
    </processQuery>

   <processQuery name="CompoundsByTextSearch" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sharedParams.wdk_record_type" noTranslation="true" default="compound"/>
       <paramRef ref="sharedParams.text_expression" noTranslation="true" default="Aminobutanoic"/>
       <paramRef ref="isolateParams.text_fields"  quote="false"/>
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="max_score" width="10" columnType="float"/>
       <wsColumn name="fields_matched" width="64"/>
    </processQuery>

    <!-- ************************************************************ -->
    <!-- Compounds By EC Number -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="CompoundsByEcReaction" excludeProjects="EuPathDB " isCacheable="true">

      <paramRef ref="compoundParams.enzyme" />
      <paramRef ref="compoundParams.compound_type" />
      <column name="project_id"/>
      <column name="source_id"/>
      <column name="compound"/>
      <column name="ec_number"/>
      <sql>
	<![CDATA[
       SELECT DISTINCT pc.compound_source_id as source_id, compound, 
                pc.enzyme AS ec_number,
		'@PROJECT_ID@' as project_id
         FROM apidbtuning.PathwayCompounds pc
         WHERE pc.enzyme= $$enzyme$$
	 AND (pc.type = $$compound_type$$ OR 'either' = $$compound_type$$)
	]]>
        </sql>
    </sqlQuery>

    <processQuery name="CompoundsByEcReaction" includeProjects="EuPathDB"
		  doNotTest="true"
		  processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
      <paramRef ref="compoundParams.enzyme" />
      <paramRef ref="compoundParams.compound_type" />
      <wsColumn name="source_id" width="50" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
      <wsColumn name="compound" width="32"/>   
      <wsColumn name="ec_number" width="32"/>   
    </processQuery>   


    <sqlQuery name="CompoundsByPathway" doNotTest="true"  excludeProjects="EuPathDB"
              displayName="compounds by pathway" isCacheable="true">

      <paramRef ref="pathwayParams.metabolic_pathway_id_with_compounds"/>
      <column name="project_id"/>
      <column name="source_id"/>
      <column name="compound"/>
      <sql>
	<![CDATA[
            SELECT DISTINCT compound_source_id as source_id,
                   compound, '@PROJECT_ID@' as project_id
	    FROM apidbtuning.PathwayCompounds
            WHERE network_id in ($$metabolic_pathway_id_with_compounds$$)  
	    ]]>
        </sql>
    </sqlQuery>

    <processQuery name="CompoundsByPathway" includeProjects="EuPathDB"
		  doNotTest="true"
		  processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin"> 
      <paramRef ref="pathwayParams.metabolic_pathway_id_with_compounds" noTranslation="true"/>
      <wsColumn name="source_id" width="50" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
      <wsColumn name="compound" width="32"/>   
    </processQuery>   


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Molecular Weight -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="CompoundsByMolecularWeight" excludeProjects="EuPathDB"
              isCacheable="true">
        <paramRef ref="compoundParams.min_molecular_weight"/>
        <paramRef ref="compoundParams.max_molecular_weight"/>
        <column name="project_id"/>
        <column name="source_id"/>
	<column name="molecular_wt"/>
        <sql>
            <![CDATA[
            SELECT source_id, mol_wt as molecular_wt, '@PROJECT_ID@' as project_id
	    FROM ApidbTuning.CompoundAttributes
	    WHERE mol_wt <= $$max_molecular_weight$$
                  AND mol_wt >= $$min_molecular_weight$$
           ]]>
       </sql>
    </sqlQuery>

    <processQuery name="CompoundsByMolecularWeight" includeProjects="EuPathDB"
		  processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
      <paramRef ref="compoundParams.min_molecular_weight"/>
      <paramRef ref="compoundParams.max_molecular_weight"/>
      <wsColumn name="source_id" width="50" wsName="source_id"/>
      <wsColumn name="project_id" width="20" wsName="project_id"/>
      <wsColumn name="molecular_wt" width="32"/>   
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Molecular Formula -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="CompoundsByMolecularFormula" excludeProjects="EuPathDB"
              isCacheable="true">
        <paramRef ref="compoundParams.input_formula"/>
        <column name="project_id"/>
        <column name="source_id"/>
	<column name="molecular_formula"/>
        <sql>
            <![CDATA[
            SELECT ca.source_id, ca.formula AS molecular_formula, '@PROJECT_ID@' as project_id
            FROM ApidbTuning.CompoundAttributes ca,  apidb.PubChemCompound pcc
            WHERE pcc.compound_id = ca.compound_id
            AND pcc.property =  'Molecular Formula'
            AND pcc.value LIKE REPLACE($$input_formula$$,'*','%')
           ]]>
       </sql>
    </sqlQuery>

    <processQuery name="CompoundsByMolecularFormula" includeProjects="EuPathDB"
		  processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
      <paramRef ref="compoundParams.input_formula"/>
      <wsColumn name="source_id" width="50" wsName="source_id"/>
      <wsColumn name="project_id" width="20" wsName="project_id"/>
      <wsColumn name="molecular_formula" width="32"/>   
    </processQuery>

    <!-- ************************************************************ -->
    <!-- Transform : Compounds By Gene ID -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="CompoundsByGeneID" doNotTest="true"
              displayName="ID by gene" isCacheable="true">

      <paramRef ref="geneParams.gene_result" />
      <paramRef ref="compoundParams.compound_type" />
      <column name="project_id"/>
      <column name="source_id"/>
      <column name="genes"/>
      <column name="gene_count"/>
      <column name="wdk_weight" />

      <sql>
	<![CDATA[
       SELECT DISTINCT pc.compound_source_id as source_id, '@PROJECT_ID@' as project_id,
              count(distinct ds.source_id) as gene_count,
              apidb.tab_to_string(set(cast(COLLECT(ds.source_id) AS apidb.varchartab))) as genes, max(ds.wdk_weight) as wdk_weight
         FROM ($$gene_result$$)ds, dots.Transcript t, dots.translatedAaFeature taf, 
              sres.enzymeClass ec, dots.aaSequenceEnzymeClass asec, 
              ApidbTuning.GeneId gi, ApidbTuning.GeneAttributes ga,
              apidbtuning.PathwayCompounds pc
        WHERE ga.na_feature_id = t.parent_id
          AND lower(gi.id) = lower(ds.source_id)
          AND ga.source_id = gi.gene
          AND t.na_feature_id = taf.na_feature_id
          AND taf.aa_sequence_id = asec.aa_sequence_id
          AND asec.enzyme_class_id = ec.enzyme_class_id
          AND pc.enzyme = ec.ec_number
	  AND (pc.type = $$compound_type$$ OR 'either' = $$compound_type$$)
      GROUP BY pc.compound_source_id
	]]>
        </sql>
    </sqlQuery>


    <!-- ************************************************************ -->
    <!-- Transform : Compounds By Pathway ID -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="CompoundsByPathwayID" doNotTest="true"
              displayName="ID by pathway" isCacheable="true">

      <paramRef ref="pathwayParams.pathway_result"/>
      <paramRef ref="compoundParams.compound_type" />
      <column name="project_id"/>
      <column name="source_id"/>
      <column name="wdk_weight" />

      <sql>
	<![CDATA[
       SELECT DISTINCT pc.compound_source_id as source_id, '@PROJECT_ID@' as project_id,
              apidb.tab_to_string(set(cast(COLLECT(ds.source_id) AS apidb.varchartab))) as genes, max(ds.wdk_weight) as wdk_weight
         FROM ($$pathway_result$$)ds, apidbtuning.PathwayCompounds pc, ApiDB.Network n
        WHERE pc.network_id = n.network_id
          AND n.name = ds.source_id
	  AND (pc.type = $$compound_type$$ OR 'either' = $$compound_type$$)
      GROUP BY pc.compound_source_id
	]]>
        </sql>
    </sqlQuery>



    <sqlQuery name="CompoundsByFoldChange"
              displayName="Compounds by fold change" isCacheable="true">
      <paramRef ref="compoundParams.profileset" />
      <paramRef ref="compoundParams.samples_fc_ref" />
      <paramRef ref="compoundParams.samples_fc_comp" />
      <paramRef ref="compoundParams.fold_change"/>
      <column name="project_id"/>
      <column name="source_id"/>
      <column name="fold_change"/>

      <sql>
	<![CDATA[
    SELECT  round(one.value/two.value,4) AS fold_change, 
                    ca.source_id, '@PROJECT_ID@' as project_id
    FROM 
       (SELECT sum(pe.value) as value, p.subject_row_id 
        FROM apidb.profileElementName pen, apidb.profile p,
            apidb.profileElement pe, apidb.profileSet ps
        WHERE pen.profile_element_name_id = $$samples_fc_ref$$
           AND p.profile_set_id = pen.profile_set_id
           AND pe.profile_id = p.profile_id
           AND pe.element_order = pen.element_order
           AND ps.profile_set_id = p.profile_set_id
           GROUP BY p.subject_row_id
       ) one,
       (SELECT sum(pe.value) as value, p.subject_row_id 
         FROM apidb.profileElementName pen, apidb.profile p,
              apidb.profileElement pe, apidb.profileSet ps
         WHERE pen.profile_element_name_id = $$samples_fc_comp$$
           AND p.profile_set_id = pen.profile_set_id
           AND pe.profile_id = p.profile_id
           AND pe.element_order = pen.element_order
           AND ps.profile_set_id = p.profile_set_id
           GROUP BY p.subject_row_id
         ) two,
       apidb.pubChemCompound pbc, apidbtuning.compoundAttributes ca
    WHERE one.subject_row_id = two.subject_row_id
      AND two.value > 0
      AND one.value / two.value >= $$fold_change$$
      AND pbc.pubchem_compound_id = one.subject_row_id
      AND ca.compound_id = pbc.compound_id
	]]>
        </sql>
    </sqlQuery>



   </querySet>

</wdkModel>
