<wdkModel>

<querySet name="SpanId" queryType="id">

    <!-- ************************************************************ -->
    <!-- SourceId -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="DynSpansBySourceId" doNotTest="true" excludeProjects="EuPathDB"
        isCacheable="true">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withStrainsChromosome" multiPick="false" includeProjects="TriTrypDB,ToxoDB,PlasmoDB,MicrosporidiaDB,CryptoDB,PiroplasmaDB" quote="true" />
        <paramRef ref="sharedParams.chromosomeOptional" includeProjects="PlasmoDB,ToxoDB,CryptoDB,TriTrypDB,MicrosporidiaDB,PiroplasmaDB"  queryRef="SharedVQ.ChromosomeOrderNumSeq"/>
        <paramRef ref="sharedParams.sequenceId"/>
        <paramRef ref="sharedParams.start_point" default="1"/>
        <paramRef ref="sharedParams.end_point_segment"/>
        <paramRef ref="SpanParams.sequence_strand"/>
        <paramRef ref="SpanParams.span_id" default=""/> 
        <column name="source_id"/>
        <column name="project_id"/>

        <sql>
        <![CDATA[
            SELECT DISTINCT t.source_id,'@PROJECT_ID@' as project_id
 
             FROM (SELECT DISTINCT ds.source_id
                  FROM ($$span_id$$) ds
                  ) t
 
           GROUP BY t.source_id


           ]]>
        </sql>
    </sqlQuery>

      <processQuery name="DynSpansBySourceId" includeProjects="EuPathDB" doNotTest="true"
              isCacheable="true" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="organismParams.organism" queryRef="organismVQ.withChromosomes" multiPick="false" includeProjects="TriTrypDB,ToxoDB,PlasmoDB,MicrosporidiaDB,CryptoDB,PiroplasmaDB" quote="true" />
        <paramRef ref="sharedParams.chromosomeOptional" includeProjects="PlasmoDB,ToxoDB,CryptoDB,TriTrypDB,MicrosporidiaDB,PiroplasmaDB"  queryRef="SharedVQ.ChromosomeOrderNum"/>
        <paramRef ref="sharedParams.sequenceId"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point_segment"/>
        <paramRef ref="SpanParams.span_id" noTranslation="true"/>

        <wsColumn name="source_id" width="50" wsName="source_id"/>
        <wsColumn name="project_id" width="20" wsName="project_id"/>

     </processQuery>

 <!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
  <!-- Location :   for eupath this sql needs to get the project from the apidb.sequenceattribute table  -->
  <!-- +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->



   <sqlQuery name="DynSpansByLocation" excludeProjects="EuPathDB"  isCacheable="true" doNotTest="true">
        <paramRef ref="sharedParams.sequenceId"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>
        <column name="project_id"/>
        <column name="source_id" width="50"/>
        <sql>
            <![CDATA[
            SELECT 
              $$sequenceId$$ || ':' || $$start_point$$  || '-' || $$end_point$$ || ':f' 
                  as source_id,  '@PROJECT_ID@' as project_id
           FROM dual

           ]]>
       </sql>
    </sqlQuery>

     <processQuery name="DynSpansByLocation" includeProjects="EuPathDB" doNotTest="true"
              isCacheable="true" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
         <paramRef ref="sharedParams.sequenceId" noTranslation="true"/>
        <paramRef ref="sharedParams.start_point"/>
        <paramRef ref="sharedParams.end_point"/>

        <wsColumn name="source_id" width="50" wsName="source_id"/>
        <wsColumn name="project_id" width="20" wsName="project_id"/>

     </processQuery>

    <!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <!-- Motif search -->
    <!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <processQuery name="DynSpansByMotifSearch" excludeProjects="EuPathDB"
             processName="org.apidb.apicomplexa.wsfplugin.motifsearch.DnaMotifPlugin">
      <paramRef ref="genomicSimilarityParams.motif_organism" quote="false" />
      <paramRef ref="sharedParams.motif_expression" default="[TG].{5,6}YGCACACAN[TCA]H" noTranslation="true"/>
       <wsColumn name="source_id" width="50" wsName="SourceID"/>
       <wsColumn name="project_id" width="32" wsName="ProjectId"/>
       <wsColumn name="Locations" width="3999"/>
       <wsColumn name="MatchCount" width="15"/>
       <wsColumn name="Sequence" width="3999"/>
    </processQuery>

       <processQuery name="DynSpansByMotifSearch" includeProjects="EuPathDB" doNotTest="true"
              isCacheable="true" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="genomicSimilarityParams.motif_organism" quote="false" />       
       <paramRef ref="sharedParams.motif_expression" default="[TG].{5,6}YGCACACAN[TCA]H" noTranslation="true"/>
       <wsColumn name="source_id" width="50" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="Locations" width="3999"/>
       <wsColumn name="MatchCount" width="15"/>
       <wsColumn name="Sequence" width="3999"/>

     </processQuery>

    <!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
    <!-- span logic - genes and orfs -->
    <!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

    <processQuery name="RecordsBySpanLogic" isCacheable="true" doNotTest="true"
                   processName="org.apidb.apicomplexa.wsfplugin.spanlogic.SpanCompositionPlugin">
        <paramRef ref="SpanParams.span_sentence" />
        <paramRef ref="SpanParams.span_operation"          quote="false"/>
        <paramRef ref="SpanParams.span_strand"             quote="false"/>
        <paramRef ref="SpanParams.span_output"             quote="false"/>
        <paramRef ref="SpanParams.region_a" />
        <paramRef ref="SpanParams.region_b" />
        <paramRef ref="SpanParams.span_a"                   noTranslation="true"/>
        <paramRef ref="SpanParams.span_begin_a"            quote="false"/>
        <paramRef ref="SpanParams.span_begin_direction_a" quote="false"/>
        <paramRef ref="SpanParams.span_begin_offset_a"/>
	<paramRef ref="SpanParams.span_end_a"                   quote="false"/>
        <paramRef ref="SpanParams.span_end_direction_a"   quote="false"/>
        <paramRef ref="SpanParams.span_end_offset_a"/>
        <paramRef ref="SpanParams.span_b"                   noTranslation="true"/>
        <paramRef ref="SpanParams.span_begin_b"            quote="false"/>
        <paramRef ref="SpanParams.span_begin_direction_b" quote="false"/>
        <paramRef ref="SpanParams.span_begin_offset_b"/>
	<paramRef ref="SpanParams.span_end_b"                   quote="false"/>
        <paramRef ref="SpanParams.span_end_direction_b"   quote="false"/>
        <paramRef ref="SpanParams.span_end_offset_b"/>
        <wsColumn name="project_id" width="32"/>
        <wsColumn name="source_id" width="32"/>
        <wsColumn name="wdk_weight" width="12" columnType="number"/>
        <wsColumn name="feature_region" width="100"/>
        <wsColumn name="matched_regions" width="4000"/>
        <wsColumn name="matched_count" width="12" columnType="number"/>
    </processQuery>
    
    
    <sqlQuery name="ByWeightFilter" isCacheable="true" doNotTest="true">
        <paramRef ref="SpanParams.span_result"/>
        <paramRef ref="sharedParams.min_weight" default="0"/>
        <paramRef ref="sharedParams.max_weight" default="100"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="wdk_weight" />
        <sql>
            <![CDATA[
            SELECT a.source_id, a.project_id, a.wdk_weight
            FROM $$span_result$$ a
            WHERE a.wdk_weight >= $$min_weight$$
              AND a.wdk_weight <= $$max_weight$$
            ]]>
       </sql>
    </sqlQuery>


    <sqlQuery name="SpansByeQTLtoGenes" includeProjects="PlasmoDB" 
              isCacheable="true">

        <paramRef ref="sharedParams.ds_gene_ids" default="MAL13P1.173, MAL13P1.181"/>
        <paramRef ref="geneParams.lod_score" default="1.5"/>
        <paramRef ref="geneParams.liberal_conservative"/>
        <paramRef ref="geneParams.any_or_all_DynSeg"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="lod_score"/>
      <sql>
          <![CDATA[
    SELECT source_id, '@PROJECT_ID@' as project_id, max(lod_score) as lod_score
    FROM   (SELECT  CASE WHEN ($$liberal_conservative$$ = 'liberal') THEN (ens.source_id || ':' || nl.start_min  || '-' || nl.end_max)
                         WHEN ($$liberal_conservative$$ = 'conservative') THEN (ens.source_id || ':' || nl.start_max  || '-' || nl.end_min) 
                    END as source_id,
                    to_char(to_binary_double(gls.LOD_SCORE_MANT|| 'e' || gls.LOD_SCORE_EXP),'99.99EEEE') as lod_score
            FROM    dots.chromosomeelementfeature  cef, apidb.genefeaturelodscore  gls,
                    dots.externalnasequence ens, dots.nalocation nl, apidb.geneattributes ga, ($$ds_gene_ids$$) ds 
            where ga.source_id = ds.source_id
            and gls.na_feature_id = ga.na_feature_id
            and cef.name = gls.HAPLOTYPE_BLOCK_NAME
            and nl.na_feature_id = cef.na_feature_id
            and cef.na_sequence_id = ens.na_sequence_id
            and to_binary_double(gls.LOD_SCORE_MANT || 'e' || gls.LOD_SCORE_EXP) >= $$lod_score$$)
    GROUP BY source_id
    HAVING '$$any_or_all_DynSeg$$' = 'any' or count(*) = (select count(*) from apidb.geneattributes ga,($$ds_gene_ids$$) ds  where ga.source_id = ds.source_id) 
          ]]>
      </sql>

    </sqlQuery>

    <processQuery name="SpansByeQTLtoGenes" includeProjects="EuPathDB"
        processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">

        <paramRef ref="sharedParams.ds_gene_ids" default="PF11_0300, PF11_0398"/>
        <paramRef ref="geneParams.lod_score" default="1E-3"/>
        <paramRef ref="geneParams.liberal_conservative"/>
        <paramRef ref="geneParams.any_or_all_DynSeg"/>
        <wsColumn name="project_id" width="20" wsName="project_id"/>
        <wsColumn name="source_id" width="50" wsName="source_id"/>
        <wsColumn name="lod_score" wsName="lod_score"/>
    </processQuery>

</querySet>

</wdkModel>

