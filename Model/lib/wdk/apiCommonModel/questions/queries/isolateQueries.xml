<wdkModel>
  <querySet name="IsolateIds" queryType="id" includeProjects="CryptoDB,GiardiaDB,MicrosporidiaDB,PiroplasmaDB,PlasmoDB,ToxoDB,EuPathDB">

   <!-- notes
      
      - changed ms_assay param names
      - all components will have orfs so i changed the includes/excluded to reflect that

    -->
    
    <!-- ************************************************************ -->
    <!-- Isolate ID -->  
    <!-- ************************************************************ -->
 
    <sqlQuery name="IsolateByIsolateId" doNotTest="true" excludeProjects="EuPathDB"
              displayName="ID" isCacheable="true">
        <paramRef ref="isolateParams.isolate_id"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
            <![CDATA[
                SELECT distinct i.source_id as source_id, 
                       '@PROJECT_ID@' as project_id
                FROM   ApidbTuning.IsolateAttributes i,
                       ($$isolate_id$$) ds
                 WHERE lower(i.source_id) LIKE REGEXP_REPLACE(REPLACE(LOWER(ds.source_id),
                                                       '*', '%'), '[[:space:]]', '')
            ]]>
        </sql>

    </sqlQuery>

    <processQuery name="IsolateByIsolateId" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB" doNotTest="true">
      <paramRef ref="isolateParams.isolate_id" noTranslation="true"/>
       <paramRef ref="sharedParams.signature"  noTranslation="true"/>    
       <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Taxon (Species, Organism) -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByTaxon" excludeProjects="EuPathDB" isCacheable="true">
        <paramRef ref="isolateParams.strain"/>
        <paramRef ref="isolateParams.type"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
           select i.source_id, '@PROJECT_ID@' as project_id
            from ApidbTuning.IsolateAttributes i
            where i.organism in ($$strain$$)
             AND  i.data_type in ($$type$$) 
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByTaxon" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <paramRef ref="isolateParams.strain" quote="false"/>
      <paramRef ref="isolateParams.type"  quote="false"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Host name (Specific_host) -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByHost" excludeProjects="EuPathDB" isCacheable="true">

        <testParamValues>
            <paramValue name="specific_host">Mammals - Human</paramValue>
        </testParamValues>     

        <paramRef ref="isolateParams.specific_host"/>
        <paramRef ref="isolateParams.type"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
           select i.source_id, '@PROJECT_ID@' as project_id
            from ApidbTuning.IsolateAttributes i
            where i.annotated_specific_host in ($$specific_host$$)
             AND  i.data_type in ($$type$$) 
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByHost" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <testParamValues>
	<paramValue name="specific_host">Mammals - Human</paramValue>
      </testParamValues>     

      <paramRef ref="isolateParams.specific_host" quote="false"/>
      <paramRef ref="isolateParams.type" quote="false"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolation Source -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByIsolationSource" excludeProjects="EuPathDB" isCacheable="true">
        <paramRef ref="isolateParams.isolation_source"/>
        <paramRef ref="isolateParams.type"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
           select i.source_id, '@PROJECT_ID@' as project_id
            from ApidbTuning.IsolateAttributes i
            where i.annotated_isolation_source in ($$isolation_source$$)
             AND  i.data_type in ($$type$$) 
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByIsolationSource" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <paramRef ref="isolateParams.isolation_source" quote="false"/>
      <paramRef ref="isolateParams.type" quote="false"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Product -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByProduct" excludeProjects="EuPathDB" isCacheable="true">
        <paramRef ref="isolateParams.product" queryRef="productVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
            SELECT distinct gio.isolate_source_id as source_id, '@PROJECT_ID@' as project_id 
              FROM apidbtuning.GeneIsolateOverlap gio, apidbtuning.GeneAttributes ga
             WHERE gio.gene_source_id = ga.source_id
               AND min_pvalue_exp<-5
               AND ga.product = $$product$$
            ]]>
         </sql>
    </sqlQuery>


 
    <processQuery name="IsolateByProduct" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB" doNotTest="true">
      <paramRef ref="isolateParams.product" queryRef="productVQ.withIsolates" quote="false"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Genotype Number -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByGenotypeNumber" includeProjects="ToxoDB" isCacheable="true">
        <paramRef ref="isolateParams.genotype" queryRef="genotypeVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="gene_type"/>
        <column name="genotype_num"/>
        <sql >
          <![CDATA[
          SELECT source_id, data_type, '@PROJECT_ID@' as project_id,
                 apidb.tab_to_string(set(CAST(COLLECT(gene_type) AS apidb.varchartab)),', ') as gene_type, genotype_num
          FROM (
            SELECT distinct (if.gene_type), s.source_id, '@PROJECT_ID@'
 as project_id, 'Genotype' as data_type, if.prediction_number as genotype_num
            FROM   ApidbTuning.IsolateAttributes s, 
                 dots.isolatefeature if 
            WHERE  s.na_sequence_id = if.na_sequence_id 
              AND if.prediction_number in ($$genotype$$) 
              AND s.data_type = 'RFLP Typed'
           ) GROUP BY source_id, data_type, genotype_num, project_id
          ORDER BY source_id
          ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByGenotypeNumber" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <paramRef ref="isolateParams.genotype" queryRef="genotypeVQ.withIsolates"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
      <wsColumn name="gene_type" width="100"/>
      <wsColumn name="genotype_num" width="100"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by RFLP Genotype Number -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByRFLPGenotype" includeProjects="ToxoDB" isCacheable="true">
        <paramRef ref="isolateParams.rflp_protein_SAG1" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_53_SAG2" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_alt_SAG2" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_SAG3" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_BTUB" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_GRA6" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_c22-8" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_c29-2" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_L358" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_PK1" quote="true"/>
        <paramRef ref="isolateParams.rflp_protein_Apico" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <column name="data_type"/>
        <column name="gene_type"/>
        <sql >
          <![CDATA[
   SELECT source_id, apidb.tab_to_string(set(CAST(COLLECT(gene_type) AS apidb.varchartab)),', ') AS gene_type,
          '@PROJECT_ID@' AS project_id, 'Genotype' as data_type
     FROM (
       SELECT distinct t.source_id, if.gene_type
         FROM (
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'SAG1' and ($$rflp_protein_SAG1$$ = 'all' OR f.gene_type = $$rflp_protein_SAG1$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = '5''+3'' SAG2' and ($$rflp_protein_53_SAG2$$ = 'all' OR f.gene_type = $$rflp_protein_53_SAG2$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'alt. SAG2' and ($$rflp_protein_alt_SAG2$$ = 'all' OR f.gene_type = $$rflp_protein_alt_SAG2$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'Apico' and ($$rflp_protein_Apico$$ = 'all' OR f.gene_type = $$rflp_protein_Apico$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'BTUB' and ($$rflp_protein_BTUB$$ = 'all' OR f.gene_type = $$rflp_protein_BTUB$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'GRA6' and ($$rflp_protein_GRA6$$ = 'all' OR f.gene_type = $$rflp_protein_GRA6$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'c22-8' and ($$rflp_protein_c22-8$$ = 'all' OR f.gene_type = $$rflp_protein_c22-8$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'c29-2' and ($$rflp_protein_c29-2$$ = 'all' OR f.gene_type = $$rflp_protein_c29-2$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'L358' and ($$rflp_protein_L358$$ = 'all' OR f.gene_type = $$rflp_protein_L358$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id 
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'PK1' and ($$rflp_protein_PK1$$ = 'all' OR f.gene_type = $$rflp_protein_PK1$$) 
             AND f.name = 'RFLP' 
          INTERSECT
          SELECT distinct s.source_id,s.na_sequence_id  
          FROM   dots.isolatefeature f, dots.nasequence s
          WHERE  f.na_sequence_id = s.na_sequence_id 
             AND f.product = 'SAG3' and ($$rflp_protein_SAG3$$ = 'all' OR f.gene_type = $$rflp_protein_SAG3$$) 
             AND f.name = 'RFLP' 
        )t, dots.isolatefeature if
       WHERE t.na_sequence_id = if.na_sequence_id 
     ) GROUP BY source_id order by source_id
          ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByRFLPGenotype" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <paramRef ref="isolateParams.rflp_protein_SAG1"/>
      <paramRef ref="isolateParams.rflp_protein_53_SAG2"/>
      <paramRef ref="isolateParams.rflp_protein_alt_SAG2"/>
      <paramRef ref="isolateParams.rflp_protein_SAG3"/>
      <paramRef ref="isolateParams.rflp_protein_BTUB"/>
      <paramRef ref="isolateParams.rflp_protein_GRA6"/>
      <paramRef ref="isolateParams.rflp_protein_c22-8"/>
      <paramRef ref="isolateParams.rflp_protein_c29-2"/>
      <paramRef ref="isolateParams.rflp_protein_L358"/>
      <paramRef ref="isolateParams.rflp_protein_PK1"/>
      <paramRef ref="isolateParams.rflp_protein_Apico"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="data_type"  width="32"/>
      <wsColumn name="gene_type" width="100"/>
    </processQuery>


     <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Study -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByStudy" excludeProjects="EuPathDB" isCacheable="true">
        <paramRef ref="isolateParams.study" queryRef="studyVQ.withIsolates" quote="true"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
            SELECT DISTINCT etn.source_id, '@PROJECT_ID@' as project_id
            FROM DoTS.ExternalNASequence etn, 
                 DoTS.NASequenceRef nasr,
                 SRES.Reference ref,
                 ApidbTuning.IsolateAttributes ia
            WHERE nasr.reference_id = ref.reference_id
            AND nasr.na_sequence_id = etn.na_sequence_id
            and ia.source_id = etn.source_id
            AND ref.title IN $$study$$

            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByStudy" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <paramRef ref="isolateParams.study" queryRef="studyVQ.withIsolates"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolate by Country -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateByCountry" excludeProjects="EuPathDB" isCacheable="true">

        <testParamValues includeProjects="CryptoDB">
            <paramValue name="country">France</paramValue>
        </testParamValues>     
        <testParamValues includeProjects="PlasmoDB">
            <paramValue name="country">Cambodia</paramValue>
        </testParamValues>    
        <testParamValues includeProjects="ToxoDB">
            <paramValue name="country">Poland</paramValue>
        </testParamValues>
        <testParamValues includeProjects="GiardiaDB">
            <paramValue name="country">Sweden</paramValue>
        </testParamValues>

        <paramRef ref="isolateParams.country"/>
        <paramRef ref="isolateParams.type"/>
        <column name="source_id"/>
        <column name="project_id"/>
        <sql>
          <![CDATA[
           select i.source_id, '@PROJECT_ID@' as project_id
            from ApidbTuning.IsolateAttributes i
            where i.annotated_geographic_location in ($$country$$)
             AND  i.data_type in ($$type$$) 
            ]]>
         </sql>
    </sqlQuery>

    <processQuery name="IsolateByCountry" processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin" includeProjects="EuPathDB">
      <paramRef ref="isolateParams.country" quote="false"/>
      <paramRef ref="isolateParams.type"  quote="false"/>
      <wsColumn name="source_id" width="32" wsName="source_id"/>
      <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>


    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Isolates with Gene Overlap  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateWithGeneOverlap" includeProjects="CryptoDB"
              displayName="Gene Name" isCacheable='true'>
      <paramRef ref="isolateParams.gene_id"/>
      <column name="source_id" />
      <column name="project_id"/>
      <sql>
         <![CDATA[
         SELECT distinct t.source_id,
                '@PROJECT_ID@' as project_id
         FROM   DoTS.GeneFeature gf, 
                DoTS.ExternalNASequence etn, 
                DoTS.NaLocation nal,
                 (SELECT source_id, target_name, min_subject_start, 
                         max_subject_end 
                  FROM ApidbTuning.IsolateAttributes) t
         WHERE etn.na_sequence_id = gf.na_sequence_id
           AND nal.na_feature_id = gf.na_feature_id
           AND t.target_name = etn.source_id
           AND nal.start_min <= t.max_subject_end 
           AND nal.end_max >= t.min_subject_start
           AND gf.source_id LIKE REPLACE($$gene_id$$,'*','%') 
        ]]>
      </sql> 
    </sqlQuery> 

    <processQuery name="IsolateWithGeneOverlap" includeProjects="EuPathDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
        <paramRef ref="isolateParams.gene_id"/>
        <wsColumn name="source_id" width="60" wsName="source_id"/>
        <wsColumn name="project_id" width="32" wsName="project_id"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- BLAST  -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <processQuery name="IsolatesBySimilarity"
             displayName="BLAST"
             processName="org.apidb.apicomplexa.wsfplugin.blast.WuBlastPlugin">

        <testParamValues includeProjects="CryptoDB">
            <paramValue name="BlastQuerySequence">TATTTTGGAGGGTTCAATTGCAGGTATTAGAAGCGAATCTTGCGTTGTATCTG</paramValue>
            <paramValue name="BlastDatabaseType">Isolates</paramValue>
            <paramValue name="BlastDatabaseOrganism">Cryptosporidium Isolates minus Reference</paramValue>
        </testParamValues>

        <testParamValues includeProjects="PlasmoDB">
            <paramValue name="BlastQuerySequence">ATACCCGATCGAAGATATCAATTATGTATGAAGGAACTTACGAATTTGGTAAATAATACAGACACAAATTTTCATAGGGATATA</paramValue>
            <paramValue name="BlastDatabaseType">Isolates</paramValue>
            <paramValue name="BlastDatabaseOrganism">P. falciparum Popset/Genbank Isolates</paramValue>

        </testParamValues>

        <testParamValues includeProjects="ToxoDB">
            <paramValue name="BlastQuerySequence">AACTCGGCGCTCGATAAAACACCACAAACTGCTTAGAAGCACTTGCGGTGGACGATGCTCGGGCCAGACTCGTCGTACTC</paramValue>
            <paramValue name="BlastDatabaseType">Isolates</paramValue>
            <paramValue name="BlastDatabaseOrganism">Sarcocystidae Popset/Genbank Isolates</paramValue>
        </testParamValues>

        <testParamValues includeProjects="GiardiaDB,EuPathDB">
            <paramValue name="BlastQuerySequence">GCCCAACGCGCTCTGGGACTGCGGGCTTCGCAGACGCATGAACGCATGATGAGGATTGATCTTCAAGCAAAGACATTTGT</paramValue>
            <paramValue name="BlastDatabaseType">Isolates</paramValue>
            <paramValue name="BlastDatabaseOrganism">All Giardia Isolates</paramValue>
        </testParamValues>

        <testParamValues includeProjects="MicrosporidiaDB,EuPathDB">
            <paramValue name="BlastQuerySequence">ATGGGAAACATATTTCGTCCCGACAATTTTATATTTGGACAGAGCGGTGCTGGAAATAA</paramValue>
            <paramValue name="BlastDatabaseType">Isolates</paramValue>
            <paramValue name="BlastDatabaseOrganism">Enterocytozoonidae Popset/Genbank Isolates</paramValue>
        </testParamValues>

        <testParamValues includeProjects="PiroplasmaDB,EuPathDB">
            <paramValue name="BlastQuerySequence"></paramValue>
            <paramValue name="BlastDatabaseType">Isolates</paramValue>
            <paramValue name="BlastDatabaseOrganism">Babesiidae Isolates</paramValue>
        </testParamValues>

      <paramRef ref="sharedParams.BlastDatabaseType" quote="false" noTranslation="false" default="Isolates"/>
      <paramRef ref="sharedParams.BlastAlgorithm" quote="false" noTranslation="false" />
      <paramRef ref="sharedParams.BlastDatabaseOrganism" quote="false" noTranslation="false" />
      <paramRef ref="sharedParams.BlastQuerySequence"/>
      <paramRef ref="sharedParams.BlastRecordClass" default="IsolateRecordClasses.IsolateRecordClass" />
      <paramRef ref="sharedParams.-e"/>
 <!--     <paramRef ref="sharedParams.-v"/> -->
      <paramRef ref="sharedParams.-b"/>
      <paramRef ref="sharedParams.-filter" quote="false" />
      <wsColumn name="source_id" width="32" wsName="Identifier"/>
      <wsColumn name="project_id" width="32" wsName="ProjectId"/>
      <wsColumn name="TabularRow" width="3000"/>
      <wsColumn name="Alignment"  columnType="clob"/>
      <wsColumn name="Header" width="3000"/>
      <wsColumn name="Footer"  columnType="clob"/>
 <wsColumn name="Counter" width="30" columnType="number"/>
    </processQuery>

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- keyword search (based on Oracle Text) -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <processQuery name="IsolatesByTextSearch" excludeProjects="EuPathDB"
          processName="org.apidb.apicomplexa.wsfplugin.textsearch.KeywordSearchPlugin">
       <paramRef ref="sharedParams.wdk_record_type" default="isolate"/>
       <paramRef ref="sharedParams.project_id" default="CryptoDB" includeProjects="CryptoDB"/>
       <paramRef ref="sharedParams.text_expression" default="Cryptosporidium hominis" includeProjects="CryptoDB"/>
       <paramRef ref="sharedParams.text_expression" default="Plasmodium falciparum" includeProjects="PlasmoDB"/>
       <paramRef ref="sharedParams.text_expression" default="Toxoplasma gondii" includeProjects="ToxoDB"/>
       <paramRef ref="sharedParams.text_expression" default="Giardia lamblia" includeProjects="GiardiaDB"/>
       <paramRef ref="sharedParams.text_expression" default="Encephalitozoon cuniculi" includeProjects="MicrosporidiaDB"/>
       <paramRef ref="sharedParams.text_expression" default="Theileria annulata" includeProjects="PiroplasmaDB"/>
       <paramRef ref="isolateParams.text_fields"/>
       <wsColumn name="source_id" width="32" wsName="RecordID"/>
       <wsColumn name="project_id" width="32" wsName="ProjectId"/>
       <wsColumn name="max_score" width="10" wsName="MaxScore" columnType="float"/>
       <wsColumn name="fields_matched" width="64" wsName="Datasets"/>
    </processQuery>

   <processQuery name="IsolatesByTextSearch" includeProjects="EuPathDB"
        isCacheable='true' processName="org.apidb.apicomplexa.wsfplugin.apifed.ApiFedPlugin">
       <paramRef ref="sharedParams.wdk_record_type" noTranslation="true" default="isolate"/>
       <paramRef ref="sharedParams.project_id"  quote="false" default="CryptoDB"/>
       <paramRef ref="sharedParams.text_expression" noTranslation="true" default="Cryptosporidium hominis"/>
       <paramRef ref="isolateParams.text_fields"  quote="false"/>
       <wsColumn name="source_id" width="32" wsName="source_id"/>
       <wsColumn name="project_id" width="32" wsName="project_id"/>
       <wsColumn name="max_score" width="10" columnType="float"/>
       <wsColumn name="fields_matched" width="64"/>
    </processQuery>
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- dump all isolates -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="IsolateDump"
              isCacheable='true'>
      <paramRef ref="organismParams.gff_organism" queryRef="organismVQ.withGenesGFF"/>
      <column name="source_id" />
      <column name="project_id"/>
      <sql>
         <![CDATA[
         select ia.source_id, '@PROJECT_ID@' as project_id
         from ApidbTuning.IsolateAttributes ia
        ]]>
      </sql> 
    </sqlQuery> 

    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- Dont Care - fake query for internal use -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->

    <sqlQuery name="DontCare" doNotTest="true" isCacheable="true">
        <column name="project_id"/>
        <column name="source_id"/>
        <sql>
            select source_id, project_id
            from ApidbTuning.IsolateAttributes
            where source_id = 'life_is_sweet'
        </sql>
    </sqlQuery>
    
    
    <sqlQuery name="ByWeightFilter" isCacheable="true" doNotTest="true">
        <paramRef ref="isolateParams.isolate_result"/>
        <paramRef ref="sharedParams.min_weight" default="0"/>
        <paramRef ref="sharedParams.max_weight" default="100"/>
        <column name="project_id"/>
        <column name="source_id"/>
        <column name="wdk_weight" />
        <sql>
            <![CDATA[
            SELECT a.source_id, a.project_id, a.wdk_weight
            FROM $$isolate_result$$ a
            WHERE a.wdk_weight >= $$min_weight$$
              AND a.wdk_weight <= $$max_weight$$
            ]]>
       </sql>
    </sqlQuery>


     <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
     <!-- SNPs by Isolate transform -->
     <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
 
     <sqlQuery name="SnpsByHTSIsolateId" includeProjects="PlasmoDB" isCacheable="true">

       <paramRef ref="isolateParams.htsIsolateList"/>
       <paramRef ref="organismParams.organism" displayType="listBox" multiPick="false" quote="true" queryRef="organismVQ.withHtsSNPs">
          <help>Select Organism you wish to query against.</help>
       </paramRef>
       <paramRef ref="sharedParams.chromosomeOptional" queryRef="SharedVQ.ChromosomeOrderNumMultipick" multiPick="false" />
       <paramRef ref="sharedParams.start_point"/>
       <paramRef ref="sharedParams.end_point"/>
       <paramRef ref="sharedParams.htsSnp_strain_a"/>  
       <paramRef ref="sharedParams.hts_snps_coverage"/>
       <paramRef ref="sharedParams.hts_snps_allele_freq" default="80" includeProjects="PlasmoDB"/>
       <paramRef ref="sharedParams.hts_snps_pvalue"/>

       <column name="source_id" />
       <column name="project_id"/>
       <column name="gene"/>
       <column name="snp_location"/>
       <column name="ref_strain"/>
       <column name="comp_strains"/>
       <column name="ref_allele"/>
       <column name="comp_alleles"/>
       <column name="phenotype"/>
       <column name="prot_pos"/>
       <column name="ref_product"/>
       <column name="comp_products"/>
       <column name="wdk_weight" />

        <sqlParamValue name="seqIdOrChrom" excludeProjects="AmoebaDB">
                 AND  seq.chromosome in ( $$chromosomeOptional$$ ) 
        </sqlParamValue>
        <sqlParamValue name="seqIdOrChrom" includeProjects="AmoebaDB">
        </sqlParamValue>

      <sql>
         <![CDATA[
            SELECT snpq.source_id, '@PROJECT_ID@' as project_id, snpq.gene, snpq.snp_location, snpq.prot_pos,
                   apidb.tab_to_string(set(cast(COLLECT(distinct snpq.ref_allele) AS apidb.varchartab)), ', ') as ref_allele,
                   apidb.tab_to_string(set(cast(COLLECT(distinct snpq.ref_product) AS apidb.varchartab)), ', ') as ref_product,
                   apidb.tab_to_string(set(cast(COLLECT(distinct snpq.comp_all) AS apidb.varchartab)), ', ') as comp_alleles,
                   apidb.tab_to_string(set(cast(COLLECT(distinct snpq.comp_product) AS apidb.varchartab)), ', ') as comp_products,
                   apidb.tab_to_string(set(cast(COLLECT(distinct snpq.phenotype) AS apidb.varchartab)), ', ') as phenotype,
                   apidb.tab_to_string(set(cast(COLLECT(distinct snpq.ref_strain) AS apidb.varchartab)), ', ') as ref_strain,
                   apidb.tab_to_string(set(cast(COLLECT(distinct snpq.comp_strain) AS apidb.varchartab)), ', ') as comp_strains,
                   snpq.wdk_weight
            FROM
              (-- records in apid.polymorphism are constrained that
               -- strain_a < strain_b, so this subquery is the union of two
               -- possibilities:
               -- first, when ref strain name < comp strain name
               -- (i.e. ref is strain a, comp is strain b)
               SELECT 
                       p.snp_source_id as source_id,
                      seq.source_id || ':' || trim(to_char(p.start_min,'999,999,999')) as snp_location,
                p.strain_a AS ref_strain, p.strain_b AS comp_strain,
                CASE WHEN p.gene_is_reversed = 1 THEN apidb.reverse_complement(p.allele_a)
                     ELSE p.allele_a END as ref_allele,
                CASE WHEN p.gene_is_reversed = 1 THEN apidb.reverse_complement(p.allele_b)
                     ELSE p.allele_b END as comp_all,
                CASE WHEN p.product_a = p.product_b then 'syn' WHEN p.product_a != p.product_b THEN 'non-syn'
                     ELSE 'non-coding' END as phenotype,
                p.product_a AS ref_product, p.product_b AS comp_product,
                p.position_in_protein as prot_pos,
                p.gene_source_id as gene,
                0 as wdk_weight
               FROM apidbtuning.Polymorphism p, apidbtuning.sequenceAttributes seq, 
                    ( select distinct organism,extdb_name as name,external_database_release_id 
                      from apidbtuning.snpstrains) ss,
                 (select a.strain  from ApidbTuning.IsolateAttributes a, $$htsIsolateList$$ b where a.source_id=b.source_id and a.data_type='HTS') comp
               WHERE ss.organism = $$organism$$
                 AND ss.name in ('InsertSnps.pm NGS SNPs INTERNAL')
                 AND p.external_database_release_id = ss.external_database_release_id
                 AND seq.na_sequence_id = p.na_sequence_id
                 &&seqIdOrChrom&&
                 AND p.strain_a = $$htsSnp_strain_a$$ -- ref
                 AND p.strain_b = comp.strain
                 AND $$htsSnp_strain_a$$ < p.strain_b
                 AND p.start_min >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
                 AND (REGEXP_REPLACE('$$end_point$$', ',| ','') = 0 OR p.start_min < REGEXP_REPLACE('$$end_point$$', ',| ',''))
                 AND (p.pvalue_a is null or p.pvalue_a <= $$hts_snps_pvalue$$)
                 AND (p.allele_percent_a is null or p.allele_percent_a >= $$hts_snps_allele_freq$$)
                 AND (p.coverage_a is null or p.coverage_a >= $$hts_snps_coverage$$)
                 AND (p.pvalue_b is null or p.pvalue_b <= $$hts_snps_pvalue$$)
                 AND (p.allele_percent_b is null or p.allele_percent_b >= $$hts_snps_allele_freq$$)
                 AND (p.coverage_b is null or p.coverage_b >= $$hts_snps_coverage$$)
              UNION
               -- second, when comp strain name < ref strain name
               -- (ref is strain b, comp is strain a)
               SELECT p.snp_source_id as source_id,
                      seq.source_id || ':' || trim(to_char(p.start_min,'999,999,999')) as snp_location,
                p.strain_b AS ref_strain, p.strain_a AS comp_strain,
                CASE WHEN p.gene_is_reversed = 1 THEN apidb.reverse_complement(p.allele_b)
                     ELSE p.allele_b END as ref_allele,
                CASE WHEN p.gene_is_reversed = 1 THEN apidb.reverse_complement(p.allele_a)
                     ELSE p.allele_a END as comp_all,
                CASE WHEN p.product_a = p.product_b then 'syn' WHEN p.product_a != p.product_b THEN 'non-syn'
                     ELSE 'non-coding' END as phenotype,
                p.product_b AS ref_product, p.product_a AS comp_product,
                p.position_in_protein as prot_pos, p.gene_source_id as gene,
                0 as wdk_weight
               FROM apidbtuning.Polymorphism p, apidbtuning.sequenceAttributes seq,
                    ( select distinct organism,extdb_name as name,external_database_release_id 
                      from apidbtuning.snpstrains) ss,
                 (select a.strain  from ApidbTuning.IsolateAttributes a, $$htsIsolateList$$ b where a.source_id=b.source_id and a.data_type='HTS') comp
               WHERE ss.organism = $$organism$$
                 AND ss.name in ('InsertSnps.pm NGS SNPs INTERNAL')
                 AND p.external_database_release_id = ss.external_database_release_id
                 AND seq.na_sequence_id = p.na_sequence_id
                 &&seqIdOrChrom&&
                 AND p.strain_b = $$htsSnp_strain_a$$ -- ref
                 AND p.strain_a = comp.strain -- comp
                 AND p.strain_a < $$htsSnp_strain_a$$
                 AND p.start_min >=  REGEXP_REPLACE('$$start_point$$', ',| ','')
                 AND (REGEXP_REPLACE('$$end_point$$', ',| ','') = 0 OR p.start_min < REGEXP_REPLACE('$$end_point$$', ',| ',''))
                 AND (p.pvalue_a is null or p.pvalue_a <= $$hts_snps_pvalue$$)
                 AND (p.allele_percent_a is null or p.allele_percent_a >= $$hts_snps_allele_freq$$)
                 AND (p.coverage_a is null or p.coverage_a >= $$hts_snps_coverage$$)
                 AND (p.pvalue_b is null or p.pvalue_b <= $$hts_snps_pvalue$$)
                 AND (p.allele_percent_b is null or p.allele_percent_b >= $$hts_snps_allele_freq$$)
                 AND (p.coverage_b is null or p.coverage_b >= $$hts_snps_coverage$$)
                 ) snpq
            GROUP BY snpq.source_id, snpq.gene, snpq.snp_location, snpq.prot_pos, snpq.wdk_weight
            ]]>
        </sql>
     </sqlQuery>

    </querySet>

</wdkModel>
