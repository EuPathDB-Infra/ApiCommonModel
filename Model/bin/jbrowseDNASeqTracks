#!/usr/bin/perl

use strict;
use lib $ENV{GUS_HOME} . "/lib/perl";
use JSON;
use ApiCommonModel::Model::JBrowseUtil;
use ApiCommonModel::Model::JBrowseTrackConfig::SingleCoverageTrackConfig;
use ApiCommonModel::Model::JBrowseTrackConfig::AlignmentsTrackConfig;
use ApiCommonModel::Model::JBrowseTrackConfig::DatasetConfig;
use Data::Dumper;
use URI::Escape;


#my ($organismAbbrev, $projectName, $applicationType) = @ARGV;
#my $jbrowseUtil = ApiCommonModel::Model::JBrowseUtil->new({projectName => $projectName, organismAbbrev => $organismAbbrev, fileName => "_dnaSeqCache.json"});

my ($organismAbbrev, $projectName, $isApollo, $buildNumber, $webservicesDir, $applicationType) = @ARGV;

my $jbrowseUtil = ApiCommonModel::Model::JBrowseUtil->new({projectName => $projectName, organismAbbrev => $organismAbbrev, buildNumber => $buildNumber, webservicesDir => $webservicesDir, fileName => "_dnaSeqCache.json"});

my $datasetProps = $jbrowseUtil->getDatasetProperties();
#print Dumper ($datasetProps); 
#exit;
my $result = {"tracks" => [] };

# we're done if we can get from cache file

#if($jbrowseUtil->printFromCache()) {
#TODO add this back
  #  exit 0;
#}

#open(CACHE, "> " . $jbrowseUtil->getCacheFile()) or die "Cannot open file " . $jbrowseUtil->getCacheFile() . " for writing: $!";

my $publicAbbrevForFiles = $datasetProps->{organism}->{organismNameForFiles};
#my $result = {"tracks" => [] };

#my %datasets;

my $dnaSeqDatasets = $datasetProps->{dnaseq} ? $datasetProps->{dnaseq} : {};

foreach my $dataset (keys %$dnaSeqDatasets) {
  #my $dataset = $dnaSeqDatasets->{$dataset};
  my $summary = $dnaSeqDatasets->{$dataset}->{summary};

  my $hasCnvData = $dnaSeqDatasets->{$dataset}->{hasCNVData};
  my $shortAttribution = $dnaSeqDatasets->{$dataset}->{shortAttribution};
  my $studyDisplayName = $dnaSeqDatasets->{$dataset}->{datasetDisplayName};

  my $category = $dnaSeqDatasets->{$dataset}->{category};
  my $subCategory = $dnaSeqDatasets->{$dataset}->{subCategory};

  my ($study) = $dataset =~ /${organismAbbrev}_HTS_SNP_(.+)_RSRC$/;


  foreach my $sampleName(keys %{$dnaSeqDatasets->{$dataset}->{sampleNames}}) {

    my $baseUrl = "/a/service/jbrowse/store?data=";

    my $bamUrl = $baseUrl . uri_escape_utf8("$publicAbbrevForFiles/bam/$study/$sampleName/result.bam");

    my $copyNumberDataset = "${organismAbbrev}_copyNumberVariations_${study}_RSRC";
    my $cnvBWUrl = $baseUrl . uri_escape_utf8("$publicAbbrevForFiles/bigwig/$copyNumberDataset/$sampleName.bw");

    my $bigwigUrl = $baseUrl . uri_escape_utf8("$publicAbbrevForFiles/bigwig/${study}/${sampleName}/result.bw");

    my $displayName = "$sampleName Coverage and Alignments";
    my $label = "$sampleName Coverage and Alignments";

    my $datasetConfig = ApiCommonModel::Model::JBrowseTrackConfig::DatasetConfig->new({ dataset_name => $dataset,
                                                                                        study_display_name => $studyDisplayName,
                                                                                        category => $category,
                                                                                        subcategory => $subCategory,
                                                                                        attribution => $shortAttribution,
                                                                                        summary => $summary,
                                                                                        application_type => $applicationType,
                                                                                        organism_abbrev => $organismAbbrev,
                                                                                      });


    my $alignment = ApiCommonModel::Model::JBrowseTrackConfig::AlignmentsTrackConfig->new({dataset_config => $datasetConfig,
                                                                                           url_template => $bamUrl,
                                                                                           display_name => $displayName,
                                                                                           application_type => $applicationType,
                                                                                           label => $label,
                                                                                           bw_url_template => $bigwigUrl
                                                                                          })->getConfigurationObject();

    $displayName = "$sampleName Coverage normalised to chromosome copy number (ploidy)";
    $label = "${dataset}_$sampleName";

    my $cnvCoverage = ApiCommonModel::Model::JBrowseTrackConfig::SingleCoverageTrackConfig->new({ dataset_config => $datasetConfig,
                                                                                                  url_template => $cnvBWUrl,
                                                                                                  display_name => $displayName,
                                                                                                  application_type => $applicationType,
                                                                                                  label => $label,
                                                                                                  cov_max_score_default => 5,
                                                                                                  scale => 'linear',
                                                                                                })->getConfigurationObject();


    push @{$result->{tracks}}, $alignment;
    push @{$result->{tracks}}, $cnvCoverage if((lc $hasCnvData eq "true") &&
			      !($dataset eq 'afumAf293_HTS_SNP_Verweij_IsogenicStrains_RSRC' && $sampleName eq 'V157-47'));
  }

}

print encode_json($result);
print CACHE encode_json($result);
close CACHE;

1;

