#!/usr/bin/perl

use strict;
use lib $ENV{GUS_HOME} . "/lib/perl";
use JSON;
use ApiCommonModel::Model::JBrowseUtil;

use Storable 'dclone';

my ($organismAbbrev, $projectName, $isApollo) = @ARGV;

my $jbrowseUtil;

if($isApollo) {
  $jbrowseUtil = ApiCommonModel::Model::JBrowseUtil->new({projectName => $projectName, organismAbbrev => $organismAbbrev});
}
else {
  $jbrowseUtil = ApiCommonModel::Model::JBrowseUtil->new({projectName => $projectName, organismAbbrev => $organismAbbrev, fileName => "_junctionsCache.json"});
}

# we're done if we can get from cache file (unless we are making apollo config)
if(!$isApollo && $jbrowseUtil->printFromCache()) {
  exit 0;
}


my $refinedQueryParams = $jbrowseUtil->intronJunctionsQueryParams('refined');
my $inclusiveQueryParams = $jbrowseUtil->intronJunctionsQueryParams('inclusive');

my $dbh = $jbrowseUtil->getDbh();   

my $sql = "select count(*)
from apidbtuning.datasetproperty p
   , apidbtuning.datasetnametaxon d
   , apidb.organism o
where d.DATASET_PRESENTER_ID = p.DATASET_PRESENTER_ID
and o.taxon_id = d.taxon_id
and d.name like '%rnaSeq_RSRC'
and p.property = 'showIntronJunctions'
and lower(p.value) = 'true'
and o.PUBLIC_ABBREV = '$organismAbbrev'";

my $sh = $dbh->prepare($sql);
$sh->execute();

my ($count) = $sh->fetchrow_array();
$sh->finish();

my $result = {"tracks" => [] };
if($count > 0) {



  my $inclusiveCanvas = {storeClass => "JBrowse/Store/SeqFeature/REST",
                   baseUrl => "/a/service/jbrowse",
#                   type => "JBrowse/View/Track/HTMLFeatures",
                   type => "JBrowse/View/Track/CanvasFeatures",
                   key => "RNA-Seq Evidence for Introns (Inclusive canvas)",
                   label => "RNA-Seq Evidence for Introns (Inclusive canvas)",
                   category => "Transcriptomics",
                   maxFeatureScreenDensity => 0.5,
                   metadata => {
                     subcategory => 'RNA-Seq',
                     trackType => 'Predicted Intron Junctions',
                   },
                   style => {
#                     showLabels => "function(){return false}",                     
#                     labelScale => 1000000000000000, #some really big number so labels are not shown; showLabels=false not working here or in hook TODO
                   },
                   query => $inclusiveQueryParams,
                   onClick => {
                     content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                   },
                   menuTemplate => [
                     {label => "View Details", 
                      content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                     },
                     {label => "Highlight this Feature"},
                       ],
  };



  my $inclusive = {storeClass => "JBrowse/Store/SeqFeature/REST",
                   baseUrl => "/a/service/jbrowse",
#                   type => "JBrowse/View/Track/HTMLFeatures",
                   type => "EbrcTracks/View/Track/IntronJunction",
                   key => "RNA-Seq Evidence for Introns (Inclusive)",
                   label => "RNA-Seq Evidence for Introns (Inclusive)",
                   category => "Transcriptomics",
                   maxFeatureScreenDensity => 0.5,
                   metadata => {
                     subcategory => 'RNA-Seq',
                     trackType => 'Predicted Intron Junctions',
                   },
                   hooks => {
                     modify => "{gsnapUnifiedIntronJunctionHooksModify}",
                   },
                   style => {
                     className => "ibeam",
#                     showLabels => "function(){return false}",                     
#                     labelScale => 1000000000000000, #some really big number so labels are not shown; showLabels=false not working here or in hook TODO
                   },
                   query => $inclusiveQueryParams,
                   onClick => {
                     content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                   },
                   menuTemplate => [
                     {label => "View Details", 
                      content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                     },
                     {label => "Highlight this Feature"},
                       ],
  };


  my $refined = {storeClass => "JBrowse/Store/SeqFeature/REST",
                   baseUrl => "/a/service/jbrowse",
#                   type => "JBrowse/View/Track/HTMLFeatures",
                   type => "EbrcTracks/View/Track/IntronJunction",
                   key => "RNA-Seq Evidence for Introns (Refined)",
                   label => "RNA-Seq Evidence for Introns (Refined)",
                   category => "Transcriptomics",
                   maxFeatureScreenDensity => 0.5,
                   metadata => {
                     subcategory => 'RNA-Seq',
                     trackType => 'Predicted Intron Junctions',
                   },
                   hooks => {
                     modify => "{gsnapUnifiedIntronJunctionHooksModify}",
                   },
                   style => {
                     className => "ibeam",
                     labelScale => 1000000000000000, #some really big number so labels are not shown; showLabels=false not working here or in hook TODO
                   },
                   query => $refinedQueryParams,
                   onClick => {
                     content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                   },
                   menuTemplate => [
                     {label => "View Details", 
                      content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                     },
                     {label => "Highlight this Feature"},
                       ],
  };


  push @{$result->{tracks}}, $refined;
  push @{$result->{tracks}}, $inclusive;
  push @{$result->{tracks}}, $inclusiveCanvas;

  if($isApollo) {
    my $refinedNovel = dclone $refined;
    $refinedNovel->{category} = "Draggable Annotation";
    $refinedNovel->{type} = "JBrowse/View/Track/HTMLFeatures";
    $refinedNovel->{key} = $refinedNovel->{key} . " Novel";
    $refinedNovel->{label} = $refinedNovel->{label} . " Novel";
    $refinedNovel->{query}->{annotated_intron} = "No";
    $refinedNovel->{query}->{feature} = $refinedNovel->{query}->{feature} . "Apollo";
    delete $refinedNovel->{onClick};

    my $refinedKnown = dclone $refined;
    $refinedKnown->{category} = "Draggable Annotation";
    $refinedKnown->{type} = "JBrowse/View/Track/HTMLFeatures";
    $refinedKnown->{key} = $refinedKnown->{key} . " Match Transcript Annotation";
    $refinedKnown->{label} = $refinedKnown->{label} . " Match Transcript Annotation";
    $refinedKnown->{query}->{annotated_intron} = "Yes";
    $refinedKnown->{query}->{feature} = $refinedKnown->{query}->{feature} . "Apollo";
    delete $refinedKnown->{onClick};


    my $inclusiveNovel = dclone $inclusive;
    $inclusiveNovel->{category} = "Draggable Annotation";
    $inclusiveNovel->{type} = "JBrowse/View/Track/HTMLFeatures";
    $inclusiveNovel->{key} = $inclusiveNovel->{key} . " Novel";
    $inclusiveNovel->{label} = $inclusiveNovel->{label} . " Novel";
    $inclusiveNovel->{query}->{annotated_intron} = "No";
    $inclusiveNovel->{query}->{feature} = $inclusiveNovel->{query}->{feature} . "Apollo";
    delete $inclusiveNovel->{onClick};

    my $inclusiveKnown = dclone $inclusive;
    $inclusiveKnown->{category} = "Draggable Annotation";
    $inclusiveKnown->{type} = "JBrowse/View/Track/HTMLFeatures";
    $inclusiveKnown->{key} = $inclusiveKnown->{key} . " Match Transcript Annotation";
    $inclusiveKnown->{label} = $inclusiveKnown->{label} . " Match Transcript Annotation";
    $inclusiveKnown->{query}->{annotated_intron} = "Yes";
    $inclusiveKnown->{query}->{feature} = $inclusiveKnown->{query}->{feature} . "Apollo";
    delete $inclusiveKnown->{onClick};


    push @{$result->{tracks}}, $refinedNovel;
    push @{$result->{tracks}}, $refinedKnown;

    push @{$result->{tracks}}, $inclusiveNovel;
    push @{$result->{tracks}}, $inclusiveKnown;
  }
}

$dbh->disconnect();
print encode_json($result);

unless($isApollo) {
  open(CACHE, "> " . $jbrowseUtil->getCacheFile()) or die "Cannot open file " . $jbrowseUtil->getCacheFile() . " for writing: $!";
  print CACHE encode_json($result);
  close CACHE;
}

1;
