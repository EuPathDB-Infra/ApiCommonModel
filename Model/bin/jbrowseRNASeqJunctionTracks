#!/usr/bin/perl

use strict;
use lib $ENV{GUS_HOME} . "/lib/perl";
use JSON;
use ApiCommonModel::Model::JBrowseUtil;

use Storable 'dclone';

my ($organismAbbrev, $projectName, $isApollo) = @ARGV;

my $jbrowseUtil;

if($isApollo) {
  $jbrowseUtil = ApiCommonModel::Model::JBrowseUtil->new({projectName => $projectName, organismAbbrev => $organismAbbrev});
}
else {
  $jbrowseUtil = ApiCommonModel::Model::JBrowseUtil->new({projectName => $projectName, organismAbbrev => $organismAbbrev, fileName => "_junctionsCache.json"});
}

# we're done if we can get from cache file (unless we are making apollo config)
if(!$isApollo && $jbrowseUtil->printFromCache()) {
  exit 0;
}


my $inclusiveQueryParams = $jbrowseUtil->intronJunctionsQueryParams('inclusive');

my $dbh = $jbrowseUtil->getDbh();   

my $sql = "select count(*)
from apidbtuning.datasetproperty p
   , apidbtuning.datasetnametaxon d
   , apidb.organism o
where d.DATASET_PRESENTER_ID = p.DATASET_PRESENTER_ID
and o.taxon_id = d.taxon_id
and d.name like '%rnaSeq_RSRC'
and p.property = 'showIntronJunctions'
and lower(p.value) = 'true'
and o.PUBLIC_ABBREV = '$organismAbbrev'";

my $sh = $dbh->prepare($sql);
$sh->execute();

my ($count) = $sh->fetchrow_array();
$sh->finish();

my $result = {"tracks" => [] };
if($count > 0) {



  my $inclusive = {storeClass => "JBrowse/Store/SeqFeature/REST",
                   baseUrl => "/a/service/jbrowse",
                   type => "EbrcTracks/View/Track/CanvasSubtracks",
#                   type => "JBrowse/View/Track/CanvasFeatures",
                   key => "RNA-Seq Evidence for Introns",
                         glyph => "EbrcTracks/View/FeatureGlyph/AnchoredSegment",
                   label => "RNA-Seq Evidence for Introns",
                   category => "Transcriptomics",
                   maxFeatureScreenDensity => 0.5,
                   metadata => {
                     subcategory => 'RNA-Seq',
                     trackType => 'Predicted Intron Junctions',
                   },
                   subtracks => [
                     {featureFilters => {
                       annotated_intron => "Yes",
                      },
                      visible => 1,
                      label => "Matches Annotation",
                      metadata => {},
                     },
                     {featureFilters => {
                       annotated_intron => "No",
                       confidence => "HC",
                      },
                      visible => 1,
                      label => "HC",
                      metadata => {},
                     },
                     {featureFilters => {
                       annotated_intron => "No",
                       confidence => "LC",
                      },
                      visible => 1,
                      label => "LC",
                      metadata => {},
                     },
                       ],
                   displayMode => "compact",
                   style => {
                     postHeight => "{gsnapIntronPostHeight}",
                     lineThickness => "{gsnapIntronLineThickness}",
                     color => "{gsnapIntronColorFromStrandAndScore}",
                     showLabels => "function(){return false}",
                   },

                   query => {
                     feature => "gsnap:unifiedintronjunction",
                   },
                   onClick => {
                     content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                   },
                   menuTemplate => [
                     {label => "View Details", 
                      content => "{gsnapUnifiedIntronJunctionTitleFxn}",
                     },
                     {label => "Highlight this Feature"},
                       ],
  };




  push @{$result->{tracks}}, $inclusive;

  if($isApollo) {

    my $refinedNovel = dclone $inclusive;
    $refinedNovel->{category} = "Draggable Annotation";
    $refinedNovel->{type} = "JBrowse/View/Track/HTMLFeatures";
    $refinedNovel->{key} = $refinedNovel->{key} . " Novel with Stronger Evidence";
    $refinedNovel->{label} = $refinedNovel->{label} . " Novel with Stronger Evidence";
    $refinedNovel->{query}->{annotated_intron} = "No";
    $refinedNovel->{query}->{feature} = "gsnap:unifiedintronjunctionHCOnly";
    delete $refinedNovel->{onClick};

    my $inclusiveNovel = dclone $inclusive;
    $inclusiveNovel->{category} = "Draggable Annotation";
    $inclusiveNovel->{type} = "JBrowse/View/Track/HTMLFeatures";
    $inclusiveNovel->{key} = $inclusiveNovel->{key} . " Novel with Weaker Evidence";
    $inclusiveNovel->{label} = $inclusiveNovel->{label} . " Novel with Weaker Evidence";
    $inclusiveNovel->{query}->{annotated_intron} = "No";
    $inclusiveNovel->{query}->{feature} = "gsnap:unifiedintronjunctionLCOnly";
    delete $inclusiveNovel->{onClick};

    my $inclusiveKnown = dclone $inclusive;
    $inclusiveKnown->{category} = "Draggable Annotation";
    $inclusiveKnown->{type} = "JBrowse/View/Track/HTMLFeatures";
    $inclusiveKnown->{key} = $inclusiveKnown->{key} . " Matches Transcript Annotation";
    $inclusiveKnown->{label} = $inclusiveKnown->{label} . " Matches Transcript Annotation";
    $inclusiveKnown->{query}->{annotated_intron} = "Yes";
    $inclusiveKnown->{query}->{feature} = "gsnap:unifiedintronjunctionAnnotatedOnly";
    delete $inclusiveKnown->{onClick};


    push @{$result->{tracks}}, $refinedNovel;
    push @{$result->{tracks}}, $inclusiveNovel;
    push @{$result->{tracks}}, $inclusiveKnown;
  }
}

$dbh->disconnect();
print encode_json($result);

unless($isApollo) {
  open(CACHE, "> " . $jbrowseUtil->getCacheFile()) or die "Cannot open file " . $jbrowseUtil->getCacheFile() . " for writing: $!";
  print CACHE encode_json($result);
  close CACHE;
}

1;
