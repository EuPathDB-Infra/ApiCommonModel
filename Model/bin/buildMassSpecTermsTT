#!/usr/bin/perl

use strict;

use XML::Simple;

use File::Basename;

use DBI;
use DBD::Oracle;

use Getopt::Long qw(GetOptions);

use Data::Dumper;

use ApiCommonData::Load::TuningConfig::Utils;


my ($help, $propfile,$project, $instance, $schema, $password, $suffix, $subversionDir, $debug);
my $tabFileLocation = $ENV{PROJECT_HOME} . "/ApiCommonShared/Model/data/MSTermTab.txt";


GetOptions("propfile=s" => \$propfile,
           "instance=s" => \$instance,
           "schema=s" => \$schema,
           "password=s" => \$password,
           "suffix=s" => \$suffix,
           "subversionDir=s" => \$subversionDir,
           "debug!" => \$debug,
           "help|h" => \$help,
           "project=s" => \$project,
           "password=s" => \$password,
          );

($instance, $schema, $password) = ApiCommonData::Load::TuningConfig::Utils::getDbLoginInfo($instance, $propfile, $schema, $password);

&run();

sub run{

  
  unless(-e $tabFileLocation) {
    &usage("ERROR:  tabFile $tabFileLocation is not in this directory");
  }
  
  if($help) {
    &usage();
  }

  my $failures = 0;

my $dbh = ApiCommonData::Load::TuningConfig::Utils::getDbHandle($instance, $schema, $password);

  $dbh->{RaiseError} = 1;
  $dbh->{AutoCommit} = 0;
  
  # parse Tab file
  
  my $insertStatement = "INSERT INTO MassSpecTerms$suffix(project_id,
                            experiment,organism,sample,ext_db_name,sort_order) VALUES (?,?,?,?,?,?)";
  my $insertRow = $dbh->prepare($insertStatement);
  createEmptyTable($dbh,$suffix);
  open (FILE, $tabFileLocation);
  while (<FILE>) {
    chomp;
    # skip commets / header
    next if(/^#/);

    (my $project_id, my $experiment, my $organism, my $sample, my $ext_db_name, my $sort_order ) = split("\t");
    if ($ext_db_name) {
      $insertRow->execute($project_id,$experiment,$organism,$sample,$ext_db_name,$sort_order);
    }
  }
  close (FILE);
  $dbh->commit();
  $dbh->disconnect();
}

sub createEmptyTable {
     my ($dbh, $suffix) = @_;

    $dbh->do(<<SQL) or die "creating table";
     create table MassSpecTerms$suffix (
	project_id   varchar2(9),
        experiment   varchar2(255),
	organism     varchar2(255),
	sample       varchar2(129),
	ext_db_name  varchar2(81),
        sort_order   number
  ) nologging
SQL
$dbh->{PrintError} = 0;

}

sub usage {
  my $e = shift;
  if($e) {
    print STDERR $e . "\n";
  }
  print STDERR "usage:  createMassSpecTerms.pl --databaseInstance <instance> --userName <userName> --password <password>";
  exit;
}

1;
