#!/usr/bin/perl

use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use WDK::Model::CommandHelper;
use IO::File;
use Cwd;

use ApiCommonWebsite::Model::ModelConfig;
use Bio::SeqIO;
use Bio::Seq;

use Getopt::Long;
use DBI;
use DBD::Oracle;

use lib $ENV{CGILIB};

my $CGIBIN = $ENV{CGIBIN};
my $GUS_HOME = $ENV{GUS_HOME};

my $CLASSPATH = &WDK::Model::CommandHelper::getJavaClasspath($GUS_HOME);
my $sysProps = &WDK::Model::CommandHelper::getSystemProps($GUS_HOME, 'createGenBankFiles');
my $args = &WDK::Model::CommandHelper::getJavaArgs(@ARGV);
my $tempFileName = "genbank.tmp";
my $reporter = "genbank";
my $baseDir;
my $model;

my @sequences;

# get the model and dir (will pass other params directly)
&GetOptions('dir=s' => \$baseDir,
            'model=s' => \$model,
            'question=s', 'params=s'
            );

$baseDir = &Cwd::abs_path() unless($baseDir);

my $modelConfig = ApiCommonWebsite::Model::ModelConfig->new($model);


my $dbh = DBI->connect( $modelConfig->getDbiDsn(),
                        $modelConfig->getLogin(),
                        $modelConfig->getPassword()
                      )
  || die "unable to open db handle to ", $modelConfig->getDbiDsn();

# solve oracle clob problem; not that we're liable to need it...
$dbh->{LongTruncOk} = 0;
$dbh->{LongReadLen} = 10000000;


my $sequenceIdToGenbankFile = &lookupOriginalGenbankFiles($dbh);

# write tbl files
my $cmd = "java $sysProps -classpath $CLASSPATH org.gusdb.wdk.model.report.Dumper -reporter $reporter -fileName $tempFileName $args";
system($cmd);


opendir(DIR, $baseDir) or die "Cannot open directory $baseDir for reading: $!";

while (my $tblFile = readdir(DIR)) { 
  next unless $tblFile =~ /$tempFileName/;


  open(TBL, $tblFile) or die "Cannot open file $tblFile for reading: $!";

  my $defline = <TBL>;
  chomp $defline;
  my ($junk, $sequenceId) = split(/\t/, $defline);


  close TBL;

  my $newTblFile = $sequenceId . ".tbl";
  my $fasta = $sequenceId . ".fsa";

  rename($tblFile, $newTblFile);


  my $gbFile = $sequenceIdToGenbankFile->{$sequenceId};

  my $seqio  = Bio::SeqIO->new(-file => $gbFile , '-format' => 'genbank');

  my $seqioFsa = Bio::SeqIO->new(-format => 'Fasta', -file => "> $fasta");

  while(my $seq = $seqio->next_seq()) {
    next unless($seq->id eq $sequenceId);

    $seqioFsa->write_seq($seq);
  }
}

close DIR;


# Run tbl2asn with validation flag
$cmd = "tbl2asn -p $baseDir -t $baseDir/template.sbt -V v";
system($cmd);


$dbh->disconnect();


sub lookupOriginalGenbankFiles {
  my ($dbh) = @_;

  my %rv;

  my $sql = "select distinct ga.sequence_id, ap.string_value
from core.algorithmparam ap, core.algorithmparamkey apk,
     ApidbTuning.GeneAttributes ga, dots.genefeature gf
where apk.algorithm_param_key = 'inputFileOrDir'
and ap.algorithm_param_key_id = apk.algorithm_param_key_id
and ga.na_feature_id = gf.na_feature_id
and gf.row_alg_invocation_id = ap.algorithm_invocation_id";

  my $sh = $dbh->prepare($sql);
  $sh->execute();

  while(my ($sequence, $file) = $sh->fetchrow_array()) {
    $file =~ s/^\/files\/cbil\/data\/cbil/\/eupath\/data/;
    $rv{$sequence} = $file;


  }

  $sh->finish();

  return \%rv;
}


1;
